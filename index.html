<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spansk p√• 1-2-3 | L√¶ringsapp</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            min-height: 100vh;
            padding: 16px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Login Screen */
        .login-screen {
            max-width: 400px;
            margin: 60px auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            text-align: center;
        }

        .login-logo {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: var(--gray-500);
            margin-bottom: 32px;
        }

        .login-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 18px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 12px;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .login-input-small {
            font-size: 16px;
            text-transform: none;
            letter-spacing: normal;
            margin-bottom: 20px;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
        }

        .login-btn-primary {
            background: var(--primary);
            color: white;
        }

        .login-btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .login-btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .login-btn-secondary:hover {
            background: var(--gray-200);
        }

        .login-divider {
            display: flex;
            align-items: center;
            margin: 24px 0;
            color: var(--gray-500);
            font-size: 14px;
        }

        .login-divider::before,
        .login-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--gray-200);
        }

        .login-divider::before { margin-right: 16px; }
        .login-divider::after { margin-left: 16px; }

        .login-error {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .login-success {
            background: #dcfce7;
            color: #166534;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .login-hint {
            font-size: 13px;
            color: var(--gray-500);
            margin-top: 20px;
        }

        /* Role selector */
        .role-selector {
            display: flex;
            gap: 12px;
            margin: 16px 0;
        }

        .role-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .role-btn:hover {
            border-color: var(--primary);
        }

        .role-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        #classCodeSection {
            margin-bottom: 16px;
        }

        /* Teacher Dashboard */
        .teacher-nav {
            background: linear-gradient(135deg, #7c3aed 0%, #6366f1 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .dashboard-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .class-code-display {
            background: var(--gray-100);
            padding: 12px 20px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .dashboard-stat {
            background: var(--gray-50);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .dashboard-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
        }

        .dashboard-stat-label {
            font-size: 13px;
            color: var(--gray-500);
            margin-top: 4px;
        }

        .students-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 24px;
        }

        .students-table th,
        .students-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .students-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            font-size: 13px;
        }

        .students-table tr:hover {
            background: var(--gray-50);
        }

        .progress-mini {
            width: 60px;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        .progress-mini-fill {
            height: 100%;
            background: var(--success);
            border-radius: 4px;
        }

        .activity-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .activity-badge.recent {
            background: #dcfce7;
            color: #166534;
        }

        .activity-badge.old {
            background: #fef3c7;
            color: #92400e;
        }

        .activity-badge.inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .push-words-section {
            background: var(--gray-50);
            padding: 24px;
            border-radius: 12px;
            margin-top: 24px;
        }

        .push-words-section h3 {
            margin-bottom: 16px;
            color: var(--gray-900);
        }

        .push-word-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .push-word-input {
            flex: 1;
            min-width: 120px;
            padding: 10px 14px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
        }

        .push-word-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .pending-words-list {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 12px;
            margin: 16px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .pending-word-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--gray-100);
        }

        .pending-word-item:last-child {
            border-bottom: none;
        }

        .pending-word-remove {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 16px;
        }

        .no-class-message {
            text-align: center;
            padding: 40px;
            color: var(--gray-500);
        }

        .create-class-form {
            max-width: 400px;
            margin: 20px auto;
        }

        .create-class-form input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .create-class-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* User info in navbar */
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--gray-100);
            border-radius: 10px;
            font-size: 14px;
        }

        .user-code {
            font-weight: 700;
            color: var(--primary);
        }

        .user-name {
            color: var(--gray-700);
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--gray-500);
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
        }

        .logout-btn:hover {
            color: var(--danger);
        }

        .sync-status {
            font-size: 11px;
            color: var(--gray-500);
        }

        .sync-status.syncing {
            color: var(--warning);
        }

        .sync-status.synced {
            color: var(--success);
        }

        .sync-status.offline {
            color: var(--gray-500);
        }

        .class-badge {
            background: linear-gradient(135deg, #7c3aed 0%, #6366f1 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Navigation */
        .nav-bar {
            background: white;
            padding: 16px 24px;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .nav-brand {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-links {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .nav-link {
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .nav-link:hover {
            background: var(--gray-200);
        }

        .nav-link.active {
            background: var(--primary);
            color: white;
        }

        /* Panels */
        .panel {
            background: white;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        .hidden { display: none !important; }

        /* Page Headers */
        .page-header {
            margin-bottom: 24px;
        }

        .page-header h2 {
            font-size: 24px;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .page-header p {
            color: var(--gray-500);
            font-size: 15px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: var(--gray-50);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 4px;
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 24px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--gray-500);
            margin-bottom: 6px;
        }

        .progress-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            display: flex;
        }

        .progress-segment {
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-mastered { background: var(--success); }
        .progress-learning { background: var(--warning); }
        .progress-new { background: var(--gray-300); }

        /* Settings Section */
        .settings-section {
            margin-bottom: 28px;
        }

        .settings-section h3 {
            color: var(--gray-700);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-label {
            color: var(--gray-700);
            font-size: 15px;
        }

        .setting-hint {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 2px;
        }

        input[type="number"], select {
            padding: 10px 14px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 15px;
            width: 100px;
            text-align: center;
        }

        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }

        select {
            width: auto;
            min-width: 150px;
        }

        /* Category Grid */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 12px;
        }

        .category-chip {
            padding: 10px 14px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            background: white;
        }

        .category-chip:hover {
            border-color: var(--primary);
            background: var(--gray-50);
        }

        .category-chip.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .category-chip .count {
            font-size: 11px;
            opacity: 0.7;
            margin-left: 4px;
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--gray-300);
            color: var(--gray-700);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 24px;
        }

        /* Study Header */
        .study-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .session-progress {
            flex: 1;
            margin: 0 20px;
        }

        .session-progress-bar {
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
        }

        .session-progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .session-stats {
            font-size: 13px;
            color: var(--gray-500);
            margin-top: 6px;
            text-align: center;
        }

        .card-counter {
            font-size: 14px;
            color: var(--gray-500);
            font-weight: 600;
        }

        /* Flashcard */
        .flashcard {
            width: 100%;
            min-height: 280px;
            background: var(--gray-50);
            border-radius: 16px;
            padding: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 3px solid var(--gray-200);
            position: relative;
            margin: 20px 0;
        }

        .flashcard:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.1);
        }

        .card-type-badge {
            position: absolute;
            top: 16px;
            left: 16px;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
        }

        .badge-new {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .badge-review {
            background: #fef3c7;
            color: #b45309;
        }

        .direction-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--gray-200);
            color: var(--gray-700);
            font-weight: 600;
        }

        .card-category {
            position: absolute;
            bottom: 16px;
            left: 16px;
            font-size: 11px;
            color: var(--gray-500);
        }

        .card-word {
            font-size: 32px;
            font-weight: 600;
            color: var(--gray-900);
            text-align: center;
        }

        .card-hint {
            font-size: 14px;
            color: var(--gray-500);
            margin-top: 20px;
        }

        .card-answer {
            font-size: 32px;
            font-weight: 600;
            color: var(--primary);
            text-align: center;
        }

        /* Rating Buttons */
        .rating-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 24px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .rating-btn {
            padding: 16px 12px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .rating-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .rating-btn .interval {
            font-size: 12px;
            opacity: 0.9;
        }

        .rating-btn .key {
            font-size: 11px;
            opacity: 0.7;
        }

        .rating-again { background: var(--danger); color: white; }
        .rating-good { background: var(--success); color: white; }

        .accent-hint {
            font-size: 11px;
            color: var(--gray-500);
            text-align: center;
            margin-top: 8px;
        }

        /* ==================== */
        /* GRAMMAR MODE */
        /* ==================== */

        .grammar-topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .grammar-topic-card {
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .grammar-topic-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .grammar-topic-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .grammar-topic-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .grammar-topic-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 6px;
        }

        .grammar-topic-desc {
            font-size: 13px;
            color: var(--gray-500);
            margin-bottom: 12px;
        }

        .grammar-topic-progress {
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
        }

        .grammar-topic-progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s;
        }

        .grammar-topic-stats {
            font-size: 11px;
            color: var(--gray-500);
            margin-top: 6px;
        }

        .grammar-mastery-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 18px;
        }

        /* Theory card */
        .theory-card {
            background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
            border: 2px solid #93c5fd;
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
        }

        .theory-card h3 {
            color: #1e40af;
            font-size: 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theory-card p {
            color: #1e3a8a;
            line-height: 1.7;
            margin-bottom: 12px;
        }

        .theory-card ul {
            color: #1e3a8a;
            margin-left: 20px;
            line-height: 1.8;
        }

        .theory-card .example {
            background: white;
            border-radius: 8px;
            padding: 12px 16px;
            margin: 12px 0;
            font-family: monospace;
            font-size: 15px;
        }

        .theory-card .example .correct {
            color: var(--success);
            font-weight: 700;
        }

        .theory-card .rule {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 12px 16px;
            margin: 12px 0;
            border-radius: 0 8px 8px 0;
        }

        .theory-card .exception {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 12px 16px;
            margin: 12px 0;
            border-radius: 0 8px 8px 0;
        }

        /* Grammar exercise */
        .grammar-exercise {
            background: var(--gray-50);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
        }

        .grammar-sentence {
            font-size: 24px;
            color: var(--gray-900);
            margin-bottom: 28px;
            line-height: 1.5;
        }

        .grammar-sentence .blank {
            display: inline-block;
            min-width: 80px;
            border-bottom: 3px solid var(--primary);
            margin: 0 4px;
            color: transparent;
        }

        .grammar-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .grammar-option {
            padding: 14px 28px;
            border: 2px solid var(--gray-300);
            border-radius: 10px;
            background: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 100px;
        }

        .grammar-option:hover {
            border-color: var(--primary);
            background: var(--gray-50);
        }

        .grammar-option.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .grammar-option.correct {
            border-color: var(--success);
            background: var(--success);
            color: white;
        }

        .grammar-option.incorrect {
            border-color: var(--danger);
            background: var(--danger);
            color: white;
        }

        .grammar-option.disabled {
            pointer-events: none;
            opacity: 0.6;
        }

        .grammar-feedback {
            min-height: 60px;
            padding: 16px;
            border-radius: 12px;
            margin-top: 20px;
            font-size: 16px;
        }

        .grammar-feedback.correct {
            background: #dcfce7;
            color: #166534;
        }

        .grammar-feedback.incorrect {
            background: #fee2e2;
            color: #991b1b;
        }

        .grammar-feedback .explanation {
            font-size: 14px;
            margin-top: 8px;
            opacity: 0.9;
        }

        .grammar-hint-btn {
            background: none;
            border: none;
            color: var(--gray-500);
            font-size: 14px;
            cursor: pointer;
            margin-top: 12px;
        }

        .grammar-hint-btn:hover {
            color: var(--primary);
        }

        /* Add Word Form */
        .add-word-form {
            background: var(--gray-50);
            padding: 16px;
            border-radius: 12px;
            margin-top: 12px;
        }

        .add-word-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .add-word-input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
        }

        .add-word-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .add-word-select {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .add-word-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gray-900);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            animation: toastIn 0.3s ease;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* Session Complete */
        .session-complete {
            text-align: center;
            padding: 40px 20px;
        }

        .session-complete h2 {
            font-size: 28px;
            color: var(--gray-900);
            margin-bottom: 16px;
        }

        .session-complete .emoji {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .session-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin: 32px 0;
        }

        .session-stat {
            background: var(--gray-50);
            padding: 20px;
            border-radius: 12px;
        }

        .session-stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .session-stat-label {
            font-size: 13px;
            color: var(--gray-500);
            margin-top: 4px;
        }

        /* Brainmap */
        .brainmap-level {
            margin-bottom: 32px;
        }

        .brainmap-level-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .brainmap-level-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .brainmap-categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }

        .brainmap-category {
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .brainmap-category:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .brainmap-category-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .brainmap-category-progress {
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .brainmap-category-progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s;
        }

        .brainmap-category-stats {
            font-size: 12px;
            color: var(--gray-500);
        }

        /* ==================== */
        /* VERB CONJUGATION MODE */
        /* ==================== */

        .verb-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .verb-card {
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .verb-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .verb-card.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .verb-card.selected .verb-translation {
            color: rgba(255,255,255,0.8);
        }

        .verb-infinitive {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .verb-translation {
            font-size: 13px;
            color: var(--gray-500);
        }

        .verb-type-badge {
            display: inline-block;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--gray-200);
            color: var(--gray-700);
            margin-top: 8px;
        }

        .verb-card.selected .verb-type-badge {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* Conjugation Exercise */
        .conjugation-exercise {
            background: var(--gray-50);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
        }

        .conjugation-verb {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .conjugation-translation {
            font-size: 16px;
            color: var(--gray-500);
            margin-bottom: 24px;
        }

        .conjugation-tense {
            display: inline-block;
            padding: 6px 16px;
            background: var(--warning);
            color: white;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .conjugation-prompt {
            font-size: 24px;
            color: var(--gray-900);
            margin-bottom: 20px;
        }

        .conjugation-prompt .pronoun {
            color: var(--primary);
            font-weight: 700;
        }

        .conjugation-input-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .conjugation-input {
            font-size: 24px;
            padding: 16px 24px;
            border: 3px solid var(--gray-300);
            border-radius: 12px;
            text-align: center;
            width: 300px;
            max-width: 100%;
        }

        .conjugation-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .conjugation-input.correct {
            border-color: var(--success);
            background: #dcfce7;
        }

        .conjugation-input.incorrect {
            border-color: var(--danger);
            background: #fee2e2;
        }

        .conjugation-feedback {
            font-size: 18px;
            margin-bottom: 20px;
            min-height: 30px;
        }

        .conjugation-feedback.correct {
            color: var(--success);
        }

        .conjugation-feedback.incorrect {
            color: var(--danger);
        }

        .conjugation-table {
            margin-top: 24px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
        }

        .conjugation-table h4 {
            margin-bottom: 16px;
            color: var(--gray-700);
        }

        .conjugation-table-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .conjugation-table-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--gray-50);
            border-radius: 6px;
        }

        .conjugation-table-row .pronoun {
            color: var(--gray-500);
        }

        .conjugation-table-row .form {
            font-weight: 600;
            color: var(--gray-900);
        }

        .conjugation-table-row.highlight {
            background: #dbeafe;
        }

        .conjugation-table-row.highlight .form {
            color: var(--primary);
        }

        /* Tense Selector */
        .tense-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .tense-btn {
            padding: 10px 20px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tense-btn:hover {
            border-color: var(--primary);
        }

        .tense-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .rating-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            .session-stats-grid {
                grid-template-columns: 1fr;
            }

            .card-word, .card-answer {
                font-size: 24px;
            }

            .conjugation-table-grid {
                grid-template-columns: 1fr;
            }

            .nav-brand {
                width: 100%;
                justify-content: center;
            }

            .nav-links {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .panel {
                padding: 16px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .conjugation-input {
                width: 100%;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-logo">üá™üá∏</div>
        <h1 class="login-title">Spansk p√• 1-2-3</h1>
        <p class="login-subtitle">Logg inn for √• lagre fremgangen din</p>
        
        <div id="loginError" class="login-error hidden"></div>
        <div id="loginSuccess" class="login-success hidden"></div>
        
        <div id="loginForm">
            <input type="text" id="codeInput" class="login-input" placeholder="DIN KODE" maxlength="20">
            <button class="login-btn login-btn-primary" onclick="loginWithCode()">üîë Logg inn</button>
            
            <div class="login-divider">eller lag ny bruker</div>
            
            <input type="text" id="newNameInput" class="login-input login-input-small" placeholder="Ditt navn (f.eks. Maria)">
            
            <div class="role-selector">
                <button class="role-btn active" onclick="selectRole('student')" id="roleStudent">üë®‚Äçüéì Elev</button>
                <button class="role-btn" onclick="selectRole('teacher')" id="roleTeacher">üë©‚Äçüè´ L√¶rer</button>
            </div>
            
            <div id="classCodeSection">
                <input type="text" id="joinClassCode" class="login-input login-input-small" placeholder="Klassekode (valgfritt, f.eks. 7B-SPA)">
                <p class="login-hint" style="margin-top: 4px;">Har l√¶reren gitt deg en klassekode? Skriv den inn her.</p>
            </div>
            
            <button class="login-btn login-btn-secondary" onclick="createNewCode()">‚ú® Lag ny bruker</button>
            
            <p class="login-hint">
                üí° F√∏rste gang? Skriv navnet ditt og klikk "Lag ny bruker".
            </p>
        </div>
        
        <div id="offlineMode" class="hidden">
            <button class="login-btn login-btn-secondary" onclick="continueOffline()">üì¥ Fortsett uten innlogging</button>
            <p class="login-hint">
                Fremgang lagres kun p√• denne enheten.
            </p>
        </div>
    </div>

    <div class="container hidden" id="mainApp">
        <!-- Navigation Bar -->
        <nav class="nav-bar">
            <div class="nav-brand">
                üá™üá∏ Spansk p√• 1-2-3
            </div>
            <div class="nav-links">
                <button class="nav-link active" onclick="showPage('vocab')" id="navVocab">üìö Gloser</button>
                <button class="nav-link" onclick="showPage('brainmap')" id="navBrainmap">üß† Brainmap</button>
                <button class="nav-link" onclick="showPage('verbs')" id="navVerbs">üèÉ Verb</button>
                <button class="nav-link" onclick="showPage('grammar')" id="navGrammar">üìñ Grammatikk</button>
                <button class="nav-link hidden" onclick="showPage('dashboard')" id="navDashboard">
                    <span class="teacher-nav">üë©‚Äçüè´ Dashboard</span>
                </button>
            </div>
            <div class="user-info" id="userInfo">
                <span class="user-code" id="userCode"></span>
                <span class="user-name" id="userName"></span>
                <span class="class-badge hidden" id="classCodeBadge"></span>
                <span class="sync-status" id="syncStatus">‚óè</span>
                <button class="logout-btn" onclick="logout()" title="Logg ut">üö™</button>
            </div>
        </nav>

        <!-- ==================== -->
        <!-- VOCABULARY PAGE -->
        <!-- ==================== -->
        <div id="vocabPage" class="panel">
            <!-- Settings View -->
            <div id="vocabSettings">
                <div class="page-header">
                    <h2>üìö Glosel√¶ring</h2>
                    <p>L√¶r ordforr√•d med spaced repetition - begge veier!</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-number" id="statTotal">0</div>
                        <div class="stat-label">Totalt</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="statNew">0</div>
                        <div class="stat-label">Nye</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="statDue">0</div>
                        <div class="stat-label">Til repetisjon</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="statMastered">0</div>
                        <div class="stat-label">Mestret</div>
                    </div>
                </div>

                <div class="progress-container">
                    <div class="progress-label">
                        <span>Fremgang</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-segment progress-mastered" id="progressMastered"></div>
                        <div class="progress-segment progress-learning" id="progressLearning"></div>
                        <div class="progress-segment progress-new" id="progressNew"></div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>‚öôÔ∏è √òktinnstillinger</h3>
                    <div class="setting-row">
                        <div>
                            <div class="setting-label">Nye kort</div>
                            <div class="setting-hint">Antall nye ord per √∏kt</div>
                        </div>
                        <input type="number" id="newCardsLimit" min="0" max="50" value="10">
                    </div>
                    <div class="setting-row">
                        <div>
                            <div class="setting-label">Repetisjonskort</div>
                            <div class="setting-hint">Maks antall repetisjoner per √∏kt</div>
                        </div>
                        <input type="number" id="reviewCardsLimit" min="0" max="200" value="50">
                    </div>
                </div>

                <div class="settings-section">
                    <h3>üìö Velg kategorier</h3>
                    <div class="setting-row">
                        <button class="btn btn-sm btn-outline" onclick="selectAllCategories()">Velg alle</button>
                        <button class="btn btn-sm btn-outline" onclick="deselectAllCategories()">Fjern alle</button>
                    </div>
                    <div id="categoryGrid" class="category-grid"></div>
                </div>

                <div class="settings-section">
                    <h3>‚ûï Legg til gloser</h3>
                    <div class="add-word-form">
                        <div class="add-word-row">
                            <input type="text" id="addWordNorsk" placeholder="Norsk" class="add-word-input">
                            <input type="text" id="addWordSpansk" placeholder="Spansk" class="add-word-input">
                        </div>
                        <div class="add-word-row">
                            <select id="addWordCategory" class="add-word-select">
                                <option value="">Velg kategori...</option>
                            </select>
                            <input type="text" id="addWordNewCategory" placeholder="...eller ny kategori" class="add-word-input">
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="addCustomWord()">‚ûï Legg til glose</button>
                    </div>
                    <div class="setting-row" style="margin-top: 16px;">
                        <div>
                            <div class="setting-label">Importer fra l√¶rer</div>
                            <div class="setting-hint">Last inn JSON-fil med nye gloser</div>
                        </div>
                        <button class="btn btn-sm btn-outline" onclick="importTeacherWords()">üì• Importer gloser</button>
                    </div>
                    <div id="customWordsCount" class="setting-hint" style="margin-top: 8px;"></div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="startVocabSession()">‚ñ∂Ô∏è Start √∏kt</button>
                    <button class="btn btn-secondary" onclick="showStatistics()">üìä Statistikk</button>
                    <button class="btn btn-secondary" onclick="exportProgress()">üíæ Eksporter</button>
                    <button class="btn btn-secondary" onclick="importProgress()">üìÇ Importer</button>
                </div>
            </div>

            <!-- Study View -->
            <div id="vocabStudy" class="hidden">
                <div class="study-header">
                    <button class="btn btn-outline btn-sm" onclick="endVocabSessionEarly()">‚úï Avslutt</button>
                    <div class="session-progress">
                        <div class="session-progress-bar">
                            <div class="session-progress-fill" id="sessionProgressFill"></div>
                        </div>
                        <div class="session-stats" id="sessionStats">0 / 0 kort</div>
                    </div>
                    <div class="card-counter" id="cardCounter">1 / 10</div>
                </div>
                <div id="flashcardArea"></div>
                <div id="buttonArea"></div>
            </div>
        </div>

        <!-- ==================== -->
        <!-- BRAINMAP PAGE -->
        <!-- ==================== -->
        <div id="brainmapPage" class="panel hidden">
            <div class="page-header">
                <h2>üß† Brainmap</h2>
                <p>Se fremgangen din og velg kategorier √• √∏ve p√•</p>
            </div>
            <div id="brainmapContent"></div>
        </div>

        <!-- ==================== -->
        <!-- VERB PAGE -->
        <!-- ==================== -->
        <div id="verbPage" class="panel hidden">
            <!-- Verb Settings View -->
            <div id="verbSettings">
                <div class="page-header">
                    <h2>üèÉ Verbb√∏ying</h2>
                    <p>√òv p√• √• b√∏ye verb i presens, fremtid og presens perfektum</p>
                </div>

                <div class="settings-section">
                    <h3>üìù Velg verbtid</h3>
                    <div class="tense-selector">
                        <button class="tense-btn active" onclick="selectTense('presente')" id="tensePresente">Presens</button>
                        <button class="tense-btn" onclick="selectTense('futuro')" id="tenseFuturo">Fremtid (ir a)</button>
                        <button class="tense-btn" onclick="selectTense('perfecto')" id="tensePerfecto">Presens perfektum</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>üî§ Velg verb √• √∏ve p√•</h3>
                    <div class="setting-row">
                        <button class="btn btn-sm btn-outline" onclick="selectAllVerbs()">Velg alle</button>
                        <button class="btn btn-sm btn-outline" onclick="deselectAllVerbs()">Fjern alle</button>
                    </div>
                    <div id="verbSelector" class="verb-selector"></div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="startVerbSession()">‚ñ∂Ô∏è Start √∏ving</button>
                </div>
            </div>

            <!-- Verb Exercise View -->
            <div id="verbExercise" class="hidden">
                <div class="study-header">
                    <button class="btn btn-outline btn-sm" onclick="endVerbSession()">‚úï Avslutt</button>
                    <div class="session-progress">
                        <div class="session-progress-bar">
                            <div class="session-progress-fill" id="verbProgressFill"></div>
                        </div>
                        <div class="session-stats" id="verbSessionStats">0 / 0 riktig</div>
                    </div>
                    <div class="card-counter" id="verbCounter">1 / 10</div>
                </div>
                <div id="verbExerciseArea"></div>
            </div>
        </div>

        <!-- ==================== -->
        <!-- GRAMMAR PAGE -->
        <!-- ==================== -->
        <div id="grammarPage" class="panel hidden">
            <!-- Grammar Topic Selection -->
            <div id="grammarSettings">
                <div class="page-header">
                    <h2>üìñ Grammatikk</h2>
                    <p>L√¶r grammatikkregler med adaptive √∏velser</p>
                </div>

                <div class="grammar-topic-grid" id="grammarTopicGrid">
                    <!-- Topics populated by JS -->
                </div>
            </div>

            <!-- Grammar Exercise View -->
            <div id="grammarExercise" class="hidden">
                <div class="study-header">
                    <button class="btn btn-outline btn-sm" onclick="endGrammarSession()">‚úï Avslutt</button>
                    <div class="session-progress">
                        <div class="session-progress-bar">
                            <div class="session-progress-fill" id="grammarProgressFill"></div>
                        </div>
                        <div class="session-stats" id="grammarSessionStats">0 / 0 riktig</div>
                    </div>
                    <div class="card-counter" id="grammarCounter">1 / 10</div>
                </div>
                <div id="grammarTheoryArea"></div>
                <div id="grammarExerciseArea"></div>
            </div>
        </div>

        <!-- ==================== -->
        <!-- TEACHER DASHBOARD -->
        <!-- ==================== -->
        <div id="dashboardPage" class="panel hidden">
            <!-- No class view -->
            <div id="noClassView">
                <div class="no-class-message">
                    <h2>üë©‚Äçüè´ L√¶rer-dashboard</h2>
                    <p>Du har ikke opprettet noen klasse enn√•.</p>
                    
                    <div class="create-class-form">
                        <input type="text" id="newClassName" placeholder="Klassenavn (f.eks. Spansk 7B)">
                        <button class="btn btn-primary" onclick="createClass()">‚ûï Opprett klasse</button>
                    </div>
                </div>
            </div>

            <!-- Class dashboard view -->
            <div id="classDashboardView" class="hidden">
                <div class="dashboard-header">
                    <div>
                        <h2 class="dashboard-title" id="dashboardClassName">Min klasse</h2>
                        <p style="color: var(--gray-500); margin-top: 4px;">Del denne koden med elevene dine</p>
                    </div>
                    <div class="class-code-display" id="dashboardClassCode">ABC123</div>
                </div>

                <div class="dashboard-stats">
                    <div class="dashboard-stat">
                        <div class="dashboard-stat-value" id="dashStatStudents">0</div>
                        <div class="dashboard-stat-label">Elever</div>
                    </div>
                    <div class="dashboard-stat">
                        <div class="dashboard-stat-value" id="dashStatAvgVocab">0%</div>
                        <div class="dashboard-stat-label">Snitt gloser</div>
                    </div>
                    <div class="dashboard-stat">
                        <div class="dashboard-stat-value" id="dashStatAvgGrammar">0%</div>
                        <div class="dashboard-stat-label">Snitt grammatikk</div>
                    </div>
                    <div class="dashboard-stat">
                        <div class="dashboard-stat-value" id="dashStatActive">0</div>
                        <div class="dashboard-stat-label">Aktive i dag</div>
                    </div>
                </div>

                <h3 style="margin-bottom: 16px;">üë®‚Äçüéì Elevoversikt</h3>
                <div style="overflow-x: auto;">
                    <table class="students-table">
                        <thead>
                            <tr>
                                <th>Navn</th>
                                <th>Kode</th>
                                <th>Gloser</th>
                                <th>Grammatikk</th>
                                <th>Sist aktiv</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; color: var(--gray-500);">
                                    Ingen elever har blitt med enn√•
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="push-words-section">
                    <h3>üì§ Send gloser til klassen</h3>
                    <p style="color: var(--gray-500); margin-bottom: 16px;">
                        Legg til gloser som automatisk synkroniseres til alle elevene i klassen.
                    </p>
                    
                    <div class="push-word-row">
                        <input type="text" id="pushCategory" class="push-word-input" placeholder="Kategori (f.eks. kapittel-6)">
                    </div>
                    <div class="push-word-row">
                        <input type="text" id="pushNorsk" class="push-word-input" placeholder="Norsk">
                        <input type="text" id="pushSpansk" class="push-word-input" placeholder="Spansk">
                        <button class="btn btn-sm btn-outline" onclick="addWordToPushList()">+ Legg til</button>
                    </div>

                    <div class="pending-words-list" id="pendingWordsList">
                        <p style="color: var(--gray-500); text-align: center;">Ingen gloser lagt til enn√•</p>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-primary" onclick="pushWordsToClass()">üì§ Send til alle elever</button>
                        <button class="btn btn-secondary" onclick="importAndPushWords()">üìÇ Importer fra fil</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SUPABASE SETUP (using direct fetch)
        // ============================================
        
        const SUPABASE_URL = 'https://ncrxkjkgcbiugwhmyrds.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5jcnhramtnY2JpdWd3aG15cmRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1NTA0ODQsImV4cCI6MjA4NDEyNjQ4NH0.jOQOuG3og2XMgroLZsbMayGUBncZGSnM1_bOBTr-4cc';
        
        const supabaseHeaders = {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
        };
        
        let currentUser = null;
        let isOfflineMode = false;
        let syncTimeout = null;
        let selectedRole = 'student';
        let currentClass = null;
        let pendingPushWords = [];

        // ============================================
        // LOGIN/REGISTRATION FUNCTIONS
        // ============================================

        function generateCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function selectRole(role) {
            selectedRole = role;
            document.getElementById('roleStudent').classList.toggle('active', role === 'student');
            document.getElementById('roleTeacher').classList.toggle('active', role === 'teacher');
            document.getElementById('classCodeSection').classList.toggle('hidden', role === 'teacher');
        }

        async function createNewCode() {
            const nameInput = document.getElementById('newNameInput');
            const name = nameInput.value.trim();
            
            if (!name) {
                showLoginError('Skriv inn navnet ditt f√∏rst!');
                return;
            }
            
            const code = generateCode();
            const isTeacher = selectedRole === 'teacher';
            const joinClassCode = document.getElementById('joinClassCode')?.value.trim().toUpperCase() || '';
            
            try {
                // Create user
                const response = await fetch(`${SUPABASE_URL}/rest/v1/user_progress`, {
                    method: 'POST',
                    headers: supabaseHeaders,
                    body: JSON.stringify({ 
                        code: code, 
                        display_name: name,
                        is_teacher: isTeacher,
                        vocab_data: {},
                        grammar_data: {},
                        verb_data: {}
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Supabase error:', errorData);
                    showLoginError(`Feil: ${errorData.message || errorData.code || response.statusText}`);
                    return;
                }
                
                // If student wants to join a class
                if (!isTeacher && joinClassCode) {
                    await joinClass(code, joinClassCode);
                }
                
                const roleText = isTeacher ? 'üë©‚Äçüè´ L√¶rer' : 'üë®‚Äçüéì Elev';
                showLoginSuccess(`${roleText}-kode: <strong>${code}</strong><br>Husk denne koden!`);
                
                // Auto-login after 2 seconds
                setTimeout(() => {
                    document.getElementById('codeInput').value = code;
                    loginWithCode();
                }, 2500);
                
            } catch (error) {
                console.error('Error creating user:', error);
                if (error.message === 'Failed to fetch') {
                    showLoginError('Kunne ikke koble til server. Sjekk nettverket eller bruk offline-modus.');
                } else {
                    showLoginError(`Nettverksfeil: ${error.message || 'Kunne ikke koble til server'}`);
                }
            }
        }

        async function joinClass(studentCode, classCode) {
            try {
                // Find the class
                const classResponse = await fetch(
                    `${SUPABASE_URL}/rest/v1/classes?class_code=eq.${encodeURIComponent(classCode)}&select=id`,
                    { headers: supabaseHeaders }
                );
                
                if (!classResponse.ok) return;
                
                const classes = await classResponse.json();
                if (!classes || classes.length === 0) {
                    console.log('Class not found:', classCode);
                    return;
                }
                
                const classId = classes[0].id;
                
                // Join the class
                await fetch(`${SUPABASE_URL}/rest/v1/class_members`, {
                    method: 'POST',
                    headers: supabaseHeaders,
                    body: JSON.stringify({
                        class_id: classId,
                        student_code: studentCode
                    })
                });
                
                console.log('Joined class:', classCode);
                
            } catch (error) {
                console.error('Error joining class:', error);
            }
        }

        async function loginWithCode() {
            const codeInput = document.getElementById('codeInput');
            const code = codeInput.value.trim().toUpperCase();
            
            if (!code) {
                showLoginError('Skriv inn koden din!');
                return;
            }
            
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/user_progress?code=eq.${encodeURIComponent(code)}&select=*`,
                    { headers: supabaseHeaders }
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data || data.length === 0) {
                    showLoginError('Koden finnes ikke. Sjekk at du skrev riktig, eller lag ny bruker.');
                    return;
                }
                
                // Success - login user
                currentUser = data[0];
                isOfflineMode = false;
                localStorage.setItem('spansk123_userCode', code);
                
                // Load data from server
                await loadFromServer();
                
                // Show main app
                showMainApp();
                
            } catch (error) {
                console.error('Login error:', error);
                if (error.message === 'Failed to fetch') {
                    showLoginError('Kunne ikke koble til server. Sjekk nettverket eller bruk offline-modus.');
                } else {
                    showLoginError('Noe gikk galt. Pr√∏v igjen.');
                }
            }
        }

        function continueOffline() {
            isOfflineMode = true;
            currentUser = { code: 'OFFLINE', display_name: 'Lokal bruker' };
            showMainApp();
        }

        function logout() {
            if (confirm('Er du sikker p√• at du vil logge ut?')) {
                currentUser = null;
                isOfflineMode = false;
                localStorage.removeItem('spansk123_userCode');
                
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('codeInput').value = '';
                document.getElementById('newNameInput').value = '';
                hideLoginMessages();
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Update user info in navbar
            document.getElementById('userCode').textContent = currentUser.code;
            document.getElementById('userName').textContent = currentUser.display_name || '';
            updateSyncStatus('synced');
            
            // Show dashboard button for teachers
            const dashboardBtn = document.getElementById('navDashboard');
            if (currentUser.is_teacher) {
                dashboardBtn.classList.remove('hidden');
            } else {
                dashboardBtn.classList.add('hidden');
            }
            
            // Check for class words (for students)
            if (!currentUser.is_teacher && !isOfflineMode) {
                checkForClassWords();
            }
            
            // Initialize app
            init();
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.innerHTML = message;
            errorDiv.classList.remove('hidden');
            document.getElementById('loginSuccess').classList.add('hidden');
        }

        function showLoginSuccess(message) {
            const successDiv = document.getElementById('loginSuccess');
            successDiv.innerHTML = message;
            successDiv.classList.remove('hidden');
            document.getElementById('loginError').classList.add('hidden');
        }

        function hideLoginMessages() {
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('loginSuccess').classList.add('hidden');
        }

        function updateSyncStatus(status) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.className = 'sync-status ' + status;
            if (status === 'syncing') {
                statusEl.textContent = '‚Üª';
                statusEl.title = 'Synkroniserer...';
            } else if (status === 'synced') {
                statusEl.textContent = '‚úì';
                statusEl.title = 'Synkronisert';
            } else if (status === 'offline') {
                statusEl.textContent = '‚óã';
                statusEl.title = 'Kun lokal lagring';
            }
        }

        // ============================================
        // SYNC FUNCTIONS
        // ============================================

        async function loadFromServer() {
            if (isOfflineMode || !currentUser) return;
            
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/user_progress?code=eq.${encodeURIComponent(currentUser.code)}&select=*`,
                    { headers: supabaseHeaders }
                );
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const userData = data[0];
                    
                    // Merge server data with local data (server wins for conflicts)
                    if (userData.vocab_data && Object.keys(userData.vocab_data).length > 0) {
                        localStorage.setItem('spansk123Data_v4', JSON.stringify(userData.vocab_data));
                    }
                    if (userData.grammar_data && Object.keys(userData.grammar_data).length > 0) {
                        localStorage.setItem('spansk123Grammar_v1', JSON.stringify(userData.grammar_data));
                    }
                    
                    currentUser = userData;
                }
                
            } catch (error) {
                console.error('Error loading from server:', error);
            }
        }

        async function syncToServer() {
            if (isOfflineMode || !currentUser || currentUser.code === 'OFFLINE') {
                updateSyncStatus('offline');
                return;
            }
            
            updateSyncStatus('syncing');
            
            try {
                // Get current local data
                const vocabData = localStorage.getItem('spansk123Data_v4');
                const grammarData = localStorage.getItem('spansk123Grammar_v1');
                
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/user_progress?code=eq.${encodeURIComponent(currentUser.code)}`,
                    {
                        method: 'PATCH',
                        headers: supabaseHeaders,
                        body: JSON.stringify({
                            vocab_data: vocabData ? JSON.parse(vocabData) : {},
                            grammar_data: grammarData ? JSON.parse(grammarData) : {}
                        })
                    }
                );
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                updateSyncStatus('synced');
                
            } catch (error) {
                console.error('Sync error:', error);
                updateSyncStatus('offline');
            }
        }

        // Debounced sync - waits 2 seconds after last change
        function scheduleSyncToServer() {
            if (syncTimeout) clearTimeout(syncTimeout);
            syncTimeout = setTimeout(syncToServer, 2000);
        }

        // ============================================
        // AUTO-LOGIN ON PAGE LOAD
        // ============================================

        async function checkAutoLogin() {
            // Always show offline option immediately
            document.getElementById('offlineMode').classList.remove('hidden');
            
            const savedCode = localStorage.getItem('spansk123_userCode');
            
            if (savedCode) {
                document.getElementById('codeInput').value = savedCode;
                // Try to login, but don't block if it fails
                try {
                    await loginWithCode();
                } catch (e) {
                    console.log('Auto-login failed, continuing offline');
                }
            }
        }

        // Run auto-login check when page loads
        checkAutoLogin();

        // ============================================
        // VOCABULARY DATABASE
        // ============================================
        
        const glossary = [
            // TALL
            ["11", "once", "tall"],
            ["12", "doce", "tall"],
            ["13", "trece", "tall"],
            ["14", "catorce", "tall"],
            ["15", "quince", "tall"],
            ["16", "diecis√©is", "tall"],
            ["17", "diecisiete", "tall"],
            ["18", "dieciocho", "tall"],
            ["19", "diecinueve", "tall"],
            ["20", "veinte", "tall"],
            ["26", "veintis√©is", "tall"],
            ["30", "treinta", "tall"],
            ["39", "treinta y nueve", "tall"],
            ["40", "cuarenta", "tall"],
            ["43", "cuarenta y tres", "tall"],
            ["50", "cincuenta", "tall"],
            ["54", "cincuenta y cuatro", "tall"],
            ["60", "sesenta", "tall"],
            ["62", "sesenta y dos", "tall"],
            ["70", "setenta", "tall"],
            ["78", "setenta y ocho", "tall"],
            ["80", "ochenta", "tall"],
            ["87", "ochenta y siete", "tall"],
            ["90", "noventa", "tall"],
            ["91", "noventa y uno", "tall"],
            ["100", "cien", "tall"],
            ["110", "ciento diez", "tall"],
            ["123", "ciento veintitres", "tall"],
            ["200", "doscientos", "tall"],
            ["245", "dos cientos cuarenta y cinco", "tall"],
            ["300", "trescientos", "tall"],
            ["400", "cuatrocientos", "tall"],
            ["500 p√• spansk", "quinientos", "tall"],
            ["600", "seiscientos", "tall"],
            ["700", "setecientos", "tall"],
            ["800", "ochocientos", "tall"],
            ["900", "novecientos", "tall"],
            ["1000", "mil", "tall"],
            ["870", "ochocientos setenta", "tall"],
            ["1200", "mil doscientos", "tall"],
            ["1589", "mil quinientos ochenta y nueve", "tall"],
            ["2000", "dos mil", "tall"],
            ["4000", "cuatro mil", "tall"],
            ["10 000", "diez mil", "tall"],
            ["1945", "mil novecientos cuarenta y cinco", "tall"],
            ["1996", "mil novecientos noventa y seis", "tall"],
            ["2011", "dos mil once", "tall"],
            ["2019", "dos mil diecinueve", "tall"],
            
            // BURSDAG
            ["Gratulerer med dagen", "¬°Feliz cumplea√±os!", "bursdag"],
            ["N√•r har du bursdag?", "¬øCu√°ndo es tu cumplea√±os?", "bursdag"],
            ["Bursdagen min er 7. juli", "Mi cumplea√±os es el siete de julio", "bursdag"],
            ["N√•r er bursdagen til Marius?", "¬øCu√°ndo es el cumplea√±os de Marius?", "bursdag"],
            ["Bursdagen til Marius er 26. juni", "El cumplea√±os de Marius es el veintiseis de junio", "bursdag"],
            
            // LAND
            ["Norge", "Noruega", "land"],
            ["Sverige", "Suecia", "land"],
            ["Danmark", "Dinamarca", "land"],
            ["Finland", "Finlandia", "land"],
            ["Island", "Islandia", "land"],
            ["Russland p√• spansk", "Rusia", "land"],
            ["Tyskland", "Alemania", "land"],
            ["√òsterrike", "Austria", "land"],
            ["Nederland", "Los Pa√≠ses Bajos", "land"],
            ["Frankrike", "Francia", "land"],
            ["Italia", "Italia", "land"],
            ["Belgia", "B√©lgica", "land"],
            ["Spania", "Espa√±a", "land"],
            ["Portugal", "Portugal", "land"],
            ["England", "Inglaterra", "land"],
            ["Irland", "Irlanda", "land"],
            ["Hellas", "Grecia", "land"],
            ["Sveits (spansk)", "Suiza", "land"],
            
            // FARGER
            ["r√∏d", "rojo", "farger"],
            ["bl√•", "azul", "farger"],
            ["gul", "amarillo", "farger"],
            ["gr√∏nn", "verde", "farger"],
            ["gr√•", "gris", "farger"],
            ["brun", "marr√≥n", "farger"],
            ["hvit", "blanco", "farger"],
            ["svart", "negro", "farger"],
            ["rosa", "rosa", "farger"],
            ["lilla (v)", "violeta", "farger"],
            ["oransje", "naranja", "farger"],
            ["turkis", "turquesa", "farger"],
            
            // V√ÜR
            ["vinter", "el invierno", "v√¶r"],
            ["v√•r", "la primavera", "v√¶r"],
            ["sommer", "el verano", "v√¶r"],
            ["h√∏st", "el oto√±o", "v√¶r"],
            ["det regner", "llueve", "v√¶r"],
            ["det sn√∏r", "nieva", "v√¶r"],
            ["det er klart / skyfritt", "est√° despejado", "v√¶r"],
            ["det er overskyet", "est√° nublado", "v√¶r"],
            ["det er fem varmegrader", "hace cinco grados sobre cero", "v√¶r"],
            ["det er fem kuldegrader", "hace cinco grados bajo cero", "v√¶r"],
            ["det er fint v√¶r", "hace buen tiempo", "v√¶r"],
            ["det er d√•rlig v√¶r", "hace mal tiempo", "v√¶r"],
            ["det er sol", "hace sol", "v√¶r"],
            ["det er vind / det bl√•ser", "hace viento", "v√¶r"],
            ["det er varmt", "hace calor", "v√¶r"],
            ["det er kaldt", "hace fr√≠o", "v√¶r"],
            
            // H√òYTIDER
            ["jula", "La Navidad", "h√∏ytider"],
            ["nytt√•rsaften", "La Nochevieja", "h√∏ytider"],
            ["julaften", "La Nochebuena", "h√∏ytider"],
            ["sankthansaften", "La Noche de San Juan", "h√∏ytider"],
            ["p√•skeuken", "La Semana Santa", "h√∏ytider"],
            ["Valentinsdagen", "El D√≠a de San Valent√≠n", "h√∏ytider"],
            ["nasjonaldagen", "El d√≠a Nacional", "h√∏ytider"],
            ["de hellige tre kongers aften", "El D√≠a de los Reyes", "h√∏ytider"],
            ["allehelgensdagen", "El D√≠a de los Muertos", "h√∏ytider"],
            ["f√∏dselsdag", "El Cumplea√±os", "h√∏ytider"],
            ["konfirmasjon", "La Comuni√≥n", "h√∏ytider"],
            ["barned√•p", "El Bautizo", "h√∏ytider"],
            ["bryllup", "La Boda", "h√∏ytider"],
            ["begravelse (f)", "el Funeral", "h√∏ytider"],
            ["begravelse (ord p√• e)", "entierro", "h√∏ytider"],
            
            // UTSEENDE
            ["h√∏y", "alto", "utseende"],
            ["lav", "bajo", "utseende"],
            ["m√∏rkh√•ret", "moreno", "utseende"],
            ["blond", "rubio", "utseende"],
            ["r√∏dh√•ret", "pelirrojo", "utseende"],
            ["skallet", "calvo", "utseende"],
            ["pen/kjekk", "guapo", "utseende"],
            ["vakker", "hermoso", "utseende"],
            ["bl√• √∏yne", "los ojos azules", "utseende"],
            ["brune √∏yne", "los ojos negros", "utseende"],
            ["gr√∏nne √∏yne", "los ojos verdes", "utseende"],
            ["m√∏rkt h√•r", "el pelo moreno", "utseende"],
            ["blondt h√•r", "el pelo rubio", "utseende"],
            ["r√∏dt h√•r", "el pelo pelirrojo", "utseende"],
            ["kort h√•r", "el pelo corto", "utseende"],
            ["langt h√•r", "el pelo largo", "utseende"],
            ["rett h√•r", "el pelo liso", "utseende"],
            ["kr√∏llete h√•r", "el pelo rizado", "utseende"],
            ["hestehale", "la cola de caballo", "utseende"],
            ["pannelugg", "el flequillo", "utseende"],
            ["fletter", "las trenzas", "utseende"],
            ["briller", "las gafas", "utseende"],
            ["skjegg", "la barba", "utseende"],
            ["bart", "el bigote", "utseende"],
            ["fregner", "las pecas", "utseende"],
            ["smilehull", "los hoyuelos", "utseende"],
            ["arr", "la cicatriz", "utseende"],
            
            // PERSONLIGHET
            ["kjedelig", "aburrido", "personlighet"],
            ["omtenksom", "cari√±oso", "personlighet"],
            ["morsom", "gracioso", "personlighet"],
            ["pratsom", "hablador", "personlighet"],
            ["ut√•lmodig", "impaciente", "personlighet"],
            ["intelligent", "inteligente", "personlighet"],
            ["ryddig", "ordenado", "personlighet"],
            ["t√•lmodig", "paciente", "personlighet"],
            ["ansvarsfull", "responsable", "personlighet"],
            ["snill/ hyggelig", "simp√°tico", "personlighet"],
            ["sosial", "sociable", "personlighet"],
            ["sta", "terco", "personlighet"],
            ["sjenert", "t√≠mido", "personlighet"],
            ["lat (v)", "vago", "personlighet"],
            
            // FAMILIE
            ["bror", "el hermano", "familie"],
            ["s√∏ster", "la hermana", "familie"],
            ["fetter", "el primo", "familie"],
            ["kusine", "la prima", "familie"],
            ["tante", "la t√≠a", "familie"],
            ["onkel", "el t√≠o", "familie"],
            ["mor", "la madre", "familie"],
            ["far", "el padre", "familie"],
            ["bestemor", "la abuela", "familie"],
            ["bestefar", "el abuelo", "familie"],
            ["kj√¶reste", "el novio", "familie"],
            ["stefar", "el padrastro", "familie"],
            ["stemor", "la madrastra", "familie"],
            ["stebror", "el hermanastro", "familie"],
            ["stes√∏ster", "la hermanastra", "familie"],
            ["halvbror", "el medio hermano", "familie"],
            ["halvs√∏ster", "la media hermana", "familie"],
            ["storebror", "el hermano mayor", "familie"],
            ["lilles√∏ster", "la hermana menor", "familie"],
            
            // FAMILIE-SETNINGER
            ["Familien min best√•r av fem personer", "Mi familia consiste de cinco personas", "familie-setninger"],
            ["Hvem bor du sammen med?", "¬øCon qui√©n vives?", "familie-setninger"],
            ["Jeg bor sammen med moren og broren min", "Vivo con mi madre y mi hermano", "familie-setninger"],
            ["Foreldrene mine er skilt", "Mis padres est√°n divorciados", "familie-setninger"],
            ["Foreldrene mine er gift", "Mis padres est√°n casados", "familie-setninger"],
            ["Hva heter broren din?", "¬øC√≥mo se llama tu hermano?", "familie-setninger"],
            ["Broren min heter..", "Mi hermano se llama..", "familie-setninger"],
            ["Hvor mange √•r er broren din?", "¬øCu√°ntos a√±os tiene tu hermano?", "familie-setninger"],
            ["Broren min er √•tte √•r", "Mi hermano tiene ocho a√±os", "familie-setninger"],
            
            // KL√ÜR
            ["√• ha p√• seg", "llevar", "kl√¶r"],
            ["√• kle p√• seg", "ponerse", "kl√¶r"],
            ["st√∏vler", "las botas", "kl√¶r"],
            ["t- skjorte", "la camiseta", "kl√¶r"],
            ["bikini", "el biquini", "kl√¶r"],
            ["skjorte", "la camisa", "kl√¶r"],
            ["jeans", "los vaqueros", "kl√¶r"],
            ["lue", "el gorro", "kl√¶r"],
            ["caps", "la gorra", "kl√¶r"],
            ["belte", "el cintur√≥n", "kl√¶r"],
            ["sokker", "los calcetines", "kl√¶r"],
            ["genser (j)", "el jersey", "kl√¶r"],
            ["slipperser", "las zapatillas", "kl√¶r"],
            ["sko", "los zapatos", "kl√¶r"],
            ["h√∏yh√¶lte sko", "los zapatos de tac√≥n", "kl√¶r"],
            ["sandaler", "las sandalias", "kl√¶r"],
            ["treningssko", "las zapatillas deportivas", "kl√¶r"],
            ["jakke", "la chaqueta", "kl√¶r"],
            ["kjole", "el vestido", "kl√¶r"],
            ["skj√∏rt", "la falda", "kl√¶r"],
            ["h√•ndveske", "el bolso", "kl√¶r"],
            ["solbriller", "las gafas de sol", "kl√¶r"],
            ["skjerf", "la bufanda", "kl√¶r"],
            ["sjal", "el chal", "kl√¶r"],
            ["hatt", "el sombrero", "kl√¶r"],
            ["lommet√∏rkle", "el pa√±uelo", "kl√¶r"],
            ["slips", "la corbata", "kl√¶r"],
            ["paraply", "el paraguas", "kl√¶r"],
            ["ring", "el anillo", "kl√¶r"],
            ["armb√•nd", "la pulsera", "kl√¶r"],
            ["klokke", "el reloj", "kl√¶r"],
            ["smykke", "la cadena", "kl√¶r"],
            ["√∏reringer", "los pendientes", "kl√¶r"],
            
            // YRKER
            ["advokat", "el abogado", "yrker"],
            ["brannmann", "el bombero", "yrker"],
            ["snekker", "el carpintero", "yrker"],
            ["kokk", "el cocinero", "yrker"],
            ["tannlege", "el dentista", "yrker"],
            ["elektriker", "el electrista", "yrker"],
            ["sykepleier", "el enfermero", "yrker"],
            ["bonde", "el granjero", "yrker"],
            ["lege", "el m√©dico", "yrker"],
            ["fris√∏r", "el peluquero", "yrker"],
            ["journalist", "el periodista", "yrker"],
            ["politi", "el polic√≠a", "yrker"],
            ["l√¶rer (p)", "el profesor", "yrker"],
            ["dyrlege", "el veterinario", "yrker"],
            ["hva jobber du med?", "¬øen qu√© trabajas?", "yrker"],
            ["hvor jobber du?", "¬øD√≥nde trabajas?", "yrker"],
            ["N√•r jobber du?", "¬øCu√°ndo trabajas?", "yrker"],
            ["Hva jobber moren din med?", "¬øEn qu√© trabaja tu madre?", "yrker"],
            
            // HOBBYER
            ["golf", "el golf", "hobbyer"],
            ["amerikansk fotball", "el f√∫tbol americano", "hobbyer"],
            ["h√•ndball", "el balonmano", "hobbyer"],
            ["volleyball", "el voleibol", "hobbyer"],
            ["badminton", "b√°dminton", "hobbyer"],
            ["innebandy", "el bandy sala", "hobbyer"],
            ["tennis", "el tenis", "hobbyer"],
            ["bordtennis", "el tenis de mesa", "hobbyer"],
            ["ishockey", "el hockey sobre hielo", "hobbyer"],
            ["dataspill", "videojuegos", "hobbyer"],
            ["langrenn", "esqu√≠ de fondo", "hobbyer"],
            ["alpint", "esqu√≠ alpino", "hobbyer"],
            ["√• handle", "ir de compras", "hobbyer"],
            ["√• sykle", "montar en bici", "hobbyer"],
            ["√• synge", "cantar", "hobbyer"],
            ["√• se p√• TV", "ver la tele", "hobbyer"],
            ["√• spille gitar", "tocar la guitarra", "hobbyer"],
            ["√• spille piano", "tocar el piano", "hobbyer"],
            ["√• trene", "entrenar", "hobbyer"],
            ["√• h√∏re musikk", "escuchar m√∫sica", "hobbyer"],
            ["√• v√¶re med venner", "estar con amigos", "hobbyer"],
            ["√• dra ut med venner", "salir con mis amigos", "hobbyer"],
            ["√• danse", "bailar", "hobbyer"],
            ["√• g√• tur", "hacer cenderismo", "hobbyer"],
            ["√• slappe av", "relajar", "hobbyer"],
            ["√• surfe p√• internett", "navegar por internet", "hobbyer"],
            
            // KLOKKA
            ["Har du klokke?", "¬øTienes hora?", "klokka"],
            ["Vet du hvor mye klokka er?", "Perd√≥n, ¬øSabes qu√© hora es?", "klokka"],
            ["N√•r skal du spise?", "¬øA qu√© hora vas a comer?", "klokka"],
            ["jeg skal spise klokka √•tte", "voy a comer a las ocho", "klokka"],
            ["Den er 13:00", "Es la una", "klokka"],
            ["Den er kvart over ett", "es la una y cuarto", "klokka"],
            ["Den er halv to", "es la una y media", "klokka"],
            ["Den er to", "son las dos", "klokka"],
            ["den er ti over halv tre", "son las tres menos veinte", "klokka"],
            ["den er ti p√• tre", "son las tres menos diez", "klokka"],
            ["klokken √•tte om morgenen", "a las ocho de la ma√±ana", "klokka"],
            ["klokka seks p√• ettermiddagen", "a las seis de la tarde", "klokka"],
            ["klokka tolv p√• natta", "a las doce de la noche", "klokka"],
            ["Klokken er akkurat 5", "Son las cinco en punto", "klokka"],
            
            // TIDSUTTRYKK
            ["hver dag", "todos los d√≠as", "tidsuttrykk"],
            ["p√• mandag", "el lunes", "tidsuttrykk"],
            ["p√• mandager", "los lunes", "tidsuttrykk"],
            ["p√• morgenen", "por la ma√±ana", "tidsuttrykk"],
            ["for noen dager siden", "hace unos d√≠as", "tidsuttrykk"],
            ["hver uke", "cada semana", "tidsuttrykk"],
            ["ofte", "a menudo", "tidsuttrykk"],
            ["sjelden", "raramente", "tidsuttrykk"],
            ["p√• ettermiddagen", "por la tarde", "tidsuttrykk"],
            ["f√∏r", "antes", "tidsuttrykk"],
            ["i kveld", "esta noche", "tidsuttrykk"],
            ["i morgen", "ma√±ana", "tidsuttrykk"],
            ["i g√•r", "ayer", "tidsuttrykk"],
            ["p√• kvelden", "por la noche", "tidsuttrykk"],
            ["etter / etterp√•", "despu√©s", "tidsuttrykk"],
            
            // SKOLE
            ["elev", "el alumno", "skole"],
            ["l√¶rer (p)", "el profesor", "skole"],
            ["skoletime", "la clase", "skole"],
            ["skoleklasse", "la clase", "skole"],
            ["tavle", "la pizarra", "skole"],
            ["kart", "el mapa", "skole"],
            ["papirkurv", "la papelera", "skole"],
            ["bok", "el libro", "skole"],
            ["PC", "el ordenador", "skole"],
            ["ungdomsskolen", "la E.S.O", "skole"],
            ["pult", "la mesa", "skole"],
            ["stol", "la silla", "skole"],
            ["sekk", "la mochila", "skole"],
            ["pennal", "el estuche", "skole"],
            ["blyant", "el l√°piz", "skole"],
            ["penn", "el bol√≠grafo", "skole"],
            ["viskel√¶r", "la goma", "skole"],
            ["blyantspisser", "el sacapuntas", "skole"],
            ["linjal", "la regla", "skole"],
            ["videreg√•ende", "el bachillerato", "skole"],
            
            // FAG
            ["engelsk", "el ingl√©s", "fag"],
            ["matte", "las matem√°ticas", "fag"],
            ["historie", "la historia", "fag"],
            ["samfunnsfag", "las ciencias sociales", "fag"],
            ["naturfag", "las ciencias naturales", "fag"],
            ["kropps√∏ving", "la educaci√≥n f√≠sica", "fag"],
            ["kunst og h√•ndtverk", "las artes manuales", "fag"],
            ["religion / KRLE", "el religi√≥n", "fag"],
            
            // HJEM
            ["rom", "la habitaci√≥n", "hjem"],
            ["rom (annet ord, C)", "el cuarto", "hjem"],
            ["bad", "el ba√±o", "hjem"],
            ["spisestue", "el comedor", "hjem"],
            ["gang", "el pasillo", "hjem"],
            ["loft", "el √°tico", "hjem"],
            ["d√∏r", "la puerta", "hjem"],
            ["soverom", "el dormitorio", "hjem"],
            ["arbeidsrom", "el cuarto de trabajo", "hjem"],
            ["stue (c)", "el cuarto de estar", "hjem"],
            ["kj√∏kken", "la cocina", "hjem"],
            ["kjeller", "el s√≥tano", "hjem"],
            ["vindu", "la ventana", "hjem"],
            ["hus", "la casa", "hjem"],
            
            // M√òBLER
            ["m√∏bel", "el mueble", "m√∏bler"],
            ["sofa", "el sof√°", "m√∏bler"],
            ["bord", "la mesa", "m√∏bler"],
            ["TV", "el televisor", "m√∏bler"],
            ["skap", "el armario", "m√∏bler"],
            ["plakat", "el p√≥ster", "m√∏bler"],
            ["kj√∏leskap (n)", "la nevera", "m√∏bler"],
            ["skrivebord", "el escritorio", "m√∏bler"],
            ["bokhylle", "la estanter√≠a", "m√∏bler"],
            ["kommode", "la c√≥moda", "m√∏bler"],
            ["lenestol", "el sill√≥n", "m√∏bler"],
            ["teppe", "la alfombra", "m√∏bler"],
            ["oppvaskmaskin", "el lavavajillas", "m√∏bler"],
            ["seng", "la cama", "m√∏bler"],
            ["lampe", "la l√°mpara", "m√∏bler"],
            ["bilde / maleri (c)", "el cuadro", "m√∏bler"],
            ["ovn", "el horno", "m√∏bler"],
            ["speil", "el espejo", "m√∏bler"],
            
            // GUSTAR
            ["jeg liker", "me gusta", "gustar"],
            ["jeg liker ikke", "no me gusta", "gustar"],
            ["du liker", "te gusta", "gustar"],
            ["du liker ikke", "no te gusta", "gustar"],
            ["han/hun liker", "le gusta", "gustar"],
            ["jeg liker denne boken", "me gusta este libro", "gustar"],
            ["jeg liker disse b√∏kene", "me gustan estos libros", "gustar"],
            ["jeg elsker (me ....)", "me encanta", "gustar"],
            ["jeg blir irritert av", "me molesta", "gustar"],
            
            // RUTINER
            ["jeg v√•kner", "me despierto", "rutiner"],
            ["jeg st√•r opp", "me levanto", "rutiner"],
            ["jeg dusjer", "me ducho", "rutiner"],
            ["jeg pusser tennene", "me cepillo los dientes", "rutiner"],
            ["jeg sminker meg", "me maquillo", "rutiner"],
            ["jeg barberer meg", "me afeito", "rutiner"],
            ["jeg b√∏rster h√•ret", "me peino", "rutiner"],
            ["jeg kler p√• meg", "me visto", "rutiner"],
            ["jeg legger meg", "me acuesto", "rutiner"],
            ["jeg spiser frokost", "desayuno", "rutiner"],
            ["jeg g√•r ut av huset", "salgo de la casa", "rutiner"],
            ["jeg drar p√• skolen", "voy a la escuela", "rutiner"],
            ["jeg spiser lunsj", "almuerzo", "rutiner"],
            ["jeg drar hjem", "voy a casa", "rutiner"],
            ["jeg drar p√• trening", "voy al entrenamiento", "rutiner"],
            ["jeg spiser middag", "ceno", "rutiner"],
            ["jeg sover", "duermo", "rutiner"],
            ["jeg st√•r opp tidlig", "me despierto temprano", "rutiner"],
            ["jeg tar p√• meg en t- skjorte", "me pongo una camiseta", "rutiner"],
            ["jeg g√•r til skolen", "voy a pie a la escuela", "rutiner"],
            
            // VERBB√òYING
            ["b√∏ying av verbet SER, som betyr √• v√¶re", "soy, eres, es, somos, sois, son", "verbb√∏ying"],
            ["b√∏ying av verbet tener, som betyr √• ha", "tengo, tienes, tiene, tenemos, ten√©is, tienen", "verbb√∏ying"],
            ["b√∏ying av verbet ir", "voy, vas, va, vamos, v√°is, van", "verbb√∏ying"],
            ["b√∏ying av verbet estar, som betyr √• v√¶re/√• befinne seg", "estoy, est√°s, est√°, estamos, est√°is, est√°n", "verbb√∏ying"],
            ["b√∏ying av verbet hablar, som betyr √• snakke", "hablo, hablas, habla, hablamos, habl√°is, hablan", "verbb√∏ying"],
            ["b√∏ying av verbet comer, som betyr √• spise", "como, comes, come, comemos, com√©is, comen", "verbb√∏ying"],
            ["b√∏ying av verbet vivir, som betyr √• spise", "vivo, vives, vive, vivimos, viv√≠s, viven", "verbb√∏ying"],
            ["b√∏ying av verbet poder, som betyr √• kunne", "puedo, puedes, puede, podemos, pod√©is, pueden", "verbb√∏ying"],
            ["b√∏ying av verbet decir, som betyr √• si", "digo, dices, dice, decimos, dec√≠s, dicen", "verbb√∏ying"],
            ["b√∏ying av verbet hacer, som betyr √• gj√∏re", "hago, haces, hace, hacemos, hac√©is, hacen", "verbb√∏ying"],
            ["b√∏ying av verbet querer, som betyr √• ville", "quiero, quieres, quiere, queremos, quer√©is, quieren", "verbb√∏ying"],
            ["b√∏ying av verbet saber, som betyr √• vite", "s√©, sabes, sabe, sabemos, sab√©is, saben", "verbb√∏ying"],
            ["b√∏ying av verbet salir, som betyr √• g√• ut", "salgo, sales, sale, salimos, sal√≠s, salen", "verbb√∏ying"],
            ["b√∏ying av verbet venir, som betyr √• komme", "vengo, vienes, viene, venimos, ven√≠s, vienen", "verbb√∏ying"],
            
            // FREMTID
            ["jeg skal gj√∏re noe", "voy a hacer algo", "fremtid"],
            ["hva skal du gj√∏re i dag?", "¬øQu√© vas a hacer hoy?", "fremtid"],
            ["hva skal du gj√∏re i morgen?", "¬øQu√© vas a hacer ma√±ana?", "fremtid"],
            ["I dag skal jeg v√¶re med venner", "Hoy voy a estar con mis amigos", "fremtid"],
            ["I morgen skal jeg bes√∏ke bestemora mi", "Ma√±ana voy a visitar mi abuela", "fremtid"],
            ["Hva skal du gj√∏re til neste √•r?", "¬øQu√© vas a hacer el a√±o que viene?", "fremtid"],
            ["Neste √•r skal jeg begynne p√• videreg√•ende", "El a√±o que viene voy a empezar el bachillerato", "fremtid"],
            
            // VERB
            ["√• snakke", "hablar", "verb"],
            ["√• jobbe", "trabajar", "verb"],
            ["√• trene", "entrenar", "verb"],
            ["√• danse", "bailar", "verb"],
            ["√• kj√∏pe", "comprar", "verb"],
            ["√• spise", "comer", "verb"],
            ["√• drikke", "beber", "verb"],
            ["√• lese", "leer", "verb"],
            ["√• studere", "estudiar", "verb"],
            ["√• bo/ √• leve", "vivir", "verb"],
            ["√• skrive", "escribir", "verb"],
            ["√• h√∏re", "escuchar", "verb"],
            ["√• se", "ver", "verb"],
            ["√• l√¶re", "aprender", "verb"],
            ["√• vinne", "ganar", "verb"],
            ["√• glemme", "olvidar", "verb"],
            ["√• hjelpe", "ayudar", "verb"],
            ["√• synge", "cantar", "verb"],
            ["√• vente", "esperar", "verb"],
            ["√• sp√∏rre", "preguntar", "verb"],
            ["√• betale", "pagar", "verb"],
            ["√• reise", "viajar", "verb"],
            
            // BINDEORD
            ["og", "y", "bindeord"],
            ["eller", "o", "bindeord"],
            ["men", "pero", "bindeord"],
            ["ogs√•", "tambi√©n", "bindeord"],
            ["alltid", "siempre", "bindeord"],
            ["aldri", "nunca", "bindeord"],
            ["noen ganger", "a veces", "bindeord"],
            ["vanligvis", "normalmente", "bindeord"],
            ["fordi", "porque", "bindeord"],
            ["derfor", "por eso", "bindeord"],
            ["kanskje", "quiz√°s", "bindeord"],
            ["dermed / deretter / s√•", "entonces", "bindeord"],
            ["i tillegg / dessuten", "adem√°s", "bindeord"],
            ["selv om", "aunque", "bindeord"],
            ["allikevel", "sin embargo", "bindeord"],
            ["p√• den ene siden", "por un lado", "bindeord"],
            ["p√• den andre siden", "por otro lado", "bindeord"],
            ["f√∏rst og fremst", "sobretodo", "bindeord"],
            ["samtidig", "al mismo tiempo", "bindeord"],
            ["selvf√∏lgelig", "claro", "bindeord"],
            ["jeg skal snakke om", "voy a hablar sobre", "bindeord"],
            ["takk for oppmerksomheten", "gracias por su atenci√≥n", "bindeord"]
        ];

        // ============================================
        // VERB CONJUGATION DATABASE
        // ============================================

        const verbDatabase = {
            // REGULAR -AR VERBS
            hablar: {
                infinitive: "hablar",
                translation: "√• snakke",
                type: "regular -ar",
                presente: ["hablo", "hablas", "habla", "hablamos", "habl√°is", "hablan"],
                participio: "hablado"
            },
            trabajar: {
                infinitive: "trabajar",
                translation: "√• jobbe",
                type: "regular -ar",
                presente: ["trabajo", "trabajas", "trabaja", "trabajamos", "trabaj√°is", "trabajan"],
                participio: "trabajado"
            },
            estudiar: {
                infinitive: "estudiar",
                translation: "√• studere",
                type: "regular -ar",
                presente: ["estudio", "estudias", "estudia", "estudiamos", "estudi√°is", "estudian"],
                participio: "estudiado"
            },
            bailar: {
                infinitive: "bailar",
                translation: "√• danse",
                type: "regular -ar",
                presente: ["bailo", "bailas", "baila", "bailamos", "bail√°is", "bailan"],
                participio: "bailado"
            },
            comprar: {
                infinitive: "comprar",
                translation: "√• kj√∏pe",
                type: "regular -ar",
                presente: ["compro", "compras", "compra", "compramos", "compr√°is", "compran"],
                participio: "comprado"
            },
            escuchar: {
                infinitive: "escuchar",
                translation: "√• h√∏re",
                type: "regular -ar",
                presente: ["escucho", "escuchas", "escucha", "escuchamos", "escuch√°is", "escuchan"],
                participio: "escuchado"
            },
            cantar: {
                infinitive: "cantar",
                translation: "√• synge",
                type: "regular -ar",
                presente: ["canto", "cantas", "canta", "cantamos", "cant√°is", "cantan"],
                participio: "cantado"
            },
            
            // REGULAR -ER VERBS
            comer: {
                infinitive: "comer",
                translation: "√• spise",
                type: "regular -er",
                presente: ["como", "comes", "come", "comemos", "com√©is", "comen"],
                participio: "comido"
            },
            beber: {
                infinitive: "beber",
                translation: "√• drikke",
                type: "regular -er",
                presente: ["bebo", "bebes", "bebe", "bebemos", "beb√©is", "beben"],
                participio: "bebido"
            },
            leer: {
                infinitive: "leer",
                translation: "√• lese",
                type: "regular -er",
                presente: ["leo", "lees", "lee", "leemos", "le√©is", "leen"],
                participio: "le√≠do"
            },
            aprender: {
                infinitive: "aprender",
                translation: "√• l√¶re",
                type: "regular -er",
                presente: ["aprendo", "aprendes", "aprende", "aprendemos", "aprend√©is", "aprenden"],
                participio: "aprendido"
            },
            
            // REGULAR -IR VERBS
            vivir: {
                infinitive: "vivir",
                translation: "√• bo",
                type: "regular -ir",
                presente: ["vivo", "vives", "vive", "vivimos", "viv√≠s", "viven"],
                participio: "vivido"
            },
            escribir: {
                infinitive: "escribir",
                translation: "√• skrive",
                type: "regular -ir",
                presente: ["escribo", "escribes", "escribe", "escribimos", "escrib√≠s", "escriben"],
                participio: "escrito"
            },
            
            // IRREGULAR VERBS
            ser: {
                infinitive: "ser",
                translation: "√• v√¶re (permanent)",
                type: "uregelmessig",
                presente: ["soy", "eres", "es", "somos", "sois", "son"],
                participio: "sido"
            },
            estar: {
                infinitive: "estar",
                translation: "√• v√¶re/befinne seg",
                type: "uregelmessig",
                presente: ["estoy", "est√°s", "est√°", "estamos", "est√°is", "est√°n"],
                participio: "estado"
            },
            tener: {
                infinitive: "tener",
                translation: "√• ha",
                type: "uregelmessig",
                presente: ["tengo", "tienes", "tiene", "tenemos", "ten√©is", "tienen"],
                participio: "tenido"
            },
            ir: {
                infinitive: "ir",
                translation: "√• g√•/dra",
                type: "uregelmessig",
                presente: ["voy", "vas", "va", "vamos", "vais", "van"],
                participio: "ido"
            },
            hacer: {
                infinitive: "hacer",
                translation: "√• gj√∏re",
                type: "uregelmessig",
                presente: ["hago", "haces", "hace", "hacemos", "hac√©is", "hacen"],
                participio: "hecho"
            },
            poder: {
                infinitive: "poder",
                translation: "√• kunne",
                type: "uregelmessig",
                presente: ["puedo", "puedes", "puede", "podemos", "pod√©is", "pueden"],
                participio: "podido"
            },
            querer: {
                infinitive: "querer",
                translation: "√• ville",
                type: "uregelmessig",
                presente: ["quiero", "quieres", "quiere", "queremos", "quer√©is", "quieren"],
                participio: "querido"
            },
            decir: {
                infinitive: "decir",
                translation: "√• si",
                type: "uregelmessig",
                presente: ["digo", "dices", "dice", "decimos", "dec√≠s", "dicen"],
                participio: "dicho"
            },
            saber: {
                infinitive: "saber",
                translation: "√• vite",
                type: "uregelmessig",
                presente: ["s√©", "sabes", "sabe", "sabemos", "sab√©is", "saben"],
                participio: "sabido"
            },
            venir: {
                infinitive: "venir",
                translation: "√• komme",
                type: "uregelmessig",
                presente: ["vengo", "vienes", "viene", "venimos", "ven√≠s", "vienen"],
                participio: "venido"
            },
            salir: {
                infinitive: "salir",
                translation: "√• g√• ut",
                type: "uregelmessig",
                presente: ["salgo", "sales", "sale", "salimos", "sal√≠s", "salen"],
                participio: "salido"
            },
            ver: {
                infinitive: "ver",
                translation: "√• se",
                type: "uregelmessig",
                presente: ["veo", "ves", "ve", "vemos", "veis", "ven"],
                participio: "visto"
            }
        };

        const pronouns = ["yo", "t√∫", "√©l/ella", "nosotros", "vosotros", "ellos"];
        const pronounsNorwegian = ["jeg", "du", "han/hun", "vi", "dere", "de"];

        // Haber for perfect tense
        const haberPresente = ["he", "has", "ha", "hemos", "hab√©is", "han"];

        // ============================================
        // SM-2 ALGORITHM
        // ============================================

        const SM2 = {
            defaultEaseFactor: 2.5,
            minEaseFactor: 1.3,
            
            calculateNextReview(card, quality) {
                let { easeFactor = this.defaultEaseFactor, interval = 0, repetitions = 0 } = card;
                
                if (quality === 0) {
                    repetitions = 0;
                    interval = 0;
                    easeFactor = Math.max(this.minEaseFactor, easeFactor - 0.2);
                } else if (quality === 1) {
                    interval = repetitions === 0 ? 1 : Math.max(1, Math.round(interval * 1.2));
                    easeFactor = Math.max(this.minEaseFactor, easeFactor - 0.15);
                    repetitions++;
                } else if (quality === 2) {
                    if (repetitions === 0) interval = 1;
                    else if (repetitions === 1) interval = 3;
                    else interval = Math.round(interval * easeFactor);
                    repetitions++;
                } else if (quality === 3) {
                    if (repetitions === 0) interval = 4;
                    else if (repetitions === 1) interval = 7;
                    else interval = Math.round(interval * easeFactor * 1.3);
                    easeFactor = Math.min(3.0, easeFactor + 0.15);
                    repetitions++;
                }
                
                interval = Math.min(180, interval);
                const nextReview = new Date();
                nextReview.setDate(nextReview.getDate() + interval);
                
                return { easeFactor, interval, repetitions, nextReview: nextReview.toISOString() };
            },
            
            getIntervalText(quality, card) {
                const result = this.calculateNextReview(card, quality);
                if (result.interval === 0) return 'N√•';
                if (result.interval === 1) return '1 dag';
                if (result.interval < 7) return `${result.interval} dager`;
                if (result.interval < 30) return `${Math.round(result.interval / 7)} uker`;
                return `${Math.round(result.interval / 30)} mnd`;
            }
        };

        // ============================================
        // APP STATE
        // ============================================

        let cards = [];
        let selectedCategories = new Set();
        let sessionCards = [];
        let currentIndex = 0;
        let currentCard = null;
        let showingAnswer = false;
        let sessionStartTime = null;
        let sessionStats = { reviewed: 0, correct: 0, newLearned: 0 };

        // Verb state
        let selectedVerbs = new Set(['hablar', 'comer', 'vivir', 'ser', 'estar', 'tener', 'ir']);
        let selectedTense = 'presente';
        let verbSessionExercises = [];
        let verbCurrentIndex = 0;
        let verbStats = { correct: 0, total: 0 };
        let verbAnswerPending = false;

        // ============================================
        // NAVIGATION
        // ============================================

        function showPage(page) {
            // Hide all pages
            document.getElementById('vocabPage').classList.add('hidden');
            document.getElementById('brainmapPage').classList.add('hidden');
            document.getElementById('verbPage').classList.add('hidden');
            document.getElementById('grammarPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.add('hidden');
            
            // Remove active from all nav links
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            
            // Show selected page
            if (page === 'vocab') {
                document.getElementById('vocabPage').classList.remove('hidden');
                document.getElementById('navVocab').classList.add('active');
                document.getElementById('vocabSettings').classList.remove('hidden');
                document.getElementById('vocabStudy').classList.add('hidden');
                updateStats();
            } else if (page === 'brainmap') {
                document.getElementById('brainmapPage').classList.remove('hidden');
                document.getElementById('navBrainmap').classList.add('active');
                renderBrainmap();
            } else if (page === 'verbs') {
                document.getElementById('verbPage').classList.remove('hidden');
                document.getElementById('navVerbs').classList.add('active');
                document.getElementById('verbSettings').classList.remove('hidden');
                document.getElementById('verbExercise').classList.add('hidden');
                renderVerbSelector();
            } else if (page === 'grammar') {
                document.getElementById('grammarPage').classList.remove('hidden');
                document.getElementById('navGrammar').classList.add('active');
                document.getElementById('grammarSettings').classList.remove('hidden');
                document.getElementById('grammarExercise').classList.add('hidden');
                renderGrammarTopics();
            } else if (page === 'dashboard') {
                document.getElementById('dashboardPage').classList.remove('hidden');
                document.getElementById('navDashboard').classList.add('active');
                loadTeacherDashboard();
            }
        }

        // ============================================
        // VOCABULARY FUNCTIONS
        // ============================================

        function init() {
            loadData();
            populateCategories();
            updateStats();
            setupKeyboardShortcuts();
            renderVerbSelector();
            loadGrammarProgress();
            updateCategoryDropdown();
        }

        function loadData() {
            const saved = localStorage.getItem('spansk123Data_v4');
            if (saved) {
                cards = JSON.parse(saved);
                mergeNewVocabulary();
            } else {
                cards = glossary.map((item, index) => ({
                    id: index,
                    no: item[0],
                    es: item[1],
                    category: item[2],
                    noEs: { easeFactor: SM2.defaultEaseFactor, interval: 0, repetitions: 0, nextReview: null },
                    esNo: { easeFactor: SM2.defaultEaseFactor, interval: 0, repetitions: 0, nextReview: null },
                    lastReview: null,
                    reviews: 0,
                    correct: 0
                }));
                saveData();
            }
        }

        function mergeNewVocabulary() {
            const existingIds = new Set(cards.map(c => c.id));
            glossary.forEach((item, index) => {
                if (!existingIds.has(index)) {
                    cards.push({
                        id: index, no: item[0], es: item[1], category: item[2],
                        noEs: { easeFactor: SM2.defaultEaseFactor, interval: 0, repetitions: 0, nextReview: null },
                        esNo: { easeFactor: SM2.defaultEaseFactor, interval: 0, repetitions: 0, nextReview: null },
                        lastReview: null, reviews: 0, correct: 0
                    });
                }
            });
            saveData();
        }

        function saveData() {
            localStorage.setItem('spansk123Data_v4', JSON.stringify(cards));
            scheduleSyncToServer();
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Vocab shortcuts
                if (!document.getElementById('vocabStudy').classList.contains('hidden')) {
                    if (!showingAnswer) {
                        if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); flipCard(); }
                    } else {
                        if (e.key === '1') { e.preventDefault(); rateCard(0); }
                        else if (e.key === '2') { e.preventDefault(); rateCard(2); }
                    }
                }
                
                // Verb shortcuts
                if (!document.getElementById('verbExercise').classList.contains('hidden')) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        checkVerbAnswer();
                    }
                }
            });
        }

        function getCategories() {
            const categories = {};
            cards.forEach(card => {
                if (!categories[card.category]) {
                    categories[card.category] = { count: 0, mastered: 0 };
                }
                categories[card.category].count++;
                if (card.noEs.repetitions >= 3 || card.esNo.repetitions >= 3) {
                    categories[card.category].mastered++;
                }
            });
            return categories;
        }

        function populateCategories() {
            const categories = getCategories();
            const grid = document.getElementById('categoryGrid');
            const sortedCategories = Object.entries(categories).sort((a, b) => a[0].localeCompare(b[0]));
            
            grid.innerHTML = sortedCategories.map(([name, data]) => `
                <div class="category-chip ${selectedCategories.has(name) ? 'selected' : ''}" 
                     onclick="toggleCategory('${name}')">
                    ${getCategoryEmoji(name)} ${capitalizeFirst(name)}
                    <span class="count">(${data.count})</span>
                </div>
            `).join('');
        }

        function getCategoryEmoji(category) {
            const emojis = {
                'tall': 'üî¢', 'farger': 'üé®', 'bursdag': 'üéÇ', 'land': 'üåç',
                'v√¶r': '‚òÄÔ∏è', 'h√∏ytider': 'üéÑ', 'utseende': 'üëÄ', 'personlighet': 'üí≠',
                'familie': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', 'familie-setninger': 'üí¨', 'kl√¶r': 'üëï',
                'yrker': 'üë∑', 'hobbyer': '‚öΩ', 'klokka': 'üïê', 'tidsuttrykk': 'üìÖ',
                'skole': 'üìö', 'fag': 'üìñ', 'hjem': 'üè†', 'm√∏bler': 'üõãÔ∏è',
                'gustar': '‚ù§Ô∏è', 'rutiner': '‚è∞', 'verbb√∏ying': 'üìù',
                'fremtid': 'üîÆ', 'verb': 'üèÉ', 'bindeord': 'üîó'
            };
            return emojis[category] || 'üìå';
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function toggleCategory(name) {
            if (selectedCategories.has(name)) selectedCategories.delete(name);
            else selectedCategories.add(name);
            populateCategories();
        }

        function selectAllCategories() {
            Object.keys(getCategories()).forEach(cat => selectedCategories.add(cat));
            populateCategories();
        }

        function deselectAllCategories() {
            selectedCategories.clear();
            populateCategories();
        }

        function updateStats() {
            const filtered = getFilteredCards();
            const total = filtered.length;
            const newCards = filtered.filter(c => c.noEs.repetitions === 0 && c.esNo.repetitions === 0).length;
            const mastered = filtered.filter(c => c.noEs.repetitions >= 3 && c.esNo.repetitions >= 3).length;
            const due = getDueCards(filtered).length;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statNew').textContent = newCards;
            document.getElementById('statDue').textContent = due;
            document.getElementById('statMastered').textContent = mastered;

            const masteredPercent = total > 0 ? (mastered / total) * 100 : 0;
            const learning = total - newCards - mastered;
            const learningPercent = total > 0 ? (learning / total) * 100 : 0;
            
            document.getElementById('progressMastered').style.width = masteredPercent + '%';
            document.getElementById('progressLearning').style.width = learningPercent + '%';
            document.getElementById('progressNew').style.width = (100 - masteredPercent - learningPercent) + '%';
            document.getElementById('progressPercent').textContent = Math.round(masteredPercent) + '%';
        }

        function getFilteredCards() {
            if (selectedCategories.size === 0) return cards;
            return cards.filter(c => selectedCategories.has(c.category));
        }

        function getDueCards(cardList) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dueItems = [];
            
            cardList.forEach(card => {
                if (card.noEs.repetitions > 0 && card.noEs.nextReview && new Date(card.noEs.nextReview) <= today) {
                    dueItems.push({ card, direction: 'no-es' });
                }
                if (card.esNo.repetitions > 0 && card.esNo.nextReview && new Date(card.esNo.nextReview) <= today) {
                    dueItems.push({ card, direction: 'es-no' });
                }
            });
            return dueItems;
        }

        function getNewCards(cardList) {
            const newItems = [];
            cardList.forEach(card => {
                if (card.noEs.repetitions === 0) newItems.push({ card, direction: 'no-es' });
                if (card.esNo.repetitions === 0) newItems.push({ card, direction: 'es-no' });
            });
            return newItems;
        }

        function startVocabSession() {
            const newLimit = parseInt(document.getElementById('newCardsLimit').value);
            const reviewLimit = parseInt(document.getElementById('reviewCardsLimit').value);
            const filtered = getFilteredCards();
            
            const dueCards = getDueCards(filtered).slice(0, reviewLimit);
            const newCards = getNewCards(filtered).slice(0, newLimit * 2);
            
            sessionCards = shuffleArray([...dueCards, ...newCards]);
            
            if (sessionCards.length === 0) {
                alert('Ingen kort tilgjengelig! Pr√∏v √• velge kategorier eller vent til flere kort forfaller.');
                return;
            }
            
            currentIndex = 0;
            sessionStartTime = new Date();
            sessionStats = { reviewed: 0, correct: 0, newLearned: 0 };
            
            document.getElementById('vocabSettings').classList.add('hidden');
            document.getElementById('vocabStudy').classList.remove('hidden');
            
            showVocabCard();
        }

        function showVocabCard() {
            if (currentIndex >= sessionCards.length) {
                endVocabSession();
                return;
            }
            
            const item = sessionCards[currentIndex];
            currentCard = item;
            showingAnswer = false;
            
            const card = item.card;
            const direction = item.direction;
            const srData = direction === 'no-es' ? card.noEs : card.esNo;
            const isNew = srData.repetitions === 0;
            const front = direction === 'no-es' ? card.no : card.es;
            
            updateVocabProgress();
            
            document.getElementById('flashcardArea').innerHTML = `
                <div class="flashcard" onclick="flipCard()">
                    <span class="card-type-badge ${isNew ? 'badge-new' : 'badge-review'}">
                        ${isNew ? 'Nytt kort' : 'Repetisjon'}
                    </span>
                    <span class="direction-badge">
                        ${direction === 'no-es' ? 'üá≥üá¥ ‚Üí üá™üá∏' : 'üá™üá∏ ‚Üí üá≥üá¥'}
                    </span>
                    <div class="card-word">${front}</div>
                    <div class="card-hint">Trykk for √• se svar (mellomrom)</div>
                    <span class="card-category">${getCategoryEmoji(card.category)} ${capitalizeFirst(card.category)}</span>
                </div>
            `;
            
            document.getElementById('buttonArea').innerHTML = '';
        }

        function flipCard() {
            if (showingAnswer) return;
            showingAnswer = true;
            
            const item = currentCard;
            const card = item.card;
            const direction = item.direction;
            const srData = direction === 'no-es' ? card.noEs : card.esNo;
            const isNew = srData.repetitions === 0;
            const front = direction === 'no-es' ? card.no : card.es;
            const back = direction === 'no-es' ? card.es : card.no;
            const intervals = [0, 1, 2, 3].map(q => SM2.getIntervalText(q, srData));
            
            document.getElementById('flashcardArea').innerHTML = `
                <div class="flashcard">
                    <span class="card-type-badge ${isNew ? 'badge-new' : 'badge-review'}">
                        ${isNew ? 'Nytt kort' : 'Repetisjon'}
                    </span>
                    <span class="direction-badge">
                        ${direction === 'no-es' ? 'üá≥üá¥ ‚Üí üá™üá∏' : 'üá™üá∏ ‚Üí üá≥üá¥'}
                    </span>
                    <div class="card-word" style="font-size: 18px; color: var(--gray-500); margin-bottom: 8px;">${front}</div>
                    <div class="card-answer">${back}</div>
                    <span class="card-category">${getCategoryEmoji(card.category)} ${capitalizeFirst(card.category)}</span>
                </div>
            `;
            
            document.getElementById('buttonArea').innerHTML = `
                <div class="rating-buttons">
                    <button class="rating-btn rating-again" onclick="rateCard(0)">üòì Igjen<span class="interval">${intervals[0]}</span><span class="key">(1)</span></button>
                    <button class="rating-btn rating-good" onclick="rateCard(2)">üòä Bra<span class="interval">${intervals[2]}</span><span class="key">(2)</span></button>
                </div>
            `;
        }

        function rateCard(quality) {
            const item = currentCard;
            const card = cards.find(c => c.id === item.card.id);
            const direction = item.direction;
            const srData = direction === 'no-es' ? card.noEs : card.esNo;
            const wasNew = srData.repetitions === 0;
            
            const result = SM2.calculateNextReview(srData, quality);
            
            if (direction === 'no-es') card.noEs = { ...card.noEs, ...result };
            else card.esNo = { ...card.esNo, ...result };
            
            card.lastReview = new Date().toISOString();
            card.reviews++;
            if (quality >= 2) card.correct++;
            
            sessionStats.reviewed++;
            if (quality >= 2) sessionStats.correct++;
            if (wasNew && quality >= 2) sessionStats.newLearned++;
            
            if (quality === 0) sessionCards.push(item);
            
            saveData();
            currentIndex++;
            showVocabCard();
        }

        function updateVocabProgress() {
            const progress = (currentIndex / sessionCards.length) * 100;
            document.getElementById('sessionProgressFill').style.width = progress + '%';
            document.getElementById('sessionStats').textContent = `${sessionStats.reviewed} repetert ‚Ä¢ ${sessionStats.correct} riktig`;
            document.getElementById('cardCounter').textContent = `${currentIndex + 1} / ${sessionCards.length}`;
        }

        function endVocabSessionEarly() {
            if (confirm('Er du sikker p√• at du vil avslutte √∏kten?')) endVocabSession();
        }

        function endVocabSession() {
            const duration = Math.round((new Date() - sessionStartTime) / 60000);
            const accuracy = sessionStats.reviewed > 0 ? Math.round((sessionStats.correct / sessionStats.reviewed) * 100) : 0;
            
            document.getElementById('flashcardArea').innerHTML = `
                <div class="session-complete">
                    <div class="emoji">üéâ</div>
                    <h2>√òkt fullf√∏rt!</h2>
                    <div class="session-stats-grid">
                        <div class="session-stat"><div class="session-stat-value">${sessionStats.reviewed}</div><div class="session-stat-label">Kort repetert</div></div>
                        <div class="session-stat"><div class="session-stat-value">${accuracy}%</div><div class="session-stat-label">N√∏yaktighet</div></div>
                        <div class="session-stat"><div class="session-stat-value">${duration}</div><div class="session-stat-label">Minutter</div></div>
                    </div>
                    ${sessionStats.newLearned > 0 ? `<p style="color: var(--success); font-weight: 600;">‚ú® Du l√¶rte ${sessionStats.newLearned} nye kort!</p>` : ''}
                </div>
            `;
            
            document.getElementById('buttonArea').innerHTML = `
                <div class="button-group">
                    <button class="btn btn-primary" onclick="startVocabSession()">‚ñ∂Ô∏è Start ny √∏kt</button>
                    <button class="btn btn-secondary" onclick="showPage('vocab')">‚Üê Tilbake</button>
                </div>
            `;
            
            updateStats();
        }

        // ============================================
        // BRAINMAP FUNCTIONS
        // ============================================

        function renderBrainmap() {
            const categories = getCategories();
            const themes = {
                'Grunnleggende': ['tall', 'farger', 'bursdag', 'klokka', 'tidsuttrykk'],
                'Mennesker': ['familie', 'familie-setninger', 'utseende', 'personlighet', 'yrker'],
                'Hverdagsliv': ['kl√¶r', 'hjem', 'm√∏bler', 'rutiner', 'hobbyer'],
                'Verden': ['land', 'v√¶r', 'h√∏ytider', 'skole', 'fag'],
                'Spr√•k': ['verb', 'verbb√∏ying', 'gustar', 'fremtid', 'bindeord']
            };
            
            document.getElementById('brainmapContent').innerHTML = Object.entries(themes).map(([theme, cats]) => `
                <div class="brainmap-level">
                    <div class="brainmap-level-header">
                        <span class="brainmap-level-title">${theme}</span>
                    </div>
                    <div class="brainmap-categories">
                        ${cats.filter(name => categories[name]).map(name => {
                            const data = categories[name];
                            const progress = (data.mastered / data.count) * 100;
                            return `
                                <div class="brainmap-category" onclick="selectCategoryAndStudy('${name}')">
                                    <div class="brainmap-category-name">${getCategoryEmoji(name)} ${capitalizeFirst(name)}</div>
                                    <div class="brainmap-category-progress">
                                        <div class="brainmap-category-progress-fill" style="width: ${progress}%"></div>
                                    </div>
                                    <div class="brainmap-category-stats">${data.mastered}/${data.count} mestret</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        }

        function selectCategoryAndStudy(category) {
            selectedCategories.clear();
            selectedCategories.add(category);
            showPage('vocab');
            populateCategories();
            startVocabSession();
        }

        // ============================================
        // VERB CONJUGATION FUNCTIONS
        // ============================================

        function renderVerbSelector() {
            const selector = document.getElementById('verbSelector');
            selector.innerHTML = Object.entries(verbDatabase).map(([key, verb]) => `
                <div class="verb-card ${selectedVerbs.has(key) ? 'selected' : ''}" onclick="toggleVerb('${key}')">
                    <div class="verb-infinitive">${verb.infinitive}</div>
                    <div class="verb-translation">${verb.translation}</div>
                    <span class="verb-type-badge">${verb.type}</span>
                </div>
            `).join('');
        }

        function toggleVerb(key) {
            if (selectedVerbs.has(key)) selectedVerbs.delete(key);
            else selectedVerbs.add(key);
            renderVerbSelector();
        }

        function selectAllVerbs() {
            Object.keys(verbDatabase).forEach(k => selectedVerbs.add(k));
            renderVerbSelector();
        }

        function deselectAllVerbs() {
            selectedVerbs.clear();
            renderVerbSelector();
        }

        function selectTense(tense) {
            selectedTense = tense;
            document.querySelectorAll('.tense-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tense' + capitalizeFirst(tense)).classList.add('active');
        }

        function startVerbSession() {
            if (selectedVerbs.size === 0) {
                alert('Velg minst ett verb!');
                return;
            }
            
            verbSessionExercises = [];
            verbAnswerPending = false;
            
            selectedVerbs.forEach(verbKey => {
                const verb = verbDatabase[verbKey];
                // Add exercises for each pronoun (skip vosotros for simplicity, index 4)
                [0, 1, 2, 3, 5].forEach(pronounIndex => {
                    verbSessionExercises.push({
                        verb: verb,
                        pronounIndex: pronounIndex,
                        tense: selectedTense
                    });
                });
            });
            
            // Shuffle and limit
            verbSessionExercises = shuffleArray(verbSessionExercises).slice(0, 20);
            verbCurrentIndex = 0;
            verbStats = { correct: 0, total: verbSessionExercises.length };
            
            document.getElementById('verbSettings').classList.add('hidden');
            document.getElementById('verbExercise').classList.remove('hidden');
            
            showVerbExercise();
        }

        function showVerbExercise() {
            if (verbCurrentIndex >= verbStats.total) {
                endVerbSession();
                return;
            }
            
            const exercise = verbSessionExercises[verbCurrentIndex];
            const verb = exercise.verb;
            const pronounIndex = exercise.pronounIndex;
            
            updateVerbProgress();
            
            let tenseDisplay, expectedAnswer;
            
            if (exercise.tense === 'presente') {
                tenseDisplay = 'Presens';
                expectedAnswer = verb.presente[pronounIndex];
            } else if (exercise.tense === 'futuro') {
                tenseDisplay = 'Fremtid (ir a + infinitiv)';
                const irForms = verbDatabase.ir.presente;
                expectedAnswer = irForms[pronounIndex] + ' a ' + verb.infinitive;
            } else if (exercise.tense === 'perfecto') {
                tenseDisplay = 'Presens perfektum';
                expectedAnswer = haberPresente[pronounIndex] + ' ' + verb.participio;
            }
            
            document.getElementById('verbExerciseArea').innerHTML = `
                <div class="conjugation-exercise">
                    <div class="conjugation-verb">${verb.infinitive}</div>
                    <div class="conjugation-translation">${verb.translation}</div>
                    <div class="conjugation-tense">${tenseDisplay}</div>
                    
                    <div class="conjugation-prompt">
                        <span class="pronoun">${pronouns[pronounIndex]}</span> + ${verb.infinitive}
                    </div>
                    
                    <div class="conjugation-input-container">
                        <input type="text" class="conjugation-input" id="verbInput" 
                               placeholder="Skriv svaret..." autocomplete="off" autofocus>
                    </div>
                    <div class="accent-hint">üí° Hold inne a/e/i/o/u/n for aksent, eller ?/! for ¬ø/¬°</div>
                    
                    <div class="conjugation-feedback" id="verbFeedback"></div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="checkVerbAnswer()">‚úì Sjekk svar</button>
                        <button class="btn btn-outline" onclick="showVerbHint()">üí° Hint</button>
                    </div>
                </div>
            `;
            
            const verbInput = document.getElementById('verbInput');
            verbInput.focus();
            verbInput.dataset.expected = expectedAnswer;
            setupAccentInput(verbInput);
        }

        function checkVerbAnswer() {
            if (verbAnswerPending) return; // Prevent multiple clicks
            
            const input = document.getElementById('verbInput');
            const expected = input.dataset.expected;
            const userAnswer = input.value.trim().toLowerCase();
            const expectedLower = expected.toLowerCase();
            
            const feedback = document.getElementById('verbFeedback');
            
            verbAnswerPending = true;
            
            if (userAnswer === expectedLower) {
                feedback.textContent = '‚úì Riktig!';
                feedback.className = 'conjugation-feedback correct';
                input.classList.add('correct');
                input.classList.remove('incorrect');
                verbStats.correct++;
                
                setTimeout(() => {
                    verbCurrentIndex++;
                    verbAnswerPending = false;
                    showVerbExercise();
                }, 1000);
            } else {
                feedback.innerHTML = `‚úó Riktig svar: <strong>${expected}</strong>`;
                feedback.className = 'conjugation-feedback incorrect';
                input.classList.add('incorrect');
                input.classList.remove('correct');
                
                // Show full conjugation table
                showConjugationTable();
                
                setTimeout(() => {
                    verbCurrentIndex++;
                    verbAnswerPending = false;
                    showVerbExercise();
                }, 3000);
            }
        }

        function showVerbHint() {
            const input = document.getElementById('verbInput');
            const expected = input.dataset.expected;
            const hint = expected.substring(0, Math.ceil(expected.length / 2)) + '...';
            document.getElementById('verbFeedback').textContent = `Hint: ${hint}`;
            document.getElementById('verbFeedback').className = 'conjugation-feedback';
        }

        function showConjugationTable() {
            const exercise = verbSessionExercises[verbCurrentIndex];
            const verb = exercise.verb;
            
            let forms;
            if (exercise.tense === 'presente') {
                forms = verb.presente;
            } else if (exercise.tense === 'futuro') {
                const irForms = verbDatabase.ir.presente;
                forms = irForms.map(f => f + ' a ' + verb.infinitive);
            } else {
                forms = haberPresente.map(f => f + ' ' + verb.participio);
            }
            
            const tableHTML = `
                <div class="conjugation-table">
                    <h4>Fullstendig b√∏ying:</h4>
                    <div class="conjugation-table-grid">
                        ${pronouns.map((p, i) => `
                            <div class="conjugation-table-row ${i === exercise.pronounIndex ? 'highlight' : ''}">
                                <span class="pronoun">${p}</span>
                                <span class="form">${forms[i]}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('verbExerciseArea').innerHTML += tableHTML;
        }

        function updateVerbProgress() {
            const total = verbStats.total;
            const progress = (verbCurrentIndex / total) * 100;
            document.getElementById('verbProgressFill').style.width = progress + '%';
            document.getElementById('verbSessionStats').textContent = `${verbStats.correct} / ${verbCurrentIndex} riktig`;
            document.getElementById('verbCounter').textContent = `${verbCurrentIndex + 1} / ${total}`;
        }

        function endVerbSession() {
            const accuracy = verbStats.total > 0 ? Math.round((verbStats.correct / verbStats.total) * 100) : 0;
            
            document.getElementById('verbExerciseArea').innerHTML = `
                <div class="session-complete">
                    <div class="emoji">${accuracy >= 80 ? 'üéâ' : accuracy >= 50 ? 'üëç' : 'üí™'}</div>
                    <h2>√òving fullf√∏rt!</h2>
                    <div class="session-stats-grid">
                        <div class="session-stat"><div class="session-stat-value">${verbStats.correct}</div><div class="session-stat-label">Riktige svar</div></div>
                        <div class="session-stat"><div class="session-stat-value">${verbStats.total}</div><div class="session-stat-label">Totalt</div></div>
                        <div class="session-stat"><div class="session-stat-value">${accuracy}%</div><div class="session-stat-label">N√∏yaktighet</div></div>
                    </div>
                    <p style="color: var(--gray-500); margin-top: 20px;">
                        ${accuracy >= 80 ? 'Fantastisk! Du mestrer verbb√∏yingene!' : 
                          accuracy >= 50 ? 'Bra jobbet! Fortsett √• √∏ve!' : 
                          'Ikke gi opp! √òvelse gj√∏r mester!'}
                    </p>
                </div>
            `;
            
            document.getElementById('verbExerciseArea').innerHTML += `
                <div class="button-group">
                    <button class="btn btn-primary" onclick="startVerbSession()">‚ñ∂Ô∏è √òv mer</button>
                    <button class="btn btn-secondary" onclick="showPage('verbs')">‚Üê Tilbake</button>
                </div>
            `;
        }

        // ============================================
        // IMPORT/EXPORT
        // ============================================

        function showStatistics() {
            const total = cards.length;
            const newCards = cards.filter(c => c.noEs.repetitions === 0 && c.esNo.repetitions === 0).length;
            const mastered = cards.filter(c => c.noEs.repetitions >= 3 && c.esNo.repetitions >= 3).length;
            const totalReviews = cards.reduce((sum, c) => sum + c.reviews, 0);
            const totalCorrect = cards.reduce((sum, c) => sum + c.correct, 0);
            const accuracy = totalReviews > 0 ? Math.round((totalCorrect / totalReviews) * 100) : 0;
            
            alert(`üìä STATISTIKK\n\nTotalt antall ord: ${total}\nNye ord: ${newCards}\nMestret: ${mastered}\n\nTotalt repetisjoner: ${totalReviews}\nN√∏yaktighet: ${accuracy}%`);
        }

        // ============================================
        // CUSTOM WORDS & TEACHER IMPORT
        // ============================================

        function updateCategoryDropdown() {
            const dropdown = document.getElementById('addWordCategory');
            if (!dropdown) return;
            
            const categories = [...new Set(cards.map(c => c.category))].sort();
            
            dropdown.innerHTML = '<option value="">Velg kategori...</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            // Update custom words count
            const customCount = cards.filter(c => c.isCustom).length;
            const countEl = document.getElementById('customWordsCount');
            if (countEl) {
                countEl.textContent = customCount > 0 ? `Du har lagt til ${customCount} egne gloser` : '';
            }
        }

        function addCustomWord() {
            const norskInput = document.getElementById('addWordNorsk');
            const spanskInput = document.getElementById('addWordSpansk');
            const categorySelect = document.getElementById('addWordCategory');
            const newCategoryInput = document.getElementById('addWordNewCategory');
            
            const norsk = norskInput.value.trim();
            const spansk = spanskInput.value.trim();
            let category = newCategoryInput.value.trim() || categorySelect.value;
            
            // Validation
            if (!norsk || !spansk) {
                showToast('Skriv inn b√•de norsk og spansk ord', 'error');
                return;
            }
            
            if (!category) {
                showToast('Velg eller skriv inn en kategori', 'error');
                return;
            }
            
            // Normalize category name
            category = category.toLowerCase().replace(/\s+/g, '-');
            
            // Check for duplicates
            const exists = cards.some(c => 
                c.norsk.toLowerCase() === norsk.toLowerCase() && 
                c.spansk.toLowerCase() === spansk.toLowerCase()
            );
            
            if (exists) {
                showToast('Denne glosen finnes allerede', 'error');
                return;
            }
            
            // Create new card
            const newCard = {
                norsk: norsk,
                spansk: spansk,
                category: category,
                isCustom: true,
                noEs: { repetitions: 0, easeFactor: 2.5, interval: 0, nextReview: 0 },
                esNo: { repetitions: 0, easeFactor: 2.5, interval: 0, nextReview: 0 },
                reviews: 0,
                correct: 0
            };
            
            cards.push(newCard);
            saveData();
            
            // Clear form
            norskInput.value = '';
            spanskInput.value = '';
            newCategoryInput.value = '';
            
            // Update UI
            updateCategoryDropdown();
            populateCategories();
            updateStats();
            
            showToast(`"${norsk}" lagt til i "${category}"`, 'success');
        }

        function importTeacherWords() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        let imported = 0;
                        let skipped = 0;
                        
                        // Support different formats
                        let wordsToImport = [];
                        
                        // Format 1: Array of [norsk, spansk, kategori]
                        if (Array.isArray(data) && Array.isArray(data[0])) {
                            wordsToImport = data.map(item => ({
                                norsk: item[0],
                                spansk: item[1],
                                category: item[2] || 'importert'
                            }));
                        }
                        // Format 2: { category: "...", words: [[norsk, spansk], ...] }
                        else if (data.category && Array.isArray(data.words)) {
                            wordsToImport = data.words.map(item => ({
                                norsk: item[0],
                                spansk: item[1],
                                category: data.category
                            }));
                        }
                        // Format 3: { words: [{ norsk, spansk, category }, ...] }
                        else if (data.words && Array.isArray(data.words)) {
                            wordsToImport = data.words;
                        }
                        // Format 4: Array of { norsk, spansk, category }
                        else if (Array.isArray(data) && data[0].norsk) {
                            wordsToImport = data;
                        }
                        else {
                            throw new Error('Ukjent filformat');
                        }
                        
                        // Import words
                        for (const word of wordsToImport) {
                            if (!word.norsk || !word.spansk) {
                                skipped++;
                                continue;
                            }
                            
                            // Check for duplicates
                            const exists = cards.some(c => 
                                c.norsk.toLowerCase() === word.norsk.toLowerCase() && 
                                c.spansk.toLowerCase() === word.spansk.toLowerCase()
                            );
                            
                            if (exists) {
                                skipped++;
                                continue;
                            }
                            
                            const category = (word.category || 'importert').toLowerCase().replace(/\s+/g, '-');
                            
                            cards.push({
                                norsk: word.norsk,
                                spansk: word.spansk,
                                category: category,
                                isCustom: true,
                                noEs: { repetitions: 0, easeFactor: 2.5, interval: 0, nextReview: 0 },
                                esNo: { repetitions: 0, easeFactor: 2.5, interval: 0, nextReview: 0 },
                                reviews: 0,
                                correct: 0
                            });
                            imported++;
                        }
                        
                        saveData();
                        updateCategoryDropdown();
                        populateCategories();
                        updateStats();
                        
                        if (imported > 0) {
                            showToast(`Importerte ${imported} gloser` + (skipped > 0 ? ` (${skipped} hoppet over)` : ''), 'success');
                        } else {
                            showToast(`Ingen nye gloser √• importere (${skipped} duplikater)`, 'error');
                        }
                        
                    } catch (error) {
                        console.error('Import error:', error);
                        showToast('Kunne ikke lese filen: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function showToast(message, type = 'info') {
            // Remove existing toast
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        function exportProgress() {
            const data = { cards, exportDate: new Date().toISOString(), version: 'spansk123_v4' };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `spansk_fremgang_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importProgress() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (!data.cards) { alert('Ugyldig fil!'); return; }
                        if (confirm(`Importere data? Dette vil overskrive n√•v√¶rende fremgang.`)) {
                            cards = data.cards;
                            mergeNewVocabulary();
                            saveData();
                            updateStats();
                            populateCategories();
                            alert('Import fullf√∏rt!');
                        }
                    } catch (err) { alert('Feil ved import: ' + err.message); }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ============================================
        // ACCENT INPUT HELPER (Long Press)
        // ============================================

        const accentMap = {
            'a': '√°', 'e': '√©', 'i': '√≠', 'o': '√≥', 'u': '√∫', 'n': '√±',
            'A': '√Å', 'E': '√â', 'I': '√ç', 'O': '√ì', 'U': '√ö', 'N': '√ë',
            '?': '¬ø', '!': '¬°'
        };

        let longPressTimer = null;

        function setupAccentInput(inputElement) {
            inputElement.addEventListener('keydown', (e) => {
                const key = e.key;
                
                if (!accentMap[key]) return;
                
                // Ignore key repeat
                if (e.repeat) {
                    e.preventDefault();
                    return;
                }
                
                // Clear any existing timer
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                
                // Let the character be typed normally (don't preventDefault)
                // But start a timer to replace it with accented version
                longPressTimer = setTimeout(() => {
                    // Replace the last character with accented version
                    const pos = inputElement.selectionStart;
                    if (pos > 0) {
                        const value = inputElement.value;
                        const lastChar = value.charAt(pos - 1);
                        // Only replace if it matches the key we pressed
                        if (lastChar.toLowerCase() === key.toLowerCase()) {
                            inputElement.value = value.substring(0, pos - 1) + accentMap[key] + value.substring(pos);
                            inputElement.selectionStart = inputElement.selectionEnd = pos;
                        }
                    }
                    longPressTimer = null;
                }, 400);
            });

            inputElement.addEventListener('keyup', (e) => {
                const key = e.key;
                
                if (!accentMap[key]) return;
                
                // Cancel the accent replacement if key released quickly
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            });
        }

        function insertCharacter(input, char) {
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const value = input.value;
            
            input.value = value.substring(0, start) + char + value.substring(end);
            input.selectionStart = input.selectionEnd = start + 1;
        }

        // ============================================
        // GRAMMAR MODE
        // ============================================

        const grammarTopics = {
            articles: {
                id: 'articles',
                name: 'Artikler',
                icon: 'üì∞',
                description: 'el, la, un, una, los, las',
                theory: {
                    title: 'Bestemt og ubestemt artikkel',
                    content: `
                        <p><strong>Ubestemt artikkel</strong> (en/ei/et):</p>
                        <ul>
                            <li><strong>un</strong> - maskulin entall (un libro = en bok)</li>
                            <li><strong>una</strong> - feminin entall (una casa = et hus)</li>
                        </ul>
                        
                        <p><strong>Bestemt artikkel</strong> (den/det/de):</p>
                        <ul>
                            <li><strong>el</strong> - maskulin entall (el libro = boken)</li>
                            <li><strong>la</strong> - feminin entall (la casa = huset)</li>
                            <li><strong>los</strong> - maskulin flertall (los libros = b√∏kene)</li>
                            <li><strong>las</strong> - feminin flertall (las casas = husene)</li>
                        </ul>
                        
                        <div class="rule">
                            <strong>Hovedregel:</strong> Ord som slutter p√• <strong>-o</strong> er vanligvis maskuline. 
                            Ord som slutter p√• <strong>-a</strong> er vanligvis feminine.
                        </div>
                        
                        <div class="example">
                            el libr<span class="correct">o</span> (maskulin) ‚Üí la mes<span class="correct">a</span> (feminin)
                        </div>
                        
                        <div class="exception">
                            <strong>Unntak √• huske:</strong> el d√≠a (dagen), el problema (problemet), 
                            el tema (temaet), la mano (h√•nden), la foto (bildet)
                        </div>
                    `
                },
                exercises: [
                    { sentence: "___ casa es grande", answer: "La", options: ["El", "La", "Un", "Una"], hint: "casa (hus) er feminin", word: "casa" },
                    { sentence: "___ libro es interesante", answer: "El", options: ["El", "La", "Los", "Las"], hint: "libro (bok) slutter p√• -o", word: "libro" },
                    { sentence: "Tengo ___ hermano", answer: "un", options: ["un", "una", "el", "la"], hint: "hermano (bror) er maskulin", word: "hermano" },
                    { sentence: "___ mesa est√° en la cocina", answer: "La", options: ["El", "La", "Un", "Una"], hint: "mesa (bord) slutter p√• -a", word: "mesa" },
                    { sentence: "Veo ___ perro en el parque", answer: "un", options: ["un", "una", "el", "la"], hint: "perro (hund) er maskulin", word: "perro" },
                    { sentence: "___ profesora es simp√°tica", answer: "La", options: ["El", "La", "Un", "Una"], hint: "profesora (l√¶rer) er feminin", word: "profesora" },
                    { sentence: "___ chicos juegan f√∫tbol", answer: "Los", options: ["El", "La", "Los", "Las"], hint: "chicos (gutter) er maskulin flertall", word: "chicos" },
                    { sentence: "___ sillas son rojas", answer: "Las", options: ["El", "La", "Los", "Las"], hint: "sillas (stoler) er feminin flertall", word: "sillas" },
                    { sentence: "Necesito ___ bol√≠grafo", answer: "un", options: ["un", "una", "el", "la"], hint: "bol√≠grafo (penn) er maskulin", word: "bol√≠grafo" },
                    { sentence: "___ d√≠a es bonito", answer: "El", options: ["El", "La", "Un", "Una"], hint: "d√≠a (dag) er UNNTAK - maskulin!", word: "d√≠a" },
                    { sentence: "___ problema es dif√≠cil", answer: "El", options: ["El", "La", "Un", "Una"], hint: "problema er UNNTAK - maskulin!", word: "problema" },
                    { sentence: "___ mano est√° fr√≠a", answer: "La", options: ["El", "La", "Un", "Una"], hint: "mano (h√•nd) er UNNTAK - feminin!", word: "mano" },
                    { sentence: "___ ventana est√° abierta", answer: "La", options: ["El", "La", "Los", "Las"], hint: "ventana (vindu) slutter p√• -a", word: "ventana" },
                    { sentence: "___ padres est√°n en casa", answer: "Los", options: ["El", "La", "Los", "Las"], hint: "padres (foreldre) er maskulin flertall", word: "padres" },
                    { sentence: "Tengo ___ gata negra", answer: "una", options: ["un", "una", "el", "la"], hint: "gata (katt, hunn) er feminin", word: "gata" },
                ]
            },
            
            adjectives: {
                id: 'adjectives',
                name: 'Adjektivsamsvar',
                icon: 'üé®',
                description: 'B√∏y adjektiv etter kj√∏nn og tall',
                theory: {
                    title: 'Adjektivsamsvar - kj√∏nn og tall',
                    content: `
                        <p>Adjektiv m√• samsvare med substantivet i <strong>kj√∏nn</strong> og <strong>tall</strong>.</p>
                        
                        <div class="rule">
                            <strong>Adjektiv som slutter p√• -o:</strong><br>
                            alto ‚Üí alta ‚Üí altos ‚Üí altas
                        </div>
                        
                        <div class="example">
                            El chico es alt<span class="correct">o</span> (gutten er h√∏y)<br>
                            La chica es alt<span class="correct">a</span> (jenta er h√∏y)<br>
                            Los chicos son alt<span class="correct">os</span> (guttene er h√∏ye)<br>
                            Las chicas son alt<span class="correct">as</span> (jentene er h√∏ye)
                        </div>
                        
                        <div class="rule">
                            <strong>Adjektiv som slutter p√• -e eller konsonant:</strong><br>
                            Samme form for maskulin og feminin!
                        </div>
                        
                        <div class="example">
                            El chico es inteligent<span class="correct">e</span><br>
                            La chica es inteligent<span class="correct">e</span><br>
                            Los chicos son inteligent<span class="correct">es</span><br>
                            Las chicas son inteligent<span class="correct">es</span>
                        </div>
                    `
                },
                exercises: [
                    { sentence: "La casa es muy ___", answer: "bonita", options: ["bonito", "bonita", "bonitos", "bonitas"], hint: "casa er feminin entall", base: "bonito" },
                    { sentence: "Los chicos son ___", answer: "altos", options: ["alto", "alta", "altos", "altas"], hint: "chicos er maskulin flertall", base: "alto" },
                    { sentence: "Mi hermana es muy ___", answer: "simp√°tica", options: ["simp√°tico", "simp√°tica", "simp√°ticos", "simp√°ticas"], hint: "hermana er feminin entall", base: "simp√°tico" },
                    { sentence: "Las flores son ___", answer: "rojas", options: ["rojo", "roja", "rojos", "rojas"], hint: "flores er feminin flertall", base: "rojo" },
                    { sentence: "El profesor es ___", answer: "inteligente", options: ["inteligente", "inteligenta", "inteligentes", "inteligento"], hint: "-e adjektiv er like for begge kj√∏nn", base: "inteligente" },
                    { sentence: "Las chicas son muy ___", answer: "inteligentes", options: ["inteligente", "inteligenta", "inteligentes", "inteligento"], hint: "flertall av -e adjektiv f√•r -es", base: "inteligente" },
                    { sentence: "Mi padre es ___", answer: "moreno", options: ["moreno", "morena", "morenos", "morenas"], hint: "padre er maskulin entall", base: "moreno" },
                    { sentence: "Las casas son ___", answer: "grandes", options: ["grande", "granda", "grandes", "grandas"], hint: "grande er likt for begge kj√∏nn", base: "grande" },
                    { sentence: "El perro es ___", answer: "peque√±o", options: ["peque√±o", "peque√±a", "peque√±os", "peque√±as"], hint: "perro er maskulin entall", base: "peque√±o" },
                    { sentence: "Mis abuelas son ___", answer: "viejas", options: ["viejo", "vieja", "viejos", "viejas"], hint: "abuelas er feminin flertall", base: "viejo" },
                    { sentence: "La comida est√° ___", answer: "rica", options: ["rico", "rica", "ricos", "ricas"], hint: "comida er feminin entall", base: "rico" },
                    { sentence: "Los libros son ___", answer: "interesantes", options: ["interesante", "interesanta", "interesantes", "interesantos"], hint: "-e adjektiv i flertall", base: "interesante" },
                ]
            },
            
            serEstar: {
                id: 'serEstar',
                name: 'Ser vs Estar',
                icon: '‚öñÔ∏è',
                description: 'N√•r bruker vi ser og estar?',
                theory: {
                    title: 'Ser vs Estar - to m√•ter √• si "√• v√¶re"',
                    content: `
                        <p>Spansk har to verb for "√• v√¶re": <strong>ser</strong> og <strong>estar</strong>.</p>
                        
                        <div class="rule">
                            <strong>SER brukes til:</strong>
                            <ul>
                                <li>Identitet: Soy Mar√≠a (Jeg er Mar√≠a)</li>
                                <li>Yrke: Soy profesor (Jeg er l√¶rer)</li>
                                <li>Nasjonalitet: Soy noruego (Jeg er norsk)</li>
                                <li>Permanente egenskaper: Soy alto (Jeg er h√∏y)</li>
                                <li>Tid: Son las tres (Klokken er tre)</li>
                            </ul>
                        </div>
                        
                        <div class="rule">
                            <strong>ESTAR brukes til:</strong>
                            <ul>
                                <li>Lokasjon: Estoy en casa (Jeg er hjemme)</li>
                                <li>Midlertidige tilstander: Estoy cansado (Jeg er sliten)</li>
                                <li>F√∏lelser: Estoy feliz (Jeg er glad)</li>
                                <li>Tilstand av ting: La puerta est√° abierta (D√∏ren er √•pen)</li>
                            </ul>
                        </div>
                        
                        <div class="example">
                            Mar√≠a <span class="correct">es</span> alta (permanent egenskap)<br>
                            Mar√≠a <span class="correct">est√°</span> cansada (midlertidig tilstand)
                        </div>
                    `
                },
                exercises: [
                    { sentence: "Yo ___ de Noruega", answer: "soy", options: ["soy", "estoy", "es", "est√°"], hint: "Nasjonalitet/opprinnelse = SER" },
                    { sentence: "Mi madre ___ en la cocina", answer: "est√°", options: ["es", "est√°", "son", "est√°n"], hint: "Lokasjon = ESTAR" },
                    { sentence: "Nosotros ___ estudiantes", answer: "somos", options: ["somos", "estamos", "son", "est√°n"], hint: "Identitet = SER" },
                    { sentence: "Hoy yo ___ muy cansado", answer: "estoy", options: ["soy", "estoy", "es", "est√°"], hint: "Midlertidig tilstand = ESTAR" },
                    { sentence: "Mi padre ___ profesor", answer: "es", options: ["es", "est√°", "soy", "estoy"], hint: "Yrke = SER" },
                    { sentence: "¬øD√≥nde ___ el ba√±o?", answer: "est√°", options: ["es", "est√°", "son", "est√°n"], hint: "Lokasjon = ESTAR" },
                    { sentence: "Ellos ___ muy simp√°ticos", answer: "son", options: ["son", "est√°n", "es", "est√°"], hint: "Permanent egenskap = SER" },
                    { sentence: "La ventana ___ abierta", answer: "est√°", options: ["es", "est√°", "son", "est√°n"], hint: "Tilstand = ESTAR" },
                    { sentence: "Hoy ___ lunes", answer: "es", options: ["es", "est√°", "soy", "estoy"], hint: "Dag/tid = SER" },
                    { sentence: "¬øC√≥mo ___ t√∫?", answer: "est√°s", options: ["eres", "est√°s", "es", "est√°"], hint: "Hvordan har du det (tilstand) = ESTAR" },
                    { sentence: "Mi hermano ___ alto y moreno", answer: "es", options: ["es", "est√°", "soy", "estoy"], hint: "Fysisk beskrivelse = SER" },
                    { sentence: "Los ni√±os ___ en el parque", answer: "est√°n", options: ["son", "est√°n", "es", "est√°"], hint: "Lokasjon = ESTAR" },
                    { sentence: "La fiesta ___ el s√°bado", answer: "es", options: ["es", "est√°", "son", "est√°n"], hint: "N√•r noe skjer = SER" },
                    { sentence: "Yo ___ muy feliz hoy", answer: "estoy", options: ["soy", "estoy", "es", "est√°"], hint: "F√∏lelse (midlertidig) = ESTAR" },
                ]
            },
            
            gustar: {
                id: 'gustar',
                name: 'Gustar',
                icon: '‚ù§Ô∏è',
                description: '√Ö like noe p√• spansk',
                theory: {
                    title: 'Gustar - √• uttrykke hva du liker',
                    content: `
                        <p>P√• spansk sier vi ikke "jeg liker", men "det behager meg".</p>
                        
                        <div class="rule">
                            <strong>Struktur:</strong><br>
                            [pronomen] + gusta + entall substantiv/verb<br>
                            [pronomen] + gustan + flertall substantiv
                        </div>
                        
                        <div class="example">
                            <strong>Me</strong> gusta el f√∫tbol (Jeg liker fotball)<br>
                            <strong>Me</strong> gustan los libros (Jeg liker b√∏ker)<br>
                            <strong>Me</strong> gusta bailar (Jeg liker √• danse)
                        </div>
                        
                        <div class="rule">
                            <strong>Pronomenene:</strong>
                            <ul>
                                <li><strong>me</strong> - jeg liker</li>
                                <li><strong>te</strong> - du liker</li>
                                <li><strong>le</strong> - han/hun liker</li>
                                <li><strong>nos</strong> - vi liker</li>
                                <li><strong>les</strong> - de liker</li>
                            </ul>
                        </div>
                        
                        <div class="example">
                            ¬ø<span class="correct">Te</span> gusta la m√∫sica? (Liker du musikk?)<br>
                            A mi madre <span class="correct">le</span> gustan las flores (Mamma liker blomster)
                        </div>
                    `
                },
                exercises: [
                    { sentence: "___ gusta el chocolate", answer: "Me", options: ["Me", "Te", "Le", "Nos"], hint: "Jeg liker..." },
                    { sentence: "Me ___ los videojuegos", answer: "gustan", options: ["gusta", "gustan", "gustas", "gusto"], hint: "videojuegos er flertall" },
                    { sentence: "¬ø___ gusta bailar?", answer: "Te", options: ["Me", "Te", "Le", "Se"], hint: "Liker du...?" },
                    { sentence: "A mi hermano ___ gusta el f√∫tbol", answer: "le", options: ["me", "te", "le", "nos"], hint: "Han liker..." },
                    { sentence: "Me ___ escuchar m√∫sica", answer: "gusta", options: ["gusta", "gustan", "gustas", "gusto"], hint: "Infinitiv = gusta (entall)" },
                    { sentence: "___ gustan las pel√≠culas de terror", answer: "Nos", options: ["Me", "Te", "Le", "Nos"], hint: "Vi liker..." },
                    { sentence: "A Mar√≠a ___ gustan los gatos", answer: "le", options: ["me", "te", "le", "les"], hint: "Hun liker..." },
                    { sentence: "¬øTe ___ la pizza?", answer: "gusta", options: ["gusta", "gustan", "gustas", "gusto"], hint: "pizza er entall" },
                    { sentence: "A mis padres ___ gusta viajar", answer: "les", options: ["le", "les", "nos", "me"], hint: "De liker... (flertall)" },
                    { sentence: "No me ___ las verduras", answer: "gustan", options: ["gusta", "gustan", "gustas", "gusto"], hint: "verduras er flertall" },
                    { sentence: "___ gusta mucho esta canci√≥n", answer: "Me", options: ["Me", "Mi", "Yo", "M√≠"], hint: "Jeg liker..." },
                    { sentence: "A ella ___ gustan los perros", answer: "le", options: ["le", "la", "les", "lo"], hint: "Hun liker..." },
                ]
            },
            
            reflexive: {
                id: 'reflexive',
                name: 'Refleksive pronomen',
                icon: 'ü™û',
                description: 'me, te, se, nos - daglige rutiner',
                theory: {
                    title: 'Refleksive verb og pronomen',
                    content: `
                        <p>Refleksive verb beskriver handlinger du gj√∏r med deg selv, som √• vaske seg, kle p√• seg, osv.</p>
                        
                        <div class="rule">
                            <strong>Refleksive pronomen:</strong>
                            <ul>
                                <li><strong>me</strong> - meg (yo)</li>
                                <li><strong>te</strong> - deg (t√∫)</li>
                                <li><strong>se</strong> - seg (√©l/ella/usted)</li>
                                <li><strong>nos</strong> - oss (nosotros)</li>
                                <li><strong>se</strong> - seg (ellos/ellas/ustedes)</li>
                            </ul>
                        </div>
                        
                        <div class="example">
                            <strong>Me</strong> levanto a las siete (Jeg st√•r opp kl. 7)<br>
                            <strong>Te</strong> duchas por la ma√±ana (Du dusjer om morgenen)<br>
                            <strong>Se</strong> llama Mar√≠a (Hun heter Mar√≠a)
                        </div>
                        
                        <div class="rule">
                            <strong>Vanlige refleksive verb:</strong><br>
                            levantarse (st√• opp), ducharse (dusje), vestirse (kle p√• seg), 
                            acostarse (legge seg), llamarse (hete), peinarse (gre seg)
                        </div>
                    `
                },
                exercises: [
                    { sentence: "___ levanto a las siete", answer: "Me", options: ["Me", "Te", "Se", "Nos"], hint: "Jeg st√•r opp..." },
                    { sentence: "Mi hermana ___ ducha por la ma√±ana", answer: "se", options: ["me", "te", "se", "nos"], hint: "Hun dusjer..." },
                    { sentence: "¬øC√≥mo ___ llamas?", answer: "te", options: ["me", "te", "se", "nos"], hint: "Hva heter du?" },
                    { sentence: "Nosotros ___ acostamos a las diez", answer: "nos", options: ["me", "te", "se", "nos"], hint: "Vi legger oss..." },
                    { sentence: "___ visto r√°pidamente", answer: "Me", options: ["Me", "Te", "Se", "Nos"], hint: "Jeg kler p√• meg..." },
                    { sentence: "Ella ___ maquilla todos los d√≠as", answer: "se", options: ["me", "te", "se", "nos"], hint: "Hun sminker seg..." },
                    { sentence: "¬øA qu√© hora ___ despiertas?", answer: "te", options: ["me", "te", "se", "nos"], hint: "N√•r v√•kner du?" },
                    { sentence: "Los ni√±os ___ lavan las manos", answer: "se", options: ["me", "te", "se", "nos"], hint: "De vasker seg..." },
                    { sentence: "___ peino antes de salir", answer: "Me", options: ["Me", "Te", "Se", "Nos"], hint: "Jeg grer meg..." },
                    { sentence: "Mi padre ___ afeita cada ma√±ana", answer: "se", options: ["me", "te", "se", "nos"], hint: "Han barberer seg..." },
                    { sentence: "¬ø___ cepillas los dientes?", answer: "Te", options: ["Me", "Te", "Se", "Nos"], hint: "Pusser du tennene?" },
                    { sentence: "Ellos ___ despiertan temprano", answer: "se", options: ["me", "te", "se", "nos"], hint: "De v√•kner..." },
                ]
            },
            
            demonstratives: {
                id: 'demonstratives',
                name: 'Pekende adjektiv',
                icon: 'üëÜ',
                description: 'este/ese - denne/den der',
                theory: {
                    title: 'Demonstrative adjektiver - dette/det der',
                    content: `
                        <p>Pekende adjektiv viser til noe n√¶rt eller fjernt.</p>
                        
                        <div class="rule">
                            <strong>ESTE/ESTA (denne, dette) - n√¶r deg:</strong>
                            <ul>
                                <li><strong>este</strong> - maskulin entall (este libro = denne boken)</li>
                                <li><strong>esta</strong> - feminin entall (esta casa = dette huset)</li>
                                <li><strong>estos</strong> - maskulin flertall (estos libros)</li>
                                <li><strong>estas</strong> - feminin flertall (estas casas)</li>
                            </ul>
                        </div>
                        
                        <div class="rule">
                            <strong>ESE/ESA (den, den der) - lenger unna:</strong>
                            <ul>
                                <li><strong>ese</strong> - maskulin entall (ese libro = den boken)</li>
                                <li><strong>esa</strong> - feminin entall (esa casa = det huset)</li>
                                <li><strong>esos</strong> - maskulin flertall (esos libros)</li>
                                <li><strong>esas</strong> - feminin flertall (esas casas)</li>
                            </ul>
                        </div>
                        
                        <div class="example">
                            <span class="correct">Este</span> libro es interesante (denne boken - jeg holder den)<br>
                            <span class="correct">Ese</span> libro es interesante (den boken - p√• bordet der borte)
                        </div>
                    `
                },
                exercises: [
                    { sentence: "___ libro es muy interesante", answer: "Este", options: ["Este", "Esta", "Estos", "Estas"], hint: "libro er maskulin entall, n√¶r" },
                    { sentence: "___ casa es grande", answer: "Esta", options: ["Este", "Esta", "Ese", "Esa"], hint: "casa er feminin entall, n√¶r" },
                    { sentence: "___ chicos son mis amigos", answer: "Estos", options: ["Este", "Estos", "Ese", "Esos"], hint: "chicos er maskulin flertall, n√¶r" },
                    { sentence: "___ flores son bonitas", answer: "Estas", options: ["Esta", "Estas", "Esa", "Esas"], hint: "flores er feminin flertall, n√¶r" },
                    { sentence: "¬øQu√© es ___ (der borte)?", answer: "eso", options: ["esto", "eso", "este", "ese"], hint: "n√∏ytralt, lenger unna" },
                    { sentence: "___ coche (der borte) es de mi padre", answer: "Ese", options: ["Este", "Esta", "Ese", "Esa"], hint: "coche er maskulin, lenger unna" },
                    { sentence: "___ mesa (der borte) est√° ocupada", answer: "Esa", options: ["Esta", "Esa", "Este", "Ese"], hint: "mesa er feminin, lenger unna" },
                    { sentence: "___ zapatos son nuevos", answer: "Estos", options: ["Este", "Estos", "Estas", "Esos"], hint: "zapatos er maskulin flertall, n√¶r" },
                    { sentence: "___ pel√≠culas (der borte) son aburridas", answer: "Esas", options: ["Estas", "Esas", "Estos", "Esos"], hint: "pel√≠culas er feminin flertall, lenger unna" },
                    { sentence: "Me gusta ___ canci√≥n", answer: "esta", options: ["este", "esta", "ese", "esa"], hint: "canci√≥n er feminin, n√¶r" },
                    { sentence: "___ perros (der borte) son grandes", answer: "Esos", options: ["Estos", "Estas", "Esos", "Esas"], hint: "perros er maskulin flertall, lenger unna" },
                    { sentence: "¬øQui√©n es ___ chica?", answer: "esta", options: ["este", "esta", "ese", "esa"], hint: "chica er feminin, n√¶r" },
                ]
            },
            
            possessives: {
                id: 'possessives',
                name: 'Eiendomsord',
                icon: 'üè†',
                description: 'mi/tu/su - min/din/hans',
                theory: {
                    title: 'Possessive adjektiver - eiendomsord',
                    content: `
                        <p>Eiendomsord viser hvem noe tilh√∏rer.</p>
                        
                        <div class="rule">
                            <strong>Entall (√©n ting):</strong>
                            <ul>
                                <li><strong>mi</strong> - min/mitt (mi libro, mi casa)</li>
                                <li><strong>tu</strong> - din/ditt (tu libro, tu casa)</li>
                                <li><strong>su</strong> - hans/hennes/deres (su libro)</li>
                                <li><strong>nuestro/nuestra</strong> - v√•r/v√•rt</li>
                            </ul>
                        </div>
                        
                        <div class="rule">
                            <strong>Flertall (flere ting):</strong>
                            <ul>
                                <li><strong>mis</strong> - mine (mis libros, mis casas)</li>
                                <li><strong>tus</strong> - dine (tus libros)</li>
                                <li><strong>sus</strong> - hans/hennes/deres (sus libros)</li>
                                <li><strong>nuestros/nuestras</strong> - v√•re</li>
                            </ul>
                        </div>
                        
                        <div class="example">
                            <span class="correct">Mi</span> hermano (min bror) ‚Üí <span class="correct">Mis</span> hermanos (mine br√∏dre)<br>
                            <span class="correct">Tu</span> casa (ditt hus) ‚Üí <span class="correct">Tus</span> casas (dine hus)
                        </div>
                        
                        <div class="exception">
                            <strong>OBS!</strong> nuestro/nuestra b√∏yes etter kj√∏nn:<br>
                            nuestro padre (v√•r far) / nuestra madre (v√•r mor)
                        </div>
                    `
                },
                exercises: [
                    { sentence: "___ hermano se llama Pedro", answer: "Mi", options: ["Mi", "Mis", "Tu", "Tus"], hint: "hermano er entall - min" },
                    { sentence: "___ padres est√°n en casa", answer: "Mis", options: ["Mi", "Mis", "Tu", "Tus"], hint: "padres er flertall - mine" },
                    { sentence: "¬øD√≥nde est√° ___ libro?", answer: "tu", options: ["mi", "tu", "su", "tus"], hint: "libro er entall - din" },
                    { sentence: "Ella vive con ___ familia", answer: "su", options: ["mi", "tu", "su", "sus"], hint: "familia er entall - hennes" },
                    { sentence: "___ abuelos son muy simp√°ticos", answer: "Mis", options: ["Mi", "Mis", "Su", "Sus"], hint: "abuelos er flertall - mine" },
                    { sentence: "¬øC√≥mo se llaman ___ hermanas?", answer: "tus", options: ["tu", "tus", "su", "sus"], hint: "hermanas er flertall - dine" },
                    { sentence: "___ madre es profesora", answer: "Nuestra", options: ["Nuestro", "Nuestra", "Nuestros", "Nuestras"], hint: "madre er feminin - v√•r" },
                    { sentence: "___ padre trabaja en un banco", answer: "Nuestro", options: ["Nuestro", "Nuestra", "Nuestros", "Nuestras"], hint: "padre er maskulin - v√•r" },
                    { sentence: "Ellos quieren ___ dinero", answer: "su", options: ["mi", "tu", "su", "sus"], hint: "dinero er entall - deres" },
                    { sentence: "___ amigos vienen ma√±ana", answer: "Sus", options: ["Su", "Sus", "Mi", "Mis"], hint: "amigos er flertall - hennes/hans" },
                    { sentence: "Me gusta ___ casa", answer: "tu", options: ["mi", "tu", "su", "tus"], hint: "casa er entall - din" },
                    { sentence: "___ hijos son muy inteligentes", answer: "Nuestros", options: ["Nuestro", "Nuestra", "Nuestros", "Nuestras"], hint: "hijos er maskulin flertall - v√•re" },
                    { sentence: "¬øD√≥nde est√°n ___ llaves?", answer: "mis", options: ["mi", "mis", "tu", "tus"], hint: "llaves er flertall - mine" },
                    { sentence: "___ profesora es muy buena", answer: "Nuestra", options: ["Nuestro", "Nuestra", "Nuestros", "Nuestras"], hint: "profesora er feminin - v√•r" },
                ]
            }
        };

        // Grammar state
        let grammarProgress = {};
        let currentGrammarTopic = null;
        let grammarExercises = [];
        let grammarCurrentIndex = 0;
        let grammarStats = { correct: 0, total: 0, errors: 0 };
        let hasSeenTheory = {};
        let showingTheory = false;

        function loadGrammarProgress() {
            const saved = localStorage.getItem('spansk123Grammar_v1');
            if (saved) {
                const data = JSON.parse(saved);
                grammarProgress = data.progress || {};
                hasSeenTheory = data.hasSeenTheory || {};
            }
        }

        function saveGrammarProgress() {
            localStorage.setItem('spansk123Grammar_v1', JSON.stringify({
                progress: grammarProgress,
                hasSeenTheory: hasSeenTheory
            }));
            scheduleSyncToServer();
        }

        function renderGrammarTopics() {
            loadGrammarProgress();
            const grid = document.getElementById('grammarTopicGrid');
            
            grid.innerHTML = Object.values(grammarTopics).map(topic => {
                const progress = grammarProgress[topic.id] || { correct: 0, total: 0 };
                const percentage = progress.total > 0 ? Math.round((progress.correct / progress.total) * 100) : 0;
                const mastered = percentage >= 80 && progress.total >= 10;
                
                return `
                    <div class="grammar-topic-card" onclick="startGrammarTopic('${topic.id}')">
                        ${mastered ? '<span class="grammar-mastery-badge">‚≠ê</span>' : ''}
                        <div class="grammar-topic-icon">${topic.icon}</div>
                        <div class="grammar-topic-name">${topic.name}</div>
                        <div class="grammar-topic-desc">${topic.description}</div>
                        <div class="grammar-topic-progress">
                            <div class="grammar-topic-progress-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="grammar-topic-stats">
                            ${progress.total > 0 ? `${percentage}% riktig (${progress.total} √∏velser)` : 'Ikke startet'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function startGrammarTopic(topicId) {
            loadGrammarProgress();
            currentGrammarTopic = grammarTopics[topicId];
            
            // Check if should show theory
            const progress = grammarProgress[topicId] || { correct: 0, total: 0, recentErrors: 0 };
            const shouldShowTheory = !hasSeenTheory[topicId] || progress.recentErrors >= 3;
            
            if (shouldShowTheory) {
                showGrammarTheory();
            } else {
                startGrammarExercises();
            }
        }

        function showGrammarTheory() {
            showingTheory = true;
            document.getElementById('grammarSettings').classList.add('hidden');
            document.getElementById('grammarExercise').classList.remove('hidden');
            
            const topic = currentGrammarTopic;
            
            document.getElementById('grammarTheoryArea').innerHTML = `
                <div class="theory-card">
                    <h3>üìö ${topic.theory.title}</h3>
                    ${topic.theory.content}
                </div>
            `;
            
            document.getElementById('grammarExerciseArea').innerHTML = `
                <div class="button-group">
                    <button class="btn btn-primary" onclick="startGrammarExercises()">‚ñ∂Ô∏è Start √∏velser</button>
                </div>
            `;
            
            // Update progress bar
            document.getElementById('grammarProgressFill').style.width = '0%';
            document.getElementById('grammarSessionStats').textContent = 'Teori';
            document.getElementById('grammarCounter').textContent = '';
            
            hasSeenTheory[currentGrammarTopic.id] = true;
            saveGrammarProgress();
        }

        function startGrammarExercises() {
            showingTheory = false;
            document.getElementById('grammarSettings').classList.add('hidden');
            document.getElementById('grammarExercise').classList.remove('hidden');
            document.getElementById('grammarTheoryArea').innerHTML = '';
            
            // Shuffle and pick exercises
            grammarExercises = shuffleArray([...currentGrammarTopic.exercises]).slice(0, 10);
            grammarCurrentIndex = 0;
            grammarStats = { correct: 0, total: grammarExercises.length, errors: 0 };
            
            // Reset recent errors for this topic
            if (!grammarProgress[currentGrammarTopic.id]) {
                grammarProgress[currentGrammarTopic.id] = { correct: 0, total: 0, recentErrors: 0 };
            }
            grammarProgress[currentGrammarTopic.id].recentErrors = 0;
            saveGrammarProgress();
            
            showGrammarExercise();
        }

        function showGrammarExercise() {
            if (grammarCurrentIndex >= grammarExercises.length) {
                endGrammarSession();
                return;
            }
            
            const exercise = grammarExercises[grammarCurrentIndex];
            updateGrammarProgress();
            
            // Create sentence with blank
            const sentenceHTML = exercise.sentence.replace('___', '<span class="blank">______</span>');
            
            // Shuffle options
            const shuffledOptions = shuffleArray([...exercise.options]);
            
            document.getElementById('grammarExerciseArea').innerHTML = `
                <div class="grammar-exercise">
                    <div class="grammar-sentence">${sentenceHTML}</div>
                    
                    <div class="grammar-options">
                        ${shuffledOptions.map(opt => `
                            <button class="grammar-option" onclick="selectGrammarAnswer('${opt}', this)">
                                ${opt}
                            </button>
                        `).join('')}
                    </div>
                    
                    <button class="grammar-hint-btn" onclick="showGrammarHint()">üí° Vis hint</button>
                    
                    <div class="grammar-feedback" id="grammarFeedback"></div>
                </div>
            `;
        }

        function selectGrammarAnswer(answer, buttonElement) {
            const exercise = grammarExercises[grammarCurrentIndex];
            const isCorrect = answer.toLowerCase() === exercise.answer.toLowerCase();
            
            // Disable all buttons
            document.querySelectorAll('.grammar-option').forEach(btn => {
                btn.classList.add('disabled');
                if (btn.textContent.trim().toLowerCase() === exercise.answer.toLowerCase()) {
                    btn.classList.add('correct');
                }
            });
            
            if (isCorrect) {
                buttonElement.classList.add('correct');
                grammarStats.correct++;
                
                document.getElementById('grammarFeedback').innerHTML = `
                    <div class="grammar-feedback correct">
                        ‚úì Riktig!
                    </div>
                `;
            } else {
                buttonElement.classList.add('incorrect');
                grammarStats.errors++;
                grammarProgress[currentGrammarTopic.id].recentErrors++;
                
                document.getElementById('grammarFeedback').innerHTML = `
                    <div class="grammar-feedback incorrect">
                        ‚úó Feil! Riktig svar er: <strong>${exercise.answer}</strong>
                        <div class="explanation">${exercise.hint}</div>
                    </div>
                `;
            }
            
            // Update overall progress
            grammarProgress[currentGrammarTopic.id].total++;
            if (isCorrect) grammarProgress[currentGrammarTopic.id].correct++;
            saveGrammarProgress();
            
            // Move to next after delay
            setTimeout(() => {
                grammarCurrentIndex++;
                showGrammarExercise();
            }, isCorrect ? 1000 : 2500);
        }

        function showGrammarHint() {
            const exercise = grammarExercises[grammarCurrentIndex];
            document.getElementById('grammarFeedback').innerHTML = `
                <div class="grammar-feedback" style="background: #fef3c7; color: #92400e;">
                    üí° ${exercise.hint}
                </div>
            `;
        }

        function updateGrammarProgress() {
            const progress = (grammarCurrentIndex / grammarExercises.length) * 100;
            document.getElementById('grammarProgressFill').style.width = progress + '%';
            document.getElementById('grammarSessionStats').textContent = `${grammarStats.correct} / ${grammarCurrentIndex} riktig`;
            document.getElementById('grammarCounter').textContent = `${grammarCurrentIndex + 1} / ${grammarExercises.length}`;
        }

        function endGrammarSession() {
            const accuracy = grammarStats.total > 0 ? Math.round((grammarStats.correct / grammarStats.total) * 100) : 0;
            const needsMorePractice = accuracy < 70 || grammarStats.errors >= 3;
            
            document.getElementById('grammarExerciseArea').innerHTML = `
                <div class="session-complete">
                    <div class="emoji">${accuracy >= 80 ? 'üéâ' : accuracy >= 60 ? 'üëç' : 'üí™'}</div>
                    <h2>${currentGrammarTopic.name} fullf√∏rt!</h2>
                    <div class="session-stats-grid">
                        <div class="session-stat">
                            <div class="session-stat-value">${grammarStats.correct}</div>
                            <div class="session-stat-label">Riktige</div>
                        </div>
                        <div class="session-stat">
                            <div class="session-stat-value">${grammarStats.total}</div>
                            <div class="session-stat-label">Totalt</div>
                        </div>
                        <div class="session-stat">
                            <div class="session-stat-value">${accuracy}%</div>
                            <div class="session-stat-label">N√∏yaktighet</div>
                        </div>
                    </div>
                    ${needsMorePractice ? `
                        <p style="color: var(--warning); margin-bottom: 20px;">
                            üí° Tips: Se gjennom teorien og pr√∏v igjen!
                        </p>
                    ` : `
                        <p style="color: var(--success); margin-bottom: 20px;">
                            ‚≠ê Flott jobbet! Du mestrer dette temaet!
                        </p>
                    `}
                </div>
                <div class="button-group">
                    ${needsMorePractice ? `
                        <button class="btn btn-warning" onclick="showGrammarTheory()">üìö Se teori igjen</button>
                    ` : ''}
                    <button class="btn btn-primary" onclick="startGrammarExercises()">üîÑ √òv mer</button>
                    <button class="btn btn-secondary" onclick="showPage('grammar')">‚Üê Velg tema</button>
                </div>
            `;
        }

        function returnToGrammarTopics() {
            document.getElementById('grammarSettings').classList.remove('hidden');
            document.getElementById('grammarExercise').classList.add('hidden');
            renderGrammarTopics();
        }

        // ============================================
        // TEACHER DASHBOARD FUNCTIONS
        // ============================================

        async function loadTeacherDashboard() {
            if (isOfflineMode || !currentUser || !currentUser.is_teacher) return;
            
            try {
                // Check if teacher has a class
                const classResponse = await fetch(
                    `${SUPABASE_URL}/rest/v1/classes?teacher_code=eq.${encodeURIComponent(currentUser.code)}&select=*`,
                    { headers: supabaseHeaders }
                );
                
                if (!classResponse.ok) throw new Error('Could not load classes');
                
                const classes = await classResponse.json();
                
                if (classes.length === 0) {
                    // Show create class view
                    document.getElementById('noClassView').classList.remove('hidden');
                    document.getElementById('classDashboardView').classList.add('hidden');
                } else {
                    // Show dashboard with class info
                    currentClass = classes[0];
                    document.getElementById('noClassView').classList.add('hidden');
                    document.getElementById('classDashboardView').classList.remove('hidden');
                    
                    document.getElementById('dashboardClassName').textContent = currentClass.name;
                    document.getElementById('dashboardClassCode').textContent = currentClass.class_code;
                    
                    // Load students
                    await loadClassStudents();
                }
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function createClass() {
            const nameInput = document.getElementById('newClassName');
            const name = nameInput.value.trim();
            
            if (!name) {
                showToast('Skriv inn et klassenavn', 'error');
                return;
            }
            
            const classCode = generateCode();
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/classes`, {
                    method: 'POST',
                    headers: supabaseHeaders,
                    body: JSON.stringify({
                        class_code: classCode,
                        name: name,
                        teacher_code: currentUser.code
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Could not create class');
                }
                
                showToast(`Klasse opprettet! Kode: ${classCode}`, 'success');
                nameInput.value = '';
                
                // Reload dashboard
                await loadTeacherDashboard();
                
            } catch (error) {
                console.error('Error creating class:', error);
                showToast('Kunne ikke opprette klasse: ' + error.message, 'error');
            }
        }

        async function loadClassStudents() {
            if (!currentClass) return;
            
            try {
                // Get class members
                const membersResponse = await fetch(
                    `${SUPABASE_URL}/rest/v1/class_members?class_id=eq.${currentClass.id}&select=student_code,joined_at`,
                    { headers: supabaseHeaders }
                );
                
                if (!membersResponse.ok) throw new Error('Could not load members');
                
                const members = await membersResponse.json();
                
                if (members.length === 0) {
                    document.getElementById('studentsTableBody').innerHTML = `
                        <tr><td colspan="4" style="text-align: center; color: var(--gray-500);">
                            Ingen elever har blitt med enn√•. Del koden: <strong>${currentClass.class_code}</strong>
                        </td></tr>
                    `;
                    updateDashboardStats([], 0);
                    return;
                }
                
                // Get student details
                const studentCodes = members.map(m => m.student_code);
                const studentsResponse = await fetch(
                    `${SUPABASE_URL}/rest/v1/user_progress?code=in.(${studentCodes.map(c => `"${c}"`).join(',')})&select=*`,
                    { headers: supabaseHeaders }
                );
                
                if (!studentsResponse.ok) throw new Error('Could not load students');
                
                const students = await studentsResponse.json();
                
                // Render students table
                renderStudentsTable(students);
                updateDashboardStats(students, members.length);
                
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        function renderStudentsTable(students) {
            const tbody = document.getElementById('studentsTableBody');
            const now = new Date();
            
            tbody.innerHTML = students.map(student => {
                // Calculate progress
                const vocabData = student.vocab_data || {};
                const grammarData = student.grammar_data || {};
                
                let vocabProgress = 0;
                let grammarProgress = 0;
                
                // Simple progress calculation
                if (typeof vocabData === 'object' && Array.isArray(vocabData)) {
                    const reviewed = vocabData.filter(c => c.reviews > 0).length;
                    vocabProgress = vocabData.length > 0 ? Math.round((reviewed / vocabData.length) * 100) : 0;
                }
                
                if (grammarData.progress) {
                    const topics = Object.values(grammarData.progress);
                    if (topics.length > 0) {
                        const avgCorrect = topics.reduce((sum, t) => sum + (t.total > 0 ? t.correct / t.total : 0), 0) / topics.length;
                        grammarProgress = Math.round(avgCorrect * 100);
                    }
                }
                
                // Activity badge
                const updatedAt = new Date(student.updated_at);
                const daysSince = Math.floor((now - updatedAt) / (1000 * 60 * 60 * 24));
                let activityClass = 'recent';
                let activityText = 'I dag';
                
                if (daysSince === 1) {
                    activityText = 'I g√•r';
                } else if (daysSince > 1 && daysSince <= 7) {
                    activityText = `${daysSince} dager`;
                    activityClass = 'old';
                } else if (daysSince > 7) {
                    activityText = `${daysSince} dager`;
                    activityClass = 'inactive';
                }
                
                return `
                    <tr>
                        <td><strong>${student.display_name || 'Ukjent'}</strong></td>
                        <td><code style="background: var(--gray-100); padding: 2px 6px; border-radius: 4px;">${student.code}</code></td>
                        <td>
                            <div class="progress-mini">
                                <div class="progress-mini-fill" style="width: ${vocabProgress}%"></div>
                            </div>
                            ${vocabProgress}%
                        </td>
                        <td>
                            <div class="progress-mini">
                                <div class="progress-mini-fill" style="width: ${grammarProgress}%"></div>
                            </div>
                            ${grammarProgress}%
                        </td>
                        <td><span class="activity-badge ${activityClass}">${activityText}</span></td>
                        <td><button class="btn btn-sm btn-outline" onclick="resetStudentCode('${student.code}')" title="Gi ny kode">üîÑ</button></td>
                    </tr>
                `;
            }).join('');
        }

        async function resetStudentCode(oldCode) {
            const student = await getStudentByCode(oldCode);
            if (!student) {
                showToast('Fant ikke eleven', 'error');
                return;
            }
            
            const newCode = generateCode();
            
            if (!confirm(`Gi ${student.display_name || 'eleven'} ny kode?\n\nGammel: ${oldCode}\nNy: ${newCode}`)) {
                return;
            }
            
            try {
                // Create new user with same data but new code
                const response = await fetch(`${SUPABASE_URL}/rest/v1/user_progress`, {
                    method: 'POST',
                    headers: supabaseHeaders,
                    body: JSON.stringify({
                        code: newCode,
                        display_name: student.display_name,
                        is_teacher: false,
                        vocab_data: student.vocab_data || {},
                        grammar_data: student.grammar_data || {},
                        verb_data: student.verb_data || {}
                    })
                });
                
                if (!response.ok) throw new Error('Kunne ikke opprette ny bruker');
                
                // Update class membership
                if (currentClass) {
                    await fetch(`${SUPABASE_URL}/rest/v1/class_members?student_code=eq.${encodeURIComponent(oldCode)}`, {
                        method: 'PATCH',
                        headers: supabaseHeaders,
                        body: JSON.stringify({ student_code: newCode })
                    });
                }
                
                // Delete old user
                await fetch(`${SUPABASE_URL}/rest/v1/user_progress?code=eq.${encodeURIComponent(oldCode)}`, {
                    method: 'DELETE',
                    headers: supabaseHeaders
                });
                
                showToast(`Ny kode for ${student.display_name}: ${newCode}`, 'success');
                
                // Reload dashboard
                await loadClassStudents();
                
            } catch (error) {
                console.error('Error resetting code:', error);
                showToast('Kunne ikke endre kode: ' + error.message, 'error');
            }
        }

        async function getStudentByCode(code) {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/user_progress?code=eq.${encodeURIComponent(code)}&select=*`,
                    { headers: supabaseHeaders }
                );
                if (!response.ok) return null;
                const data = await response.json();
                return data.length > 0 ? data[0] : null;
            } catch (error) {
                return null;
            }
        }

        function updateDashboardStats(students, totalMembers) {
            document.getElementById('dashStatStudents').textContent = totalMembers;
            
            if (students.length === 0) {
                document.getElementById('dashStatAvgVocab').textContent = '0%';
                document.getElementById('dashStatAvgGrammar').textContent = '0%';
                document.getElementById('dashStatActive').textContent = '0';
                return;
            }
            
            // Calculate averages (simplified)
            document.getElementById('dashStatAvgVocab').textContent = '-';
            document.getElementById('dashStatAvgGrammar').textContent = '-';
            
            // Count active today
            const now = new Date();
            const activeToday = students.filter(s => {
                const updated = new Date(s.updated_at);
                return (now - updated) < (24 * 60 * 60 * 1000);
            }).length;
            
            document.getElementById('dashStatActive').textContent = activeToday;
        }

        // Push words functions
        function addWordToPushList() {
            const norsk = document.getElementById('pushNorsk').value.trim();
            const spansk = document.getElementById('pushSpansk').value.trim();
            const category = document.getElementById('pushCategory').value.trim() || 'fra-l√¶rer';
            
            if (!norsk || !spansk) {
                showToast('Skriv inn b√•de norsk og spansk', 'error');
                return;
            }
            
            pendingPushWords.push({ norsk, spansk, category });
            
            document.getElementById('pushNorsk').value = '';
            document.getElementById('pushSpansk').value = '';
            
            renderPendingWords();
            showToast(`"${norsk}" lagt til`, 'success');
        }

        function renderPendingWords() {
            const list = document.getElementById('pendingWordsList');
            
            if (pendingPushWords.length === 0) {
                list.innerHTML = '<p style="color: var(--gray-500); text-align: center;">Ingen gloser lagt til enn√•</p>';
                return;
            }
            
            list.innerHTML = pendingPushWords.map((word, i) => `
                <div class="pending-word-item">
                    <span>${word.norsk} ‚Üí ${word.spansk} <small style="color: var(--gray-500);">(${word.category})</small></span>
                    <button class="pending-word-remove" onclick="removePendingWord(${i})">‚úï</button>
                </div>
            `).join('');
        }

        function removePendingWord(index) {
            pendingPushWords.splice(index, 1);
            renderPendingWords();
        }

        async function pushWordsToClass() {
            if (!currentClass || pendingPushWords.length === 0) {
                showToast('Legg til gloser f√∏rst', 'error');
                return;
            }
            
            const category = document.getElementById('pushCategory').value.trim() || 'fra-l√¶rer';
            
            try {
                // Save to class_words table
                const response = await fetch(`${SUPABASE_URL}/rest/v1/class_words`, {
                    method: 'POST',
                    headers: supabaseHeaders,
                    body: JSON.stringify({
                        class_id: currentClass.id,
                        category: category,
                        words: pendingPushWords,
                        pushed_by: currentUser.code
                    })
                });
                
                if (!response.ok) throw new Error('Could not push words');
                
                const count = pendingPushWords.length;
                pendingPushWords = [];
                renderPendingWords();
                
                showToast(`${count} gloser sendt til klassen!`, 'success');
                
            } catch (error) {
                console.error('Error pushing words:', error);
                showToast('Kunne ikke sende gloser: ' + error.message, 'error');
            }
        }

        async function importAndPushWords() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        let words = [];
                        
                        // Parse different formats (same as importTeacherWords)
                        if (Array.isArray(data) && Array.isArray(data[0])) {
                            words = data.map(item => ({
                                norsk: item[0],
                                spansk: item[1],
                                category: item[2] || document.getElementById('pushCategory').value || 'fra-l√¶rer'
                            }));
                        } else if (data.category && Array.isArray(data.words)) {
                            document.getElementById('pushCategory').value = data.category;
                            words = data.words.map(item => ({
                                norsk: item[0],
                                spansk: item[1],
                                category: data.category
                            }));
                        } else if (data.words && Array.isArray(data.words)) {
                            words = data.words;
                        } else if (Array.isArray(data) && data[0].norsk) {
                            words = data;
                        }
                        
                        pendingPushWords = pendingPushWords.concat(words);
                        renderPendingWords();
                        showToast(`${words.length} gloser lagt til`, 'success');
                        
                    } catch (error) {
                        showToast('Kunne ikke lese filen', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Check for new class words (for students)
        async function checkForClassWords() {
            if (isOfflineMode || !currentUser || currentUser.is_teacher) return;
            
            try {
                // Find student's class
                const memberResponse = await fetch(
                    `${SUPABASE_URL}/rest/v1/class_members?student_code=eq.${encodeURIComponent(currentUser.code)}&select=class_id`,
                    { headers: supabaseHeaders }
                );
                
                if (!memberResponse.ok) return;
                
                const memberships = await memberResponse.json();
                if (memberships.length === 0) return;
                
                const classId = memberships[0].class_id;
                
                // Get class words
                const wordsResponse = await fetch(
                    `${SUPABASE_URL}/rest/v1/class_words?class_id=eq.${classId}&select=*&order=pushed_at.desc`,
                    { headers: supabaseHeaders }
                );
                
                if (!wordsResponse.ok) return;
                
                const classWords = await wordsResponse.json();
                
                // Get last sync timestamp
                const lastSync = localStorage.getItem('spansk123_lastClassSync') || '1970-01-01';
                
                // Import new words
                let imported = 0;
                for (const batch of classWords) {
                    if (new Date(batch.pushed_at) > new Date(lastSync)) {
                        for (const word of batch.words) {
                            const exists = cards.some(c => 
                                c.norsk.toLowerCase() === word.norsk.toLowerCase() && 
                                c.spansk.toLowerCase() === word.spansk.toLowerCase()
                            );
                            
                            if (!exists) {
                                cards.push({
                                    norsk: word.norsk,
                                    spansk: word.spansk,
                                    category: word.category || batch.category,
                                    isCustom: true,
                                    fromTeacher: true,
                                    noEs: { repetitions: 0, easeFactor: 2.5, interval: 0, nextReview: 0 },
                                    esNo: { repetitions: 0, easeFactor: 2.5, interval: 0, nextReview: 0 },
                                    reviews: 0,
                                    correct: 0
                                });
                                imported++;
                            }
                        }
                    }
                }
                
                if (imported > 0) {
                    saveData();
                    updateStats();
                    populateCategories();
                    showToast(`${imported} nye gloser fra l√¶reren!`, 'success');
                }
                
                // Update last sync
                localStorage.setItem('spansk123_lastClassSync', new Date().toISOString());
                
            } catch (error) {
                console.error('Error checking class words:', error);
            }
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Initialize
        init();
    </script>
</body>
</html>
