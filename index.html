<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spansk på 1-2-3 | Læringsapp</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            min-height: 100vh;
            padding: 16px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Login Screen */
        .login-screen {
            max-width: 400px;
            margin: 60px auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            text-align: center;
        }

        .login-logo {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: var(--gray-500);
            margin-bottom: 32px;
        }

        .login-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 18px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 12px;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .login-input-small {
            font-size: 16px;
            text-transform: none;
            letter-spacing: normal;
            margin-bottom: 20px;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
        }

        .login-btn-primary {
            background: var(--primary);
            color: white;
        }

        .login-btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .login-btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .login-btn-secondary:hover {
            background: var(--gray-200);
        }

        .login-divider {
            display: flex;
            align-items: center;
            margin: 24px 0;
            color: var(--gray-500);
            font-size: 14px;
        }

        .login-divider::before,
        .login-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--gray-200);
        }

        .login-divider::before { margin-right: 16px; }
        .login-divider::after { margin-left: 16px; }

        .login-error {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .login-success {
            background: #dcfce7;
            color: #166534;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .login-hint {
            font-size: 13px;
            color: var(--gray-500);
            margin-top: 20px;
        }

        /* Role selector */
        .role-selector {
            display: flex;
            gap: 12px;
            margin: 16px 0;
        }

        .role-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .role-btn:hover {
            border-color: var(--primary);
        }

        .role-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        #classCodeSection {
            margin-bottom: 16px;
        }

        /* Homework Page */
        .homework-nav {
            background: linear-gradient(135deg, #f59e0b 0%, #eab308 100%);
            color: white !important;
            border-radius: 8px;
        }

        .homework-status {
            background: var(--gray-50);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .homework-status h3 {
            margin-bottom: 16px;
            color: var(--gray-900);
        }

        .homework-week {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .homework-day {
            width: 60px;
            padding: 12px 8px;
            border-radius: 8px;
            text-align: center;
            background: white;
            border: 2px solid var(--gray-200);
        }

        .homework-day.practiced {
            background: #dcfce7;
            border-color: var(--success);
        }

        .homework-day.today {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .homework-day.class-day {
            background: #fee2e2;
            border-color: #fca5a5;
        }

        .homework-day-name {
            font-size: 11px;
            color: var(--gray-500);
            margin-bottom: 4px;
        }

        .homework-day-date {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .homework-day-icon {
            font-size: 14px;
            margin-top: 4px;
        }

        .homework-summary {
            padding: 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
        }

        .homework-submit-section {
            background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            text-align: center;
        }

        .homework-submit-section h3 {
            margin-bottom: 8px;
            color: var(--gray-900);
        }

        .btn-large {
            padding: 16px 32px;
            font-size: 18px;
        }

        .homework-hint {
            margin-top: 12px;
            font-size: 14px;
            color: var(--gray-600);
        }

        .homework-history-section {
            background: var(--gray-50);
            padding: 24px;
            border-radius: 12px;
        }

        .homework-history-section h3 {
            margin-bottom: 16px;
            color: var(--gray-900);
        }

        .practice-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--gray-200);
        }

        .practice-entry-date {
            font-weight: 600;
            color: var(--gray-900);
        }

        .practice-entry-stats {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: var(--gray-600);
        }

        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .settings-modal-content {
            background: white;
            padding: 32px;
            border-radius: 16px;
            max-width: 400px;
            width: 90%;
        }

        .settings-modal h2 {
            margin-bottom: 20px;
        }

        .settings-modal input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
        }
            padding: 12px 16px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .create-class-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* User info in navbar */
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--gray-100);
            border-radius: 10px;
            font-size: 14px;
        }

        .user-code {
            font-weight: 700;
            color: var(--primary);
        }

        .user-name {
            color: var(--gray-700);
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--gray-500);
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
        }

        .logout-btn:hover {
            color: var(--danger);
        }

        .sync-status {
            font-size: 11px;
            color: var(--gray-500);
        }

        .sync-status.syncing {
            color: var(--warning);
        }

        .sync-status.synced {
            color: var(--success);
        }

        .sync-status.offline {
            color: var(--gray-500);
        }

        .class-badge {
            background: linear-gradient(135deg, #7c3aed 0%, #6366f1 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Navigation */
        .nav-bar {
            background: white;
            padding: 16px 24px;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .nav-brand {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-links {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .nav-link {
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .nav-link:hover {
            background: var(--gray-200);
        }

        .nav-link.active {
            background: var(--primary);
            color: white;
        }

        /* Panels */
        .panel {
            background: white;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        .hidden { display: none !important; }

        /* Page Headers */
        .page-header {
            margin-bottom: 24px;
        }

        .page-header h2 {
            font-size: 24px;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .page-header p {
            color: var(--gray-500);
            font-size: 15px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: var(--gray-50);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 4px;
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 24px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--gray-500);
            margin-bottom: 6px;
        }

        .progress-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            display: flex;
        }

        .progress-segment {
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-mastered { background: var(--success); }
        .progress-learning { background: var(--warning); }
        .progress-new { background: var(--gray-300); }

        /* Settings Section */
        .settings-section {
            margin-bottom: 28px;
        }

        .settings-section h3 {
            color: var(--gray-700);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-label {
            color: var(--gray-700);
            font-size: 15px;
        }

        .setting-hint {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 2px;
        }

        input[type="number"], select {
            padding: 10px 14px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 15px;
            width: 100px;
            text-align: center;
        }

        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }

        select {
            width: auto;
            min-width: 150px;
        }

        /* Category Grid */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 12px;
        }

        .category-chip {
            padding: 10px 14px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            background: white;
        }

        .category-chip:hover {
            border-color: var(--primary);
            background: var(--gray-50);
        }

        .category-chip.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .category-chip .count {
            font-size: 11px;
            opacity: 0.7;
            margin-left: 4px;
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--gray-300);
            color: var(--gray-700);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 24px;
        }

        /* Study Header */
        .study-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .session-progress {
            flex: 1;
            margin: 0 20px;
        }

        .session-progress-bar {
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
        }

        .session-progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .session-stats {
            font-size: 13px;
            color: var(--gray-500);
            margin-top: 6px;
            text-align: center;
        }

        .card-counter {
            font-size: 14px;
            color: var(--gray-500);
            font-weight: 600;
        }

        /* Flashcard */
        .flashcard {
            width: 100%;
            min-height: 280px;
            background: var(--gray-50);
            border-radius: 16px;
            padding: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 3px solid var(--gray-200);
            position: relative;
            margin: 20px 0;
        }

        .flashcard:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.1);
        }

        .card-type-badge {
            position: absolute;
            top: 16px;
            left: 16px;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
        }

        .badge-new {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .badge-review {
            background: #fef3c7;
            color: #b45309;
        }

        .direction-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--gray-200);
            color: var(--gray-700);
            font-weight: 600;
        }

        .card-category {
            position: absolute;
            bottom: 16px;
            left: 16px;
            font-size: 11px;
            color: var(--gray-500);
        }

        .card-word {
            font-size: 32px;
            font-weight: 600;
            color: var(--gray-900);
            text-align: center;
        }

        .card-hint {
            font-size: 14px;
            color: var(--gray-500);
            margin-top: 20px;
        }

        .card-answer {
            font-size: 32px;
            font-weight: 600;
            color: var(--primary);
            text-align: center;
        }

        /* Rating Buttons */
        .rating-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 24px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .rating-btn {
            padding: 16px 12px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .rating-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .rating-btn .interval {
            font-size: 12px;
            opacity: 0.9;
        }

        .rating-btn .key {
            font-size: 11px;
            opacity: 0.7;
        }

        .rating-again { background: var(--danger); color: white; }
        .rating-good { background: var(--success); color: white; }

        .accent-hint {
            font-size: 11px;
            color: var(--gray-500);
            text-align: center;
            margin-top: 8px;
        }

        /* ==================== */
        /* GRAMMAR MODE */
        /* ==================== */

        .grammar-topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .grammar-topic-card {
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .grammar-topic-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .grammar-topic-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .grammar-topic-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .grammar-topic-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 6px;
        }

        .grammar-topic-desc {
            font-size: 13px;
            color: var(--gray-500);
            margin-bottom: 12px;
        }

        .grammar-topic-progress {
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
        }

        .grammar-topic-progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s;
        }

        .grammar-topic-stats {
            font-size: 11px;
            color: var(--gray-500);
            margin-top: 6px;
        }

        .grammar-mastery-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 18px;
        }

        /* Theory card */
        .theory-card {
            background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
            border: 2px solid #93c5fd;
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
        }

        .theory-card h3 {
            color: #1e40af;
            font-size: 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theory-card p {
            color: #1e3a8a;
            line-height: 1.7;
            margin-bottom: 12px;
        }

        .theory-card ul {
            color: #1e3a8a;
            margin-left: 20px;
            line-height: 1.8;
        }

        .theory-card .example {
            background: white;
            border-radius: 8px;
            padding: 12px 16px;
            margin: 12px 0;
            font-family: monospace;
            font-size: 15px;
        }

        .theory-card .example .correct {
            color: var(--success);
            font-weight: 700;
        }

        .theory-card .rule {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 12px 16px;
            margin: 12px 0;
            border-radius: 0 8px 8px 0;
        }

        .theory-card .exception {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 12px 16px;
            margin: 12px 0;
            border-radius: 0 8px 8px 0;
        }

        /* Grammar exercise */
        .grammar-exercise {
            background: var(--gray-50);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
        }

        .grammar-sentence {
            font-size: 24px;
            color: var(--gray-900);
            margin-bottom: 28px;
            line-height: 1.5;
        }

        .grammar-sentence .blank {
            display: inline-block;
            min-width: 80px;
            border-bottom: 3px solid var(--primary);
            margin: 0 4px;
            color: transparent;
        }

        .grammar-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .grammar-option {
            padding: 14px 28px;
            border: 2px solid var(--gray-300);
            border-radius: 10px;
            background: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 100px;
        }

        .grammar-option:hover {
            border-color: var(--primary);
            background: var(--gray-50);
        }

        .grammar-option.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .grammar-option.correct {
            border-color: var(--success);
            background: var(--success);
            color: white;
        }

        .grammar-option.incorrect {
            border-color: var(--danger);
            background: var(--danger);
            color: white;
        }

        .grammar-option.disabled {
            pointer-events: none;
            opacity: 0.6;
        }

        .grammar-feedback {
            min-height: 60px;
            padding: 16px;
            border-radius: 12px;
            margin-top: 20px;
            font-size: 16px;
        }

        .grammar-feedback.correct {
            background: #dcfce7;
            color: #166534;
        }

        .grammar-feedback.incorrect {
            background: #fee2e2;
            color: #991b1b;
        }

        .grammar-feedback .explanation {
            font-size: 14px;
            margin-top: 8px;
            opacity: 0.9;
        }

        .grammar-hint-btn {
            background: none;
            border: none;
            color: var(--gray-500);
            font-size: 14px;
            cursor: pointer;
            margin-top: 12px;
        }

        .grammar-hint-btn:hover {
            color: var(--primary);
        }

        /* Add Word Form */
        .add-word-form {
            background: var(--gray-50);
            padding: 16px;
            border-radius: 12px;
            margin-top: 12px;
        }

        .add-word-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .add-word-input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
        }

        .add-word-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .add-word-select {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .add-word-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gray-900);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            animation: toastIn 0.3s ease;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* Session Complete */
        .session-complete {
            text-align: center;
            padding: 40px 20px;
        }

        .session-complete h2 {
            font-size: 28px;
            color: var(--gray-900);
            margin-bottom: 16px;
        }

        .session-complete .emoji {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .session-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin: 32px 0;
        }

        .session-stat {
            background: var(--gray-50);
            padding: 20px;
            border-radius: 12px;
        }

        .session-stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .session-stat-label {
            font-size: 13px;
            color: var(--gray-500);
            margin-top: 4px;
        }

        /* Brainmap */
        .brainmap-level {
            margin-bottom: 32px;
        }

        .brainmap-level-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .brainmap-level-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .brainmap-categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }

        .brainmap-category {
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .brainmap-category:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .brainmap-category-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .brainmap-category-progress {
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .brainmap-category-progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s;
        }

        .brainmap-category-stats {
            font-size: 12px;
            color: var(--gray-500);
        }

        /* ==================== */
        /* VERB CONJUGATION MODE */
        /* ==================== */

        .verb-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .verb-card {
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .verb-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .verb-card.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .verb-card.selected .verb-translation {
            color: rgba(255,255,255,0.8);
        }

        .verb-infinitive {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .verb-translation {
            font-size: 13px;
            color: var(--gray-500);
        }

        .verb-type-badge {
            display: inline-block;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--gray-200);
            color: var(--gray-700);
            margin-top: 8px;
        }

        .verb-card.selected .verb-type-badge {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* Conjugation Exercise */
        .conjugation-exercise {
            background: var(--gray-50);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
        }

        .conjugation-verb {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .conjugation-translation {
            font-size: 16px;
            color: var(--gray-500);
            margin-bottom: 24px;
        }

        .conjugation-tense {
            display: inline-block;
            padding: 6px 16px;
            background: var(--warning);
            color: white;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .conjugation-prompt {
            font-size: 24px;
            color: var(--gray-900);
            margin-bottom: 20px;
        }

        .conjugation-prompt .pronoun {
            color: var(--primary);
            font-weight: 700;
        }

        .conjugation-input-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .conjugation-input {
            font-size: 24px;
            padding: 16px 24px;
            border: 3px solid var(--gray-300);
            border-radius: 12px;
            text-align: center;
            width: 300px;
            max-width: 100%;
        }

        .conjugation-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .conjugation-input.correct {
            border-color: var(--success);
            background: #dcfce7;
        }

        .conjugation-input.incorrect {
            border-color: var(--danger);
            background: #fee2e2;
        }

        .conjugation-feedback {
            font-size: 18px;
            margin-bottom: 20px;
            min-height: 30px;
        }

        .conjugation-feedback.correct {
            color: var(--success);
        }

        .conjugation-feedback.incorrect {
            color: var(--danger);
        }

        .conjugation-table {
            margin-top: 24px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
        }

        .conjugation-table h4 {
            margin-bottom: 16px;
            color: var(--gray-700);
        }

        .conjugation-table-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .conjugation-table-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--gray-50);
            border-radius: 6px;
        }

        .conjugation-table-row .pronoun {
            color: var(--gray-500);
        }

        .conjugation-table-row .form {
            font-weight: 600;
            color: var(--gray-900);
        }

        .conjugation-table-row.highlight {
            background: #dbeafe;
        }

        .conjugation-table-row.highlight .form {
            color: var(--primary);
        }

        /* Tense Selector */
        .tense-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .tense-btn {
            padding: 10px 20px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tense-btn:hover {
            border-color: var(--primary);
        }

        .tense-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .rating-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            .session-stats-grid {
                grid-template-columns: 1fr;
            }

            .card-word, .card-answer {
                font-size: 24px;
            }

            .conjugation-table-grid {
                grid-template-columns: 1fr;
            }

            .nav-brand {
                width: 100%;
                justify-content: center;
            }

            .nav-links {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .panel {
                padding: 16px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .conjugation-input {
                width: 100%;
                font-size: 20px;
            }
        }

        /* ============================================ */
        /* GAMES SECTION */
        /* ============================================ */
        
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .game-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid var(--gray-200);
        }

        .game-card:hover:not(.coming-soon) {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--primary);
        }

        .game-card.coming-soon {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .game-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .game-card h3 {
            color: var(--gray-800);
            margin-bottom: 8px;
        }

        .game-card p {
            color: var(--gray-500);
            font-size: 14px;
        }

        .game-setup-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .game-setup-section h3 {
            margin-bottom: 16px;
            color: var(--gray-800);
        }

        .tense-selector {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .tense-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--gray-50);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .tense-option:hover {
            background: var(--gray-100);
        }

        .tense-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }

        .verb-select-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .game-verb-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
        }

        .game-verb-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: var(--gray-50);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .game-verb-chip:hover {
            background: var(--gray-100);
        }

        .game-verb-chip.selected {
            background: var(--primary);
            color: white;
        }

        .game-verb-chip input {
            display: none;
        }

        /* ============================================ */
        /* VERBO INVADERS GAME */
        /* ============================================ */

        .vi-game-container {
            position: fixed;
            inset: 0;
            background: #0a0a1a;
            z-index: 1000;
            overflow: hidden;
        }

        .vi-stars {
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at 20% 50%, #0d0d2b 0%, #0a0a1a 100%);
        }

        .vi-stars::before, .vi-stars::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.6) 50%, transparent 50%),
                radial-gradient(1px 1px at 30% 60%, rgba(255,255,255,.4) 50%, transparent 50%),
                radial-gradient(1.5px 1.5px at 50% 10%, rgba(255,255,255,.7) 50%, transparent 50%),
                radial-gradient(1px 1px at 70% 80%, rgba(255,255,255,.3) 50%, transparent 50%),
                radial-gradient(1px 1px at 90% 40%, rgba(255,255,255,.5) 50%, transparent 50%);
            background-size: 200px 200px;
            animation: viTwinkle 4s ease-in-out infinite alternate;
        }

        .vi-stars::after {
            background-size: 300px 300px;
            animation-delay: 2s;
            opacity: 0.5;
        }

        @keyframes viTwinkle {
            from { opacity: 0.4; }
            to { opacity: 1; }
        }

        .vi-hud {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            padding: 16px 24px;
            background: linear-gradient(180deg, rgba(0,0,0,0.7) 0%, transparent 100%);
            z-index: 100;
            font-family: 'Segoe UI', sans-serif;
        }

        .vi-hud-item {
            text-align: center;
        }

        .vi-hud-label {
            color: #888;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .vi-hud-value {
            font-size: 20px;
            font-weight: bold;
            color: #39ff14;
            text-shadow: 0 0 10px #39ff14;
        }

        .vi-hud-value.vi-lives {
            color: #ff2e63;
            text-shadow: 0 0 10px #ff2e63;
        }

        .vi-hud-value.vi-level {
            color: #08f7fe;
            text-shadow: 0 0 10px #08f7fe;
        }

        .vi-quit-btn {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #888;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .vi-quit-btn:hover {
            background: rgba(255,46,99,0.2);
            border-color: #ff2e63;
            color: #ff2e63;
        }

        .vi-invader-zone {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: -150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 20;
        }

        .vi-invader-sprite {
            font-size: 48px;
            filter: drop-shadow(0 0 20px #39ff14);
            animation: viWobble 0.6s ease-in-out infinite alternate;
        }

        @keyframes viWobble {
            0% { transform: rotate(-3deg) scale(1); }
            100% { transform: rotate(3deg) scale(1.05); }
        }

        .vi-prompt-box {
            margin-top: 12px;
            background: rgba(15, 15, 40, 0.85);
            border: 1px solid rgba(57, 255, 20, 0.3);
            border-radius: 12px;
            padding: 16px 32px;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 30px rgba(57, 255, 20, 0.1);
        }

        .vi-prompt-norwegian {
            font-size: 18px;
            font-weight: bold;
            color: #ffe66d;
            text-shadow: 0 0 10px rgba(255, 230, 109, 0.5);
            margin-bottom: 8px;
        }

        .vi-prompt-verb {
            font-size: 12px;
            color: #888;
        }

        .vi-danger-line {
            position: absolute;
            bottom: 148px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #ff2e63, transparent);
            box-shadow: 0 0 12px rgba(255, 46, 99, 0.4);
            z-index: 15;
            opacity: 0.5;
        }

        .vi-danger-label {
            position: absolute;
            bottom: 154px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            color: #ff2e63;
            opacity: 0.4;
            letter-spacing: 4px;
            z-index: 15;
        }

        .vi-player-ship {
            position: absolute;
            bottom: 118px;
            left: calc(50% - 18px);
            font-size: 36px;
            filter: drop-shadow(0 0 15px #08f7fe);
            transition: left 0.3s ease;
            z-index: 20;
        }

        .vi-answer-zone {
            position: absolute;
            bottom: 50px;
            display: flex;
            gap: 16px;
            justify-content: center;
            width: 100%;
            padding: 0 20px;
            z-index: 20;
        }

        .vi-answer-card {
            background: rgba(15, 15, 40, 0.85);
            border: 2px solid rgba(8, 247, 254, 0.3);
            border-radius: 14px;
            padding: 20px 28px;
            min-width: 140px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .vi-answer-card:hover {
            border-color: #08f7fe;
            transform: translateY(-4px) scale(1.03);
            box-shadow: 0 8px 30px rgba(8, 247, 254, 0.2);
        }

        .vi-key-hint {
            font-size: 10px;
            color: #555;
            margin-bottom: 8px;
            letter-spacing: 2px;
        }

        .vi-answer-text {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }

        .vi-answer-card.correct {
            border-color: #39ff14 !important;
            background: rgba(57, 255, 20, 0.15) !important;
            animation: viCorrectPulse 0.5s ease;
        }

        .vi-answer-card.wrong {
            border-color: #ff2e63 !important;
            background: rgba(255, 46, 99, 0.15) !important;
            animation: viShake 0.4s ease;
        }

        @keyframes viCorrectPulse {
            0% { box-shadow: 0 0 0 0 rgba(57,255,20,.6); }
            100% { box-shadow: 0 0 40px 10px rgba(57,255,20,0); }
        }

        @keyframes viShake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-8px); }
            40% { transform: translateX(8px); }
            60% { transform: translateX(-4px); }
            80% { transform: translateX(4px); }
        }

        .vi-combo {
            position: absolute;
            top: 50%;
            right: 30px;
            transform: translateY(-50%);
            font-size: 12px;
            color: #ffe66d;
            text-shadow: 0 0 15px rgba(255,230,109,0.5);
            z-index: 100;
            text-align: right;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .vi-combo.visible {
            opacity: 1;
        }

        .vi-combo-number {
            font-size: 32px;
            font-weight: bold;
            display: block;
            margin-bottom: 4px;
        }

        .vi-warning-glow {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: linear-gradient(0deg, rgba(255,46,99,0.15), transparent);
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .vi-explosion {
            position: fixed;
            pointer-events: none;
            z-index: 150;
        }

        .vi-explosion-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            animation: viExplode 0.6s ease-out forwards;
        }

        @keyframes viExplode {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            100% { opacity: 0; transform: translate(var(--dx), var(--dy)) scale(0); }
        }

        .vi-level-up-flash {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle, rgba(8,247,254,0.2), transparent 70%);
            z-index: 90;
            animation: viLevelFlash 0.8s ease-out forwards;
            pointer-events: none;
        }

        @keyframes viLevelFlash {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }

        .vi-level-up-text {
            position: fixed;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 28px;
            font-weight: bold;
            color: #08f7fe;
            text-shadow: 0 0 30px #08f7fe;
            z-index: 95;
            animation: viLevelText 1.2s ease-out forwards;
            pointer-events: none;
        }

        @keyframes viLevelText {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            70% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -60%) scale(1); }
        }

        .vi-gameover-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
            padding: 40px;
        }

        .vi-gameover-title {
            font-size: 36px;
            font-weight: bold;
            color: #ff2e63;
            text-shadow: 0 0 30px rgba(255,46,99,0.6);
            margin-bottom: 20px;
        }

        .vi-gameover-score {
            font-size: 24px;
            font-weight: bold;
            color: #ffe66d;
            text-shadow: 0 0 20px rgba(255,230,109,0.5);
            margin-bottom: 16px;
        }

        .vi-gameover-stats {
            color: var(--gray-500);
            margin-bottom: 32px;
            line-height: 1.8;
        }

        @media (max-width: 600px) {
            .vi-answer-card {
                min-width: 90px;
                padding: 14px 12px;
            }
            .vi-answer-text {
                font-size: 14px;
            }
            .vi-prompt-norwegian {
                font-size: 14px;
            }
            .vi-hud {
                gap: 20px;
                padding: 12px 16px;
            }
            .vi-quit-btn {
                padding: 6px 10px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="login-screen">
        <div class="login-logo">🇪🇸</div>
        <h1 class="login-title">Spansk på 1-2-3</h1>
        <p class="login-subtitle">Øv på spansk - din fremgang lagres på denne enheten</p>
        
        <div id="welcomeForm">
            <input type="text" id="studentNameInput" class="login-input" placeholder="Ditt navn (f.eks. Maria)" maxlength="50">
            <button class="login-btn login-btn-primary" onclick="startApp()">🚀 Start</button>
            
            <p class="login-hint">
                💡 Skriv navnet ditt så vi kan vise det i ukesleksen.
            </p>
            
            <div class="login-divider">har du brukt appen før?</div>
            
            <button class="login-btn login-btn-secondary" onclick="importProgressFile()">📂 Importer fremgang fra fil</button>
            <p class="login-hint" style="margin-top: 8px; font-size: 12px;">
                Støtter både ny og gammel versjon av appen
            </p>
        </div>
    </div>

    <div class="container hidden" id="mainApp">
        <!-- Navigation Bar -->
        <nav class="nav-bar">
            <div class="nav-brand">
                🇪🇸 Spansk på 1-2-3
            </div>
            <div class="nav-links">
                <button class="nav-link active" onclick="showPage('vocab')" id="navVocab">📚 Gloser</button>
                <button class="nav-link" onclick="showPage('brainmap')" id="navBrainmap">🧠 Brainmap</button>
                <button class="nav-link" onclick="showPage('verbs')" id="navVerbs">🏃 Verb</button>
                <button class="nav-link" onclick="showPage('grammar')" id="navGrammar">📖 Grammatikk</button>
                <button class="nav-link" onclick="showPage('games')" id="navGames">🎮 Spill</button>
                <button class="nav-link homework-nav" onclick="showPage('homework')" id="navHomework">📝 Lekse</button>
            </div>
            <div class="user-info" id="userInfo">
                <span class="user-name" id="userName"></span>
                <button class="logout-btn" onclick="showSettings()" title="Innstillinger">⚙️</button>
            </div>
        </nav>

        <!-- ==================== -->
        <!-- VOCABULARY PAGE -->
        <!-- ==================== -->
        <div id="vocabPage" class="panel">
            <!-- Settings View -->
            <div id="vocabSettings">
                <div class="page-header">
                    <h2>📚 Gloselæring</h2>
                    <p>Lær ordforråd med spaced repetition - begge veier!</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-number" id="statTotal">0</div>
                        <div class="stat-label">Totalt</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="statNew">0</div>
                        <div class="stat-label">Nye</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="statDue">0</div>
                        <div class="stat-label">Til repetisjon</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="statMastered">0</div>
                        <div class="stat-label">Mestret</div>
                    </div>
                </div>

                <div class="progress-container">
                    <div class="progress-label">
                        <span>Fremgang</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-segment progress-mastered" id="progressMastered"></div>
                        <div class="progress-segment progress-learning" id="progressLearning"></div>
                        <div class="progress-segment progress-new" id="progressNew"></div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>⚙️ Øktinnstillinger</h3>
                    <div class="setting-row">
                        <div>
                            <div class="setting-label">Nye kort</div>
                            <div class="setting-hint">Antall nye ord per økt</div>
                        </div>
                        <input type="number" id="newCardsLimit" min="0" max="50" value="10">
                    </div>
                    <div class="setting-row">
                        <div>
                            <div class="setting-label">Repetisjonskort</div>
                            <div class="setting-hint">Maks antall repetisjoner per økt</div>
                        </div>
                        <input type="number" id="reviewCardsLimit" min="0" max="200" value="50">
                    </div>
                </div>

                <div class="settings-section">
                    <h3>📚 Velg kategorier</h3>
                    <div class="setting-row">
                        <button class="btn btn-sm btn-outline" onclick="selectAllCategories()">Velg alle</button>
                        <button class="btn btn-sm btn-outline" onclick="deselectAllCategories()">Fjern alle</button>
                    </div>
                    <div id="categoryGrid" class="category-grid"></div>
                </div>

                <div class="settings-section">
                    <h3>➕ Legg til gloser</h3>
                    <div class="add-word-form">
                        <div class="add-word-row">
                            <input type="text" id="addWordNorsk" placeholder="Norsk" class="add-word-input">
                            <input type="text" id="addWordSpansk" placeholder="Spansk" class="add-word-input">
                        </div>
                        <div class="add-word-row">
                            <select id="addWordCategory" class="add-word-select">
                                <option value="">Velg kategori...</option>
                            </select>
                            <input type="text" id="addWordNewCategory" placeholder="...eller ny kategori" class="add-word-input">
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="addCustomWord()">➕ Legg til glose</button>
                    </div>
                    <div class="setting-row" style="margin-top: 16px;">
                        <div>
                            <div class="setting-label">Importer fra lærer</div>
                            <div class="setting-hint">Last inn JSON-fil med nye gloser</div>
                        </div>
                        <button class="btn btn-sm btn-outline" onclick="importTeacherWords()">📥 Importer gloser</button>
                    </div>
                    <div id="customWordsCount" class="setting-hint" style="margin-top: 8px;"></div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="startVocabSession()">▶️ Start økt</button>
                    <button class="btn btn-secondary" onclick="showStatistics()">📊 Statistikk</button>
                    <button class="btn btn-secondary" onclick="exportProgress()">💾 Eksporter</button>
                    <button class="btn btn-secondary" onclick="importProgress()">📂 Importer</button>
                </div>
            </div>

            <!-- Study View -->
            <div id="vocabStudy" class="hidden">
                <div class="study-header">
                    <button class="btn btn-outline btn-sm" onclick="endVocabSessionEarly()">✕ Avslutt</button>
                    <div class="session-progress">
                        <div class="session-progress-bar">
                            <div class="session-progress-fill" id="sessionProgressFill"></div>
                        </div>
                        <div class="session-stats" id="sessionStats">0 / 0 kort</div>
                    </div>
                    <div class="card-counter" id="cardCounter">1 / 10</div>
                </div>
                <div id="flashcardArea"></div>
                <div id="buttonArea"></div>
            </div>
        </div>

        <!-- ==================== -->
        <!-- BRAINMAP PAGE -->
        <!-- ==================== -->
        <div id="brainmapPage" class="panel hidden">
            <div class="page-header">
                <h2>🧠 Brainmap</h2>
                <p>Se fremgangen din og velg kategorier å øve på</p>
            </div>
            <div id="brainmapContent"></div>
        </div>

        <!-- ==================== -->
        <!-- VERB PAGE -->
        <!-- ==================== -->
        <div id="verbPage" class="panel hidden">
            <!-- Verb Settings View -->
            <div id="verbSettings">
                <div class="page-header">
                    <h2>🏃 Verbbøying</h2>
                    <p>Øv på å bøye verb i presens, fremtid og presens perfektum</p>
                </div>

                <div class="settings-section">
                    <h3>📝 Velg verbtid</h3>
                    <div class="tense-selector">
                        <button class="tense-btn active" onclick="selectTense('presente')" id="tensePresente">Presens</button>
                        <button class="tense-btn" onclick="selectTense('futuro')" id="tenseFuturo">Fremtid (ir a)</button>
                        <button class="tense-btn" onclick="selectTense('perfecto')" id="tensePerfecto">Presens perfektum</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>🔤 Velg verb å øve på</h3>
                    <div class="setting-row">
                        <button class="btn btn-sm btn-outline" onclick="selectAllVerbs()">Velg alle</button>
                        <button class="btn btn-sm btn-outline" onclick="deselectAllVerbs()">Fjern alle</button>
                    </div>
                    <div id="verbSelector" class="verb-selector"></div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="startVerbSession()">▶️ Start øving</button>
                </div>
            </div>

            <!-- Verb Exercise View -->
            <div id="verbExercise" class="hidden">
                <div class="study-header">
                    <button class="btn btn-outline btn-sm" onclick="endVerbSessionEarly()">✕ Avslutt</button>
                    <div class="session-progress">
                        <div class="session-progress-bar">
                            <div class="session-progress-fill" id="verbProgressFill"></div>
                        </div>
                        <div class="session-stats" id="verbSessionStats">0 / 0 riktig</div>
                    </div>
                    <div class="card-counter" id="verbCounter">1 / 10</div>
                </div>
                <div id="verbExerciseArea"></div>
            </div>
        </div>

        <!-- ==================== -->
        <!-- GRAMMAR PAGE -->
        <!-- ==================== -->
        <div id="grammarPage" class="panel hidden">
            <!-- Grammar Topic Selection -->
            <div id="grammarSettings">
                <div class="page-header">
                    <h2>📖 Grammatikk</h2>
                    <p>Lær grammatikkregler med adaptive øvelser</p>
                </div>

                <div class="grammar-topic-grid" id="grammarTopicGrid">
                    <!-- Topics populated by JS -->
                </div>
            </div>

            <!-- Grammar Exercise View -->
            <div id="grammarExercise" class="hidden">
                <div class="study-header">
                    <button class="btn btn-outline btn-sm" onclick="endGrammarSessionEarly()">✕ Avslutt</button>
                    <div class="session-progress">
                        <div class="session-progress-bar">
                            <div class="session-progress-fill" id="grammarProgressFill"></div>
                        </div>
                        <div class="session-stats" id="grammarSessionStats">0 / 0 riktig</div>
                    </div>
                    <div class="card-counter" id="grammarCounter">1 / 10</div>
                </div>
                <div id="grammarTheoryArea"></div>
                <div id="grammarExerciseArea"></div>
            </div>
        </div>

        <!-- ==================== -->
        <!-- HOMEWORK PAGE -->
        <!-- ==================== -->
        <div id="homeworkPage" class="panel hidden">
            <div class="page-header">
                <h2>📝 Ukeslekse</h2>
                <p>Øv på gloser minst 2 dager i uken utenom spansktimene (mandag/tirsdag)</p>
            </div>

            <div class="homework-status" id="homeworkStatus">
                <h3>📅 Denne uken</h3>
                <div class="homework-week" id="homeworkWeek">
                    <!-- Fylles inn dynamisk -->
                </div>
                <div class="homework-summary" id="homeworkSummary">
                    <!-- Fylles inn dynamisk -->
                </div>
            </div>

            <div class="homework-submit-section">
                <h3>✅ Lever ukeslekse</h3>
                <p style="color: var(--gray-500); margin-bottom: 16px;">
                    Når du har øvd minst 2 dager denne uken (onsdag-søndag), kan du levere leksen.
                </p>
                <button class="btn btn-primary btn-large" onclick="submitHomework()" id="submitHomeworkBtn">
                    📤 Lever ukeslekse
                </button>
                <p class="homework-hint" id="homeworkHint"></p>
            </div>

            <div class="homework-history-section">
                <h3>📊 Øvingshistorikk</h3>
                <div id="practiceHistory">
                    <!-- Fylles inn dynamisk -->
                </div>
            </div>

            <div class="settings-section" style="margin-top: 24px;">
                <h3>💾 Lagre/Hent fremgang</h3>
                <p style="color: var(--gray-500); margin-bottom: 16px;">
                    Last ned fremgangen din som fil, eller importer fra en tidligere lagring.
                </p>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="exportAllProgress()">📥 Last ned fremgang</button>
                    <button class="btn btn-secondary" onclick="importProgressFile()">📂 Importer fremgang</button>
                </div>
            </div>
        </div>

        <!-- ==================== -->
        <!-- GAMES PAGE -->
        <!-- ==================== -->
        <div id="gamesPage" class="panel hidden">
            <!-- Games Menu -->
            <div id="gamesMenu">
                <div class="page-header">
                    <h2>🎮 Spill</h2>
                    <p>Lær spansk på en morsom måte!</p>
                </div>

                <div class="games-grid">
                    <div class="game-card" onclick="showGameSetup('verbo-invaders')">
                        <div class="game-icon">👾</div>
                        <h3>Verbo Invaders</h3>
                        <p>Bøy verb riktig før romvesnene tar over!</p>
                    </div>
                    <div class="game-card coming-soon">
                        <div class="game-icon">🎯</div>
                        <h3>Glose-duell</h3>
                        <p>Kommer snart...</p>
                    </div>
                    <div class="game-card coming-soon">
                        <div class="game-icon">🧩</div>
                        <h3>Setningspuslespill</h3>
                        <p>Kommer snart...</p>
                    </div>
                </div>
            </div>

            <!-- Verbo Invaders Setup -->
            <div id="verboInvadersSetup" class="hidden">
                <div class="page-header">
                    <h2>👾 Verbo Invaders</h2>
                    <p>Velg verb og verbtider du vil øve på</p>
                </div>

                <div class="game-setup-section">
                    <h3>🎯 Velg verbtid(er)</h3>
                    <div class="tense-selector">
                        <label class="tense-option">
                            <input type="checkbox" id="tensePresente" checked>
                            <span>Presens (presente)</span>
                        </label>
                        <label class="tense-option">
                            <input type="checkbox" id="tenseFuturo">
                            <span>Futuro (ir a + infinitiv)</span>
                        </label>
                        <label class="tense-option">
                            <input type="checkbox" id="tensePerfecto">
                            <span>Presens perfektum (ha + partisipp)</span>
                        </label>
                    </div>
                </div>

                <div class="game-setup-section">
                    <h3>📝 Velg verb</h3>
                    <div class="verb-select-actions">
                        <button class="btn btn-sm" onclick="selectAllGameVerbs()">Velg alle</button>
                        <button class="btn btn-sm btn-outline" onclick="deselectAllGameVerbs()">Fjern alle</button>
                    </div>
                    <div class="game-verb-grid" id="gameVerbGrid">
                        <!-- Fylles inn dynamisk -->
                    </div>
                </div>

                <div class="button-group" style="margin-top: 24px;">
                    <button class="btn btn-primary btn-large" onclick="startVerboInvaders()">🚀 Start spillet!</button>
                    <button class="btn btn-secondary" onclick="showGamesMenu()">← Tilbake</button>
                </div>
            </div>

            <!-- Verbo Invaders Game Area -->
            <div id="verboInvadersGame" class="hidden">
                <div class="vi-game-container">
                    <div class="vi-stars"></div>
                    <div class="vi-warning-glow" id="viWarningGlow"></div>
                    
                    <!-- HUD -->
                    <div class="vi-hud">
                        <div class="vi-hud-item">
                            <div class="vi-hud-label">Poeng</div>
                            <div class="vi-hud-value" id="viScore">0</div>
                        </div>
                        <div class="vi-hud-item">
                            <div class="vi-hud-label">Nivå</div>
                            <div class="vi-hud-value vi-level" id="viLevel">1</div>
                        </div>
                        <div class="vi-hud-item">
                            <div class="vi-hud-label">Liv</div>
                            <div class="vi-hud-value vi-lives" id="viLives">❤️❤️❤️</div>
                        </div>
                        <button class="vi-quit-btn" onclick="quitVerboInvaders()">✕ Avslutt</button>
                    </div>

                    <!-- Falling invader -->
                    <div class="vi-invader-zone" id="viInvaderZone">
                        <div class="vi-invader-sprite">👾</div>
                        <div class="vi-prompt-box">
                            <div class="vi-prompt-norwegian" id="viPromptText">—</div>
                            <div class="vi-prompt-verb" id="viPromptVerb">—</div>
                        </div>
                    </div>

                    <!-- Danger line -->
                    <div class="vi-danger-line"></div>
                    <div class="vi-danger-label">▼ FARESONE ▼</div>

                    <!-- Player ship -->
                    <div class="vi-player-ship" id="viPlayerShip">🚀</div>

                    <!-- Answer zone -->
                    <div class="vi-answer-zone" id="viAnswerZone">
                        <div class="vi-answer-card" onclick="viSelectAnswer(0)" id="viCard0">
                            <div class="vi-key-hint">[ 1 ]</div>
                            <div class="vi-answer-text" id="viAns0">—</div>
                        </div>
                        <div class="vi-answer-card" onclick="viSelectAnswer(1)" id="viCard1">
                            <div class="vi-key-hint">[ 2 ]</div>
                            <div class="vi-answer-text" id="viAns1">—</div>
                        </div>
                        <div class="vi-answer-card" onclick="viSelectAnswer(2)" id="viCard2">
                            <div class="vi-key-hint">[ 3 ]</div>
                            <div class="vi-answer-text" id="viAns2">—</div>
                        </div>
                    </div>

                    <!-- Combo display -->
                    <div class="vi-combo" id="viCombo">
                        <span class="vi-combo-number" id="viComboNum">0</span>
                        COMBO
                    </div>
                </div>
            </div>

            <!-- Game Over Screen -->
            <div id="verboInvadersGameOver" class="hidden">
                <div class="vi-gameover-container">
                    <div class="vi-gameover-title">GAME OVER</div>
                    <div class="vi-gameover-score" id="viFinalScore">0 POENG</div>
                    <div class="vi-gameover-stats" id="viFinalStats"></div>
                    <div class="button-group">
                        <button class="btn btn-primary btn-large" onclick="startVerboInvaders()">🔄 Spill igjen</button>
                        <button class="btn btn-secondary" onclick="showGameSetup('verbo-invaders')">⚙️ Endre innstillinger</button>
                        <button class="btn btn-outline" onclick="showGamesMenu()">← Tilbake til spill</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // APP CONFIGURATION
        // ============================================
        
        // Google Forms URL - Ukeslekse innlevering
        const GOOGLE_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdmupM8bDWBLew1NZ0zA4aEnu8H25kcmMEoxpER1fbfm1XJxw/viewform';
        // Entry IDs fra Google Forms
        const FORM_ENTRY_NAME = 'entry.1390438586';
        const FORM_ENTRY_DATE = 'entry.1347619510';
        const FORM_ENTRY_DAYS = 'entry.39925987';
        const FORM_ENTRY_WORDS = 'entry.913529179';
        const FORM_ENTRY_ACCURACY = 'entry.1698461882';
        
        let studentName = '';
        let practiceHistory = [];

        // ============================================
        // APP START FUNCTIONS
        // ============================================

        function startApp() {
            const nameInput = document.getElementById('studentNameInput');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Skriv inn navnet ditt!');
                return;
            }
            
            studentName = name;
            localStorage.setItem('spansk123_studentName', name);
            
            showMainApp();
        }

        function showMainApp() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            document.getElementById('userName').textContent = studentName;
            
            init();
            loadPracticeHistory();
        }

        function showSettings() {
            const modal = document.createElement('div');
            modal.className = 'settings-modal';
            modal.innerHTML = `
                <div class="settings-modal-content">
                    <h2>⚙️ Innstillinger</h2>
                    <label style="display: block; margin-bottom: 8px; color: var(--gray-700);">Ditt navn:</label>
                    <input type="text" id="settingsNameInput" value="${studentName}" placeholder="Ditt navn">
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="saveSettings()">Lagre</button>
                        <button class="btn btn-secondary" onclick="closeSettings()">Avbryt</button>
                    </div>
                    <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--gray-200);">
                    <button class="btn btn-outline" style="width: 100%; color: var(--danger);" onclick="resetAllData()">🗑️ Slett all data</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveSettings() {
            const name = document.getElementById('settingsNameInput').value.trim();
            if (name) {
                studentName = name;
                localStorage.setItem('spansk123_studentName', name);
                document.getElementById('userName').textContent = name;
            }
            closeSettings();
        }

        function closeSettings() {
            const modal = document.querySelector('.settings-modal');
            if (modal) modal.remove();
        }

        function resetAllData() {
            if (confirm('Er du sikker på at du vil slette ALL fremgang? Dette kan ikke angres!')) {
                localStorage.removeItem('spansk123_studentName');
                localStorage.removeItem('spansk123Data_v4');
                localStorage.removeItem('spansk123Grammar_v1');
                localStorage.removeItem('spansk123_practiceHistory');
                location.reload();
            }
        }

        // ============================================
        // PRACTICE TRACKING
        // ============================================

        function loadPracticeHistory() {
            const saved = localStorage.getItem('spansk123_practiceHistory');
            if (saved) {
                practiceHistory = JSON.parse(saved);
            }
        }

        function savePracticeHistory() {
            localStorage.setItem('spansk123_practiceHistory', JSON.stringify(practiceHistory));
        }

        function recordPracticeSession(wordsReviewed, correctAnswers) {
            const today = new Date().toISOString().split('T')[0];
            
            // Find or create today's entry
            let todayEntry = practiceHistory.find(e => e.date === today);
            
            if (todayEntry) {
                todayEntry.words += wordsReviewed;
                todayEntry.correct += correctAnswers;
                todayEntry.sessions++;
            } else {
                practiceHistory.push({
                    date: today,
                    words: wordsReviewed,
                    correct: correctAnswers,
                    sessions: 1
                });
            }
            
            // Keep only last 30 days
            practiceHistory = practiceHistory.slice(-30);
            savePracticeHistory();
        }

        function getWeekDays() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday
            
            // Find Monday of this week
            const monday = new Date(today);
            monday.setDate(today.getDate() - ((dayOfWeek + 6) % 7));
            
            const days = [];
            const dayNames = ['Man', 'Tir', 'Ons', 'Tor', 'Fre', 'Lør', 'Søn'];
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const practiced = practiceHistory.some(e => e.date === dateStr);
                const isToday = dateStr === today.toISOString().split('T')[0];
                const isClassDay = i === 0 || i === 1; // Monday or Tuesday
                
                days.push({
                    name: dayNames[i],
                    date: date.getDate(),
                    dateStr: dateStr,
                    practiced: practiced,
                    isToday: isToday,
                    isClassDay: isClassDay
                });
            }
            
            return days;
        }

        function renderHomeworkPage() {
            const days = getWeekDays();
            
            // Render week view
            const weekHtml = days.map(day => {
                let classes = 'homework-day';
                if (day.practiced) classes += ' practiced';
                if (day.isToday) classes += ' today';
                if (day.isClassDay) classes += ' class-day';
                
                let icon = '';
                if (day.isClassDay) icon = '📚';
                else if (day.practiced) icon = '✅';
                
                return `
                    <div class="${classes}">
                        <div class="homework-day-name">${day.name}</div>
                        <div class="homework-day-date">${day.date}</div>
                        <div class="homework-day-icon">${icon}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('homeworkWeek').innerHTML = weekHtml;
            
            // Count practice days this week (excluding Mon/Tue)
            const practiceDays = days.filter(d => !d.isClassDay && d.practiced).length;
            const requiredDays = 2;
            const canSubmit = practiceDays >= requiredDays;
            
            // Summary
            const summaryHtml = `
                <p><strong>Øvingsdager denne uken (ons-søn):</strong> ${practiceDays} av ${requiredDays} påkrevd</p>
                <p style="margin-top: 8px; color: ${canSubmit ? 'var(--success)' : 'var(--warning)'};">
                    ${canSubmit ? '✅ Du kan levere ukesleksen!' : `⏳ Øv ${requiredDays - practiceDays} dag(er) til for å kunne levere.`}
                </p>
            `;
            document.getElementById('homeworkSummary').innerHTML = summaryHtml;
            
            // Submit button state
            const submitBtn = document.getElementById('submitHomeworkBtn');
            submitBtn.disabled = !canSubmit;
            submitBtn.style.opacity = canSubmit ? '1' : '0.5';
            
            // Hint
            const hintEl = document.getElementById('homeworkHint');
            if (canSubmit) {
                hintEl.textContent = 'Klikk for å åpne innleveringsskjemaet.';
            } else {
                hintEl.textContent = 'Mandag og tirsdag er spanskdager - øv de andre dagene!';
            }
            
            // Practice history
            renderPracticeHistory();
        }

        function renderPracticeHistory() {
            const historyEl = document.getElementById('practiceHistory');
            
            if (practiceHistory.length === 0) {
                historyEl.innerHTML = '<p style="color: var(--gray-500); text-align: center;">Ingen øvingshistorikk ennå. Start med gloser!</p>';
                return;
            }
            
            // Show last 10 entries, newest first
            const recent = [...practiceHistory].reverse().slice(0, 10);
            
            historyEl.innerHTML = recent.map(entry => {
                const date = new Date(entry.date);
                const dateStr = date.toLocaleDateString('no-NO', { weekday: 'short', day: 'numeric', month: 'short' });
                const accuracy = entry.words > 0 ? Math.round((entry.correct / entry.words) * 100) : 0;
                
                return `
                    <div class="practice-entry">
                        <span class="practice-entry-date">${dateStr}</span>
                        <div class="practice-entry-stats">
                            <span>📝 ${entry.words} ord</span>
                            <span>✅ ${accuracy}%</span>
                            <span>🔄 ${entry.sessions} økt${entry.sessions > 1 ? 'er' : ''}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function submitHomework() {
            const days = getWeekDays();
            const practiceDays = days.filter(d => !d.isClassDay && d.practiced);
            
            if (practiceDays.length < 2) {
                alert('Du må øve minst 2 dager (ons-søn) før du kan levere!');
                return;
            }
            
            // Calculate weekly stats
            const weekStart = days[0].dateStr;
            const weekEnd = days[6].dateStr;
            const weekHistory = practiceHistory.filter(e => e.date >= weekStart && e.date <= weekEnd);
            
            const totalWords = weekHistory.reduce((sum, e) => sum + e.words, 0);
            const totalCorrect = weekHistory.reduce((sum, e) => sum + e.correct, 0);
            const accuracy = totalWords > 0 ? Math.round((totalCorrect / totalWords) * 100) : 0;
            const daysStr = practiceDays.map(d => d.name).join(', ');
            
            // Build Google Form URL with pre-filled data
            const formUrl = new URL(GOOGLE_FORM_URL);
            formUrl.searchParams.set(FORM_ENTRY_NAME, studentName);
            formUrl.searchParams.set(FORM_ENTRY_DATE, new Date().toLocaleDateString('no-NO'));
            formUrl.searchParams.set(FORM_ENTRY_DAYS, daysStr);
            formUrl.searchParams.set(FORM_ENTRY_WORDS, totalWords.toString());
            formUrl.searchParams.set(FORM_ENTRY_ACCURACY, accuracy + '%');
            
            // Open form in new tab
            window.open(formUrl.toString(), '_blank');
            
            showToast('Skjemaet åpnes i ny fane. Klikk "Send" for å levere!', 'success');
        }

        // ============================================
        // EXPORT/IMPORT PROGRESS
        // ============================================

        function exportAllProgress() {
            const data = {
                version: 'spansk123_export_v1',
                exportDate: new Date().toISOString(),
                studentName: studentName,
                vocabData: JSON.parse(localStorage.getItem('spansk123Data_v4') || '[]'),
                grammarData: JSON.parse(localStorage.getItem('spansk123Grammar_v1') || '{}'),
                practiceHistory: practiceHistory
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `spansk-fremgang-${studentName.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Fremgang lastet ned!', 'success');
        }

        function importProgressFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        let imported = false;
                        
                        // Format 1: New export format (spansk123_export_v1)
                        if (data.version === 'spansk123_export_v1') {
                            if (data.studentName) {
                                studentName = data.studentName;
                                localStorage.setItem('spansk123_studentName', studentName);
                            }
                            if (data.vocabData) {
                                localStorage.setItem('spansk123Data_v4', JSON.stringify(data.vocabData));
                            }
                            if (data.grammarData) {
                                localStorage.setItem('spansk123Grammar_v1', JSON.stringify(data.grammarData));
                            }
                            if (data.practiceHistory) {
                                practiceHistory = data.practiceHistory;
                                savePracticeHistory();
                            }
                            imported = true;
                        }
                        // Format 2: Old vocab export format (spansk123_v4)
                        else if (data.version === 'spansk123_v4') {
                            if (data.cards) {
                                localStorage.setItem('spansk123Data_v4', JSON.stringify(data.cards));
                            }
                            imported = true;
                        }
                        // Format 3: OLD APP "Spansk Gloselæring" export (appVersion: 'spansk_v1')
                        // Has structure: { cards: [...], weeklyLog: [...], appVersion: 'spansk_v1' }
                        else if (data.appVersion === 'spansk_v1' && data.cards) {
                            const convertedCards = convertOldFormatToNew(data.cards);
                            if (convertedCards.length > 0) {
                                const existingCards = JSON.parse(localStorage.getItem('spansk123Data_v4') || '[]');
                                const mergedCards = mergeImportedCards(existingCards, convertedCards);
                                localStorage.setItem('spansk123Data_v4', JSON.stringify(mergedCards));
                                
                                // Convert weeklyLog to practiceHistory if available
                                if (data.weeklyLog && Array.isArray(data.weeklyLog)) {
                                    const convertedHistory = data.weeklyLog.map(entry => ({
                                        date: entry.date?.split('T')[0] || entry.date,
                                        words: entry.cardsReviewed || entry.reviewed || entry.cards || 0,
                                        correct: entry.correct || Math.round((entry.cardsReviewed || 0) * 0.8),
                                        sessions: 1
                                    }));
                                    practiceHistory = [...practiceHistory, ...convertedHistory];
                                    // Remove duplicates by date
                                    const seen = new Set();
                                    practiceHistory = practiceHistory.filter(entry => {
                                        if (seen.has(entry.date)) return false;
                                        seen.add(entry.date);
                                        return true;
                                    });
                                    savePracticeHistory();
                                }
                                
                                // Count how many had progress
                                const withProgress = data.cards.filter(c => c.level > 0 || c.reviews > 0).length;
                                showToast(`Importerte fremgang for ${withProgress} gloser!`, 'success');
                                imported = true;
                            }
                        }
                        // Format 4: Raw array from old app (norwegian/spanish fields)
                        else if (Array.isArray(data) && data.length > 0 && data[0].norwegian && data[0].spanish) {
                            const convertedCards = convertOldFormatToNew(data);
                            if (convertedCards.length > 0) {
                                // Merge with existing cards
                                const existingCards = JSON.parse(localStorage.getItem('spansk123Data_v4') || '[]');
                                const mergedCards = mergeImportedCards(existingCards, convertedCards);
                                localStorage.setItem('spansk123Data_v4', JSON.stringify(mergedCards));
                                showToast(`Importerte ${convertedCards.length} gloser fra gammel app!`, 'success');
                                imported = true;
                            }
                        }
                        // Format 5: Direct localStorage dump from old app
                        else if (data.spanskSRData) {
                            const oldCards = typeof data.spanskSRData === 'string' 
                                ? JSON.parse(data.spanskSRData) 
                                : data.spanskSRData;
                            const convertedCards = convertOldFormatToNew(oldCards);
                            if (convertedCards.length > 0) {
                                const existingCards = JSON.parse(localStorage.getItem('spansk123Data_v4') || '[]');
                                const mergedCards = mergeImportedCards(existingCards, convertedCards);
                                localStorage.setItem('spansk123Data_v4', JSON.stringify(mergedCards));
                                imported = true;
                            }
                        }
                        
                        if (imported) {
                            showToast('Fremgang importert! Laster på nytt...', 'success');
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            showToast('Ukjent filformat', 'error');
                        }
                        
                    } catch (error) {
                        console.error('Import error:', error);
                        showToast('Kunne ikke lese filen: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Convert old app format to new format
        function convertOldFormatToNew(oldCards) {
            return oldCards.map((oldCard, index) => {
                // Find matching card in glossary to get category
                const matchingGlossary = glossary.find(g => 
                    g[0].toLowerCase() === oldCard.norwegian?.toLowerCase() ||
                    g[1].toLowerCase() === oldCard.spanish?.toLowerCase()
                );
                const category = matchingGlossary ? matchingGlossary[2] : 'importert';
                
                // Convert level (0-5) to repetitions
                // Old: level 0=new, 1-2=learning, 3-5=mastered
                // New: repetitions 0-2=learning, 3+=mastered
                const repetitions = oldCard.level || 0;
                const easeFactor = oldCard.level >= 3 ? 2.5 : 2.0;
                
                return {
                    id: index,
                    no: oldCard.norwegian,
                    es: oldCard.spanish,
                    norsk: oldCard.norwegian,
                    spansk: oldCard.spanish,
                    category: category,
                    noEs: {
                        easeFactor: easeFactor,
                        interval: oldCard.interval || 0,
                        repetitions: repetitions,
                        nextReview: oldCard.nextReview,
                        reviews: oldCard.reviews || 0,
                        correct: oldCard.correct || 0
                    },
                    esNo: {
                        easeFactor: easeFactor,
                        interval: oldCard.interval || 0,
                        repetitions: Math.max(0, repetitions - 1),
                        nextReview: oldCard.nextReview,
                        reviews: Math.floor((oldCard.reviews || 0) / 2),
                        correct: Math.floor((oldCard.correct || 0) / 2)
                    }
                };
            });
        }

        // Merge imported cards with existing, updating progress for duplicates
        function mergeImportedCards(existing, imported) {
            const merged = [...existing];
            let updated = 0;
            let added = 0;
            
            imported.forEach(newCard => {
                // Find matching card in existing
                const existingIndex = merged.findIndex(c => 
                    (c.no?.toLowerCase() === newCard.no?.toLowerCase() || 
                     c.norsk?.toLowerCase() === newCard.norsk?.toLowerCase() ||
                     c.no?.toLowerCase() === newCard.norsk?.toLowerCase() ||
                     c.norsk?.toLowerCase() === newCard.no?.toLowerCase()) &&
                    (c.es?.toLowerCase() === newCard.es?.toLowerCase() ||
                     c.spansk?.toLowerCase() === newCard.spansk?.toLowerCase() ||
                     c.es?.toLowerCase() === newCard.spansk?.toLowerCase() ||
                     c.spansk?.toLowerCase() === newCard.es?.toLowerCase())
                );
                
                if (existingIndex >= 0) {
                    // Update existing card with imported progress if better
                    const existingCard = merged[existingIndex];
                    
                    // Update noEs (norsk -> spansk) progress
                    if (newCard.noEs && newCard.noEs.repetitions > (existingCard.noEs?.repetitions || 0)) {
                        existingCard.noEs = { ...existingCard.noEs, ...newCard.noEs };
                        updated++;
                    }
                    
                    // Update esNo (spansk -> norsk) progress
                    if (newCard.esNo && newCard.esNo.repetitions > (existingCard.esNo?.repetitions || 0)) {
                        existingCard.esNo = { ...existingCard.esNo, ...newCard.esNo };
                    }
                    
                    // Update total reviews/correct
                    if (newCard.reviews > (existingCard.reviews || 0)) {
                        existingCard.reviews = newCard.reviews;
                        existingCard.correct = newCard.correct;
                    }
                } else {
                    // Add new card
                    newCard.id = merged.length;
                    merged.push(newCard);
                    added++;
                }
            });
            
            console.log(`Import: ${updated} kort oppdatert, ${added} nye lagt til`);
            return merged;
        }

        // Check for old app data in localStorage and offer to import
        function checkForOldAppData() {
            const oldData = localStorage.getItem('spanskSRData');
            if (oldData && !localStorage.getItem('spansk123_oldImportDone')) {
                try {
                    const oldCards = JSON.parse(oldData);
                    if (oldCards.length > 0) {
                        const reviewedCards = oldCards.filter(c => c.reviews > 0).length;
                        if (reviewedCards > 0 && confirm(
                            `Vi fant fremgang fra den gamle appen!\n\n` +
                            `${reviewedCards} av ${oldCards.length} gloser har blitt øvd på.\n\n` +
                            `Vil du importere denne fremgangen?`
                        )) {
                            const convertedCards = convertOldFormatToNew(oldCards);
                            const existingCards = JSON.parse(localStorage.getItem('spansk123Data_v4') || '[]');
                            const mergedCards = mergeImportedCards(existingCards, convertedCards);
                            localStorage.setItem('spansk123Data_v4', JSON.stringify(mergedCards));
                            localStorage.setItem('spansk123_oldImportDone', 'true');
                            showToast(`Importerte fremgang for ${reviewedCards} gloser!`, 'success');
                            loadData();
                            updateStats();
                        } else {
                            localStorage.setItem('spansk123_oldImportDone', 'true');
                        }
                    }
                } catch (e) {
                    console.error('Could not parse old data:', e);
                }
            }
        }

        // ============================================
        // VERB MODE STATE
        // ============================================

        let selectedVerbs = new Set();
        let selectedTense = 'presente';
        let verbSessionExercises = [];
        let verbCurrentIndex = 0;
        let verbStats = { correct: 0, total: 0 };
        let verbAnswerPending = false;

        // ============================================
        // NAVIGATION
        // ============================================

        function showPage(page) {
            // Hide all pages
            document.getElementById('vocabPage').classList.add('hidden');
            document.getElementById('brainmapPage').classList.add('hidden');
            document.getElementById('verbPage').classList.add('hidden');
            document.getElementById('grammarPage').classList.add('hidden');
            document.getElementById('homeworkPage').classList.add('hidden');
            document.getElementById('gamesPage').classList.add('hidden');
            
            // Stop any running game
            if (viGameActive) {
                viStopFalling();
                viGameActive = false;
            }
            
            // Remove active from all nav links
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            
            // Show selected page
            if (page === 'vocab') {
                document.getElementById('vocabPage').classList.remove('hidden');
                document.getElementById('navVocab').classList.add('active');
                document.getElementById('vocabSettings').classList.remove('hidden');
                document.getElementById('vocabStudy').classList.add('hidden');
                updateStats();
            } else if (page === 'brainmap') {
                document.getElementById('brainmapPage').classList.remove('hidden');
                document.getElementById('navBrainmap').classList.add('active');
                renderBrainmap();
            } else if (page === 'verbs') {
                document.getElementById('verbPage').classList.remove('hidden');
                document.getElementById('navVerbs').classList.add('active');
                document.getElementById('verbSettings').classList.remove('hidden');
                document.getElementById('verbExercise').classList.add('hidden');
                renderVerbSelector();
            } else if (page === 'grammar') {
                document.getElementById('grammarPage').classList.remove('hidden');
                document.getElementById('navGrammar').classList.add('active');
                document.getElementById('grammarSettings').classList.remove('hidden');
                document.getElementById('grammarExercise').classList.add('hidden');
                renderGrammarTopics();
            } else if (page === 'homework') {
                document.getElementById('homeworkPage').classList.remove('hidden');
                document.getElementById('navHomework').classList.add('active');
                renderHomeworkPage();
            } else if (page === 'games') {
                document.getElementById('gamesPage').classList.remove('hidden');
                document.getElementById('navGames').classList.add('active');
                showGamesMenu();
            }
        }
        // VOCABULARY DATABASE
        // ============================================
        
        const glossary = [
            // TALL
            ["11", "once", "tall"],
            ["12", "doce", "tall"],
            ["13", "trece", "tall"],
            ["14", "catorce", "tall"],
            ["15", "quince", "tall"],
            ["16", "dieciséis", "tall"],
            ["17", "diecisiete", "tall"],
            ["18", "dieciocho", "tall"],
            ["19", "diecinueve", "tall"],
            ["20", "veinte", "tall"],
            ["26", "veintiséis", "tall"],
            ["30", "treinta", "tall"],
            ["39", "treinta y nueve", "tall"],
            ["40", "cuarenta", "tall"],
            ["43", "cuarenta y tres", "tall"],
            ["50", "cincuenta", "tall"],
            ["54", "cincuenta y cuatro", "tall"],
            ["60", "sesenta", "tall"],
            ["62", "sesenta y dos", "tall"],
            ["70", "setenta", "tall"],
            ["78", "setenta y ocho", "tall"],
            ["80", "ochenta", "tall"],
            ["87", "ochenta y siete", "tall"],
            ["90", "noventa", "tall"],
            ["91", "noventa y uno", "tall"],
            ["100", "cien", "tall"],
            ["110", "ciento diez", "tall"],
            ["123", "ciento veintitres", "tall"],
            ["200", "doscientos", "tall"],
            ["245", "dos cientos cuarenta y cinco", "tall"],
            ["300", "trescientos", "tall"],
            ["400", "cuatrocientos", "tall"],
            ["500 på spansk", "quinientos", "tall"],
            ["600", "seiscientos", "tall"],
            ["700", "setecientos", "tall"],
            ["800", "ochocientos", "tall"],
            ["900", "novecientos", "tall"],
            ["1000", "mil", "tall"],
            ["870", "ochocientos setenta", "tall"],
            ["1200", "mil doscientos", "tall"],
            ["1589", "mil quinientos ochenta y nueve", "tall"],
            ["2000", "dos mil", "tall"],
            ["4000", "cuatro mil", "tall"],
            ["10 000", "diez mil", "tall"],
            ["1945", "mil novecientos cuarenta y cinco", "tall"],
            ["1996", "mil novecientos noventa y seis", "tall"],
            ["2011", "dos mil once", "tall"],
            ["2019", "dos mil diecinueve", "tall"],
            
            // BURSDAG
            ["Gratulerer med dagen", "¡Feliz cumpleaños!", "bursdag"],
            ["Når har du bursdag?", "¿Cuándo es tu cumpleaños?", "bursdag"],
            ["Bursdagen min er 7. juli", "Mi cumpleaños es el siete de julio", "bursdag"],
            ["Når er bursdagen til Marius?", "¿Cuándo es el cumpleaños de Marius?", "bursdag"],
            ["Bursdagen til Marius er 26. juni", "El cumpleaños de Marius es el veintiseis de junio", "bursdag"],
            
            // LAND
            ["Norge", "Noruega", "land"],
            ["Sverige", "Suecia", "land"],
            ["Danmark", "Dinamarca", "land"],
            ["Finland", "Finlandia", "land"],
            ["Island", "Islandia", "land"],
            ["Russland på spansk", "Rusia", "land"],
            ["Tyskland", "Alemania", "land"],
            ["Østerrike", "Austria", "land"],
            ["Nederland", "Los Países Bajos", "land"],
            ["Frankrike", "Francia", "land"],
            ["Italia", "Italia", "land"],
            ["Belgia", "Bélgica", "land"],
            ["Spania", "España", "land"],
            ["Portugal", "Portugal", "land"],
            ["England", "Inglaterra", "land"],
            ["Irland", "Irlanda", "land"],
            ["Hellas", "Grecia", "land"],
            ["Sveits (spansk)", "Suiza", "land"],
            
            // FARGER
            ["rød", "rojo", "farger"],
            ["blå", "azul", "farger"],
            ["gul", "amarillo", "farger"],
            ["grønn", "verde", "farger"],
            ["grå", "gris", "farger"],
            ["brun", "marrón", "farger"],
            ["hvit", "blanco", "farger"],
            ["svart", "negro", "farger"],
            ["rosa", "rosa", "farger"],
            ["lilla (v)", "violeta", "farger"],
            ["oransje", "naranja", "farger"],
            ["turkis", "turquesa", "farger"],
            
            // VÆR
            ["vinter", "el invierno", "vær"],
            ["vår", "la primavera", "vær"],
            ["sommer", "el verano", "vær"],
            ["høst", "el otoño", "vær"],
            ["det regner", "llueve", "vær"],
            ["det snør", "nieva", "vær"],
            ["det er klart / skyfritt", "está despejado", "vær"],
            ["det er overskyet", "está nublado", "vær"],
            ["det er fem varmegrader", "hace cinco grados sobre cero", "vær"],
            ["det er fem kuldegrader", "hace cinco grados bajo cero", "vær"],
            ["det er fint vær", "hace buen tiempo", "vær"],
            ["det er dårlig vær", "hace mal tiempo", "vær"],
            ["det er sol", "hace sol", "vær"],
            ["det er vind / det blåser", "hace viento", "vær"],
            ["det er varmt", "hace calor", "vær"],
            ["det er kaldt", "hace frío", "vær"],
            
            // HØYTIDER
            ["jula", "La Navidad", "høytider"],
            ["nyttårsaften", "La Nochevieja", "høytider"],
            ["julaften", "La Nochebuena", "høytider"],
            ["sankthansaften", "La Noche de San Juan", "høytider"],
            ["påskeuken", "La Semana Santa", "høytider"],
            ["Valentinsdagen", "El Día de San Valentín", "høytider"],
            ["nasjonaldagen", "El día Nacional", "høytider"],
            ["de hellige tre kongers aften", "El Día de los Reyes", "høytider"],
            ["allehelgensdagen", "El Día de los Muertos", "høytider"],
            ["fødselsdag", "El Cumpleaños", "høytider"],
            ["konfirmasjon", "La Comunión", "høytider"],
            ["barnedåp", "El Bautizo", "høytider"],
            ["bryllup", "La Boda", "høytider"],
            ["begravelse (f)", "el Funeral", "høytider"],
            ["begravelse (ord på e)", "entierro", "høytider"],
            
            // UTSEENDE
            ["høy", "alto", "utseende"],
            ["lav", "bajo", "utseende"],
            ["mørkhåret", "moreno", "utseende"],
            ["blond", "rubio", "utseende"],
            ["rødhåret", "pelirrojo", "utseende"],
            ["skallet", "calvo", "utseende"],
            ["pen/kjekk", "guapo", "utseende"],
            ["vakker", "hermoso", "utseende"],
            ["blå øyne", "los ojos azules", "utseende"],
            ["brune øyne", "los ojos negros", "utseende"],
            ["grønne øyne", "los ojos verdes", "utseende"],
            ["mørkt hår", "el pelo moreno", "utseende"],
            ["blondt hår", "el pelo rubio", "utseende"],
            ["rødt hår", "el pelo pelirrojo", "utseende"],
            ["kort hår", "el pelo corto", "utseende"],
            ["langt hår", "el pelo largo", "utseende"],
            ["rett hår", "el pelo liso", "utseende"],
            ["krøllete hår", "el pelo rizado", "utseende"],
            ["hestehale", "la cola de caballo", "utseende"],
            ["pannelugg", "el flequillo", "utseende"],
            ["fletter", "las trenzas", "utseende"],
            ["briller", "las gafas", "utseende"],
            ["skjegg", "la barba", "utseende"],
            ["bart", "el bigote", "utseende"],
            ["fregner", "las pecas", "utseende"],
            ["smilehull", "los hoyuelos", "utseende"],
            ["arr", "la cicatriz", "utseende"],
            
            // PERSONLIGHET
            ["kjedelig", "aburrido", "personlighet"],
            ["omtenksom", "cariñoso", "personlighet"],
            ["morsom", "gracioso", "personlighet"],
            ["pratsom", "hablador", "personlighet"],
            ["utålmodig", "impaciente", "personlighet"],
            ["intelligent", "inteligente", "personlighet"],
            ["ryddig", "ordenado", "personlighet"],
            ["tålmodig", "paciente", "personlighet"],
            ["ansvarsfull", "responsable", "personlighet"],
            ["snill/ hyggelig", "simpático", "personlighet"],
            ["sosial", "sociable", "personlighet"],
            ["sta", "terco", "personlighet"],
            ["sjenert", "tímido", "personlighet"],
            ["lat (v)", "vago", "personlighet"],
            
            // FAMILIE
            ["bror", "el hermano", "familie"],
            ["søster", "la hermana", "familie"],
            ["fetter", "el primo", "familie"],
            ["kusine", "la prima", "familie"],
            ["tante", "la tía", "familie"],
            ["onkel", "el tío", "familie"],
            ["mor", "la madre", "familie"],
            ["far", "el padre", "familie"],
            ["bestemor", "la abuela", "familie"],
            ["bestefar", "el abuelo", "familie"],
            ["kjæreste", "el novio", "familie"],
            ["stefar", "el padrastro", "familie"],
            ["stemor", "la madrastra", "familie"],
            ["stebror", "el hermanastro", "familie"],
            ["stesøster", "la hermanastra", "familie"],
            ["halvbror", "el medio hermano", "familie"],
            ["halvsøster", "la media hermana", "familie"],
            ["storebror", "el hermano mayor", "familie"],
            ["lillesøster", "la hermana menor", "familie"],
            
            // FAMILIE-SETNINGER
            ["Familien min består av fem personer", "Mi familia consiste de cinco personas", "familie-setninger"],
            ["Hvem bor du sammen med?", "¿Con quién vives?", "familie-setninger"],
            ["Jeg bor sammen med moren og broren min", "Vivo con mi madre y mi hermano", "familie-setninger"],
            ["Foreldrene mine er skilt", "Mis padres están divorciados", "familie-setninger"],
            ["Foreldrene mine er gift", "Mis padres están casados", "familie-setninger"],
            ["Hva heter broren din?", "¿Cómo se llama tu hermano?", "familie-setninger"],
            ["Broren min heter..", "Mi hermano se llama..", "familie-setninger"],
            ["Hvor mange år er broren din?", "¿Cuántos años tiene tu hermano?", "familie-setninger"],
            ["Broren min er åtte år", "Mi hermano tiene ocho años", "familie-setninger"],
            
            // KLÆR
            ["å ha på seg", "llevar", "klær"],
            ["å kle på seg", "ponerse", "klær"],
            ["støvler", "las botas", "klær"],
            ["t-skjorte", "la camiseta", "klær"],
            ["bikini", "el biquini", "klær"],
            ["skjorte", "la camisa", "klær"],
            ["jeans", "los vaqueros", "klær"],
            ["lue", "el gorro", "klær"],
            ["caps", "la gorra", "klær"],
            ["belte", "el cinturón", "klær"],
            ["sokker", "los calcetines", "klær"],
            ["genser (j)", "el jersey", "klær"],
            ["tøfler", "las zapatillas", "klær"],
            ["sko", "los zapatos", "klær"],
            ["høyhælte sko", "los zapatos de tacón", "klær"],
            ["sandaler", "las sandalias", "klær"],
            ["treningssko", "las zapatillas deportivas", "klær"],
            ["jakke", "la chaqueta", "klær"],
            ["kjole", "el vestido", "klær"],
            ["skjørt", "la falda", "klær"],
            ["håndveske", "el bolso", "klær"],
            ["solbriller", "las gafas de sol", "klær"],
            ["skjerf", "la bufanda", "klær"],
            ["sjal", "el chal", "klær"],
            ["hatt", "el sombrero", "klær"],
            ["lommetørkle", "el pañuelo", "klær"],
            ["slips", "la corbata", "klær"],
            ["paraply", "el paraguas", "klær"],
            ["ring", "el anillo", "klær"],
            ["armbånd", "la pulsera", "klær"],
            ["klokke", "el reloj", "klær"],
            ["smykke", "la cadena", "klær"],
            ["øreringer", "los pendientes", "klær"],
            
            // YRKER
            ["advokat", "el abogado", "yrker"],
            ["brannmann", "el bombero", "yrker"],
            ["snekker", "el carpintero", "yrker"],
            ["kokk", "el cocinero", "yrker"],
            ["tannlege", "el dentista", "yrker"],
            ["elektriker", "el electrista", "yrker"],
            ["sykepleier", "el enfermero", "yrker"],
            ["bonde", "el granjero", "yrker"],
            ["lege", "el médico", "yrker"],
            ["frisør", "el peluquero", "yrker"],
            ["journalist", "el periodista", "yrker"],
            ["politi", "el policía", "yrker"],
            ["lærer (p)", "el profesor", "yrker"],
            ["dyrlege", "el veterinario", "yrker"],
            ["hva jobber du med?", "¿en qué trabajas?", "yrker"],
            ["hvor jobber du?", "¿Dónde trabajas?", "yrker"],
            ["Når jobber du?", "¿Cuándo trabajas?", "yrker"],
            ["Hva jobber moren din med?", "¿En qué trabaja tu madre?", "yrker"],
            
            // HOBBYER
            ["golf", "el golf", "hobbyer"],
            ["amerikansk fotball", "el fútbol americano", "hobbyer"],
            ["håndball", "el balonmano", "hobbyer"],
            ["volleyball", "el voleibol", "hobbyer"],
            ["badminton", "bádminton", "hobbyer"],
            ["innebandy", "el bandy sala", "hobbyer"],
            ["tennis", "el tenis", "hobbyer"],
            ["bordtennis", "el tenis de mesa", "hobbyer"],
            ["ishockey", "el hockey sobre hielo", "hobbyer"],
            ["dataspill", "videojuegos", "hobbyer"],
            ["langrenn", "esquí de fondo", "hobbyer"],
            ["alpint", "esquí alpino", "hobbyer"],
            ["å handle", "ir de compras", "hobbyer"],
            ["å sykle", "montar en bici", "hobbyer"],
            ["å synge", "cantar", "hobbyer"],
            ["å se på TV", "ver la tele", "hobbyer"],
            ["å spille gitar", "tocar la guitarra", "hobbyer"],
            ["å spille piano", "tocar el piano", "hobbyer"],
            ["å trene", "entrenar", "hobbyer"],
            ["å høre musikk", "escuchar música", "hobbyer"],
            ["å være med venner", "estar con amigos", "hobbyer"],
            ["å dra ut med venner", "salir con mis amigos", "hobbyer"],
            ["å danse", "bailar", "hobbyer"],
            ["å gå tur", "hacer cenderismo", "hobbyer"],
            ["å slappe av", "relajar", "hobbyer"],
            ["å surfe på internett", "navegar por internet", "hobbyer"],
            
            // KLOKKA
            ["Har du klokke?", "¿Tienes hora?", "klokka"],
            ["Vet du hvor mye klokka er?", "Perdón, ¿Sabes qué hora es?", "klokka"],
            ["Når skal du spise?", "¿A qué hora vas a comer?", "klokka"],
            ["jeg skal spise klokka åtte", "voy a comer a las ocho", "klokka"],
            ["Den er 13:00", "Es la una", "klokka"],
            ["Den er kvart over ett", "es la una y cuarto", "klokka"],
            ["Den er halv to", "es la una y media", "klokka"],
            ["Den er to", "son las dos", "klokka"],
            ["den er ti over halv tre", "son las tres menos veinte", "klokka"],
            ["den er ti på tre", "son las tres menos diez", "klokka"],
            ["klokken åtte om morgenen", "a las ocho de la mañana", "klokka"],
            ["klokka seks på ettermiddagen", "a las seis de la tarde", "klokka"],
            ["klokka tolv på natta", "a las doce de la noche", "klokka"],
            ["Klokken er akkurat 5", "Son las cinco en punto", "klokka"],
            
            // TIDSUTTRYKK
            ["hver dag", "todos los días", "tidsuttrykk"],
            ["på mandag", "el lunes", "tidsuttrykk"],
            ["på mandager", "los lunes", "tidsuttrykk"],
            ["på morgenen", "por la mañana", "tidsuttrykk"],
            ["for noen dager siden", "hace unos días", "tidsuttrykk"],
            ["hver uke", "cada semana", "tidsuttrykk"],
            ["ofte", "a menudo", "tidsuttrykk"],
            ["sjelden", "raramente", "tidsuttrykk"],
            ["på ettermiddagen", "por la tarde", "tidsuttrykk"],
            ["før", "antes", "tidsuttrykk"],
            ["i kveld", "esta noche", "tidsuttrykk"],
            ["i morgen", "mañana", "tidsuttrykk"],
            ["i går", "ayer", "tidsuttrykk"],
            ["på kvelden", "por la noche", "tidsuttrykk"],
            ["etter / etterpå", "después", "tidsuttrykk"],
            
            // SKOLE
            ["elev", "el alumno", "skole"],
            ["lærer (p)", "el profesor", "skole"],
            ["skoletime", "la clase", "skole"],
            ["skoleklasse", "la clase", "skole"],
            ["tavle", "la pizarra", "skole"],
            ["kart", "el mapa", "skole"],
            ["papirkurv", "la papelera", "skole"],
            ["bok", "el libro", "skole"],
            ["PC", "el ordenador", "skole"],
            ["ungdomsskolen", "la E.S.O", "skole"],
            ["pult", "la mesa", "skole"],
            ["stol", "la silla", "skole"],
            ["sekk", "la mochila", "skole"],
            ["pennal", "el estuche", "skole"],
            ["blyant", "el lápiz", "skole"],
            ["penn", "el bolígrafo", "skole"],
            ["viskelær", "la goma", "skole"],
            ["blyantspisser", "el sacapuntas", "skole"],
            ["linjal", "la regla", "skole"],
            ["videregående", "el bachillerato", "skole"],
            
            // FAG
            ["engelsk", "el inglés", "fag"],
            ["matte", "las matemáticas", "fag"],
            ["historie", "la historia", "fag"],
            ["samfunnsfag", "las ciencias sociales", "fag"],
            ["naturfag", "las ciencias naturales", "fag"],
            ["kroppsøving", "la educación física", "fag"],
            ["kunst og håndtverk", "las artes manuales", "fag"],
            ["religion / KRLE", "el religión", "fag"],
            
            // HJEM
            ["rom", "la habitación", "hjem"],
            ["rom (annet ord, C)", "el cuarto", "hjem"],
            ["bad", "el baño", "hjem"],
            ["spisestue", "el comedor", "hjem"],
            ["gang", "el pasillo", "hjem"],
            ["loft", "el ático", "hjem"],
            ["dør", "la puerta", "hjem"],
            ["soverom", "el dormitorio", "hjem"],
            ["arbeidsrom", "el cuarto de trabajo", "hjem"],
            ["stue (c)", "el cuarto de estar", "hjem"],
            ["kjøkken", "la cocina", "hjem"],
            ["kjeller", "el sótano", "hjem"],
            ["vindu", "la ventana", "hjem"],
            ["hus", "la casa", "hjem"],
            
            // MØBLER
            ["møbel", "el mueble", "møbler"],
            ["sofa", "el sofá", "møbler"],
            ["bord", "la mesa", "møbler"],
            ["TV", "el televisor", "møbler"],
            ["skap", "el armario", "møbler"],
            ["plakat", "el póster", "møbler"],
            ["kjøleskap (n)", "la nevera", "møbler"],
            ["skrivebord", "el escritorio", "møbler"],
            ["bokhylle", "la estantería", "møbler"],
            ["kommode", "la cómoda", "møbler"],
            ["lenestol", "el sillón", "møbler"],
            ["teppe", "la alfombra", "møbler"],
            ["oppvaskmaskin", "el lavavajillas", "møbler"],
            ["seng", "la cama", "møbler"],
            ["lampe", "la lámpara", "møbler"],
            ["bilde / maleri (c)", "el cuadro", "møbler"],
            ["ovn", "el horno", "møbler"],
            ["speil", "el espejo", "møbler"],
            
            // GUSTAR
            ["jeg liker", "me gusta", "gustar"],
            ["jeg liker ikke", "no me gusta", "gustar"],
            ["du liker", "te gusta", "gustar"],
            ["du liker ikke", "no te gusta", "gustar"],
            ["han/hun liker", "le gusta", "gustar"],
            ["jeg liker denne boken", "me gusta este libro", "gustar"],
            ["jeg liker disse bøkene", "me gustan estos libros", "gustar"],
            ["jeg elsker (me ....)", "me encanta", "gustar"],
            ["jeg blir irritert av", "me molesta", "gustar"],
            
            // RUTINER
            ["jeg våkner", "me despierto", "rutiner"],
            ["jeg står opp", "me levanto", "rutiner"],
            ["jeg dusjer", "me ducho", "rutiner"],
            ["jeg pusser tennene", "me cepillo los dientes", "rutiner"],
            ["jeg sminker meg", "me maquillo", "rutiner"],
            ["jeg barberer meg", "me afeito", "rutiner"],
            ["jeg børster håret", "me peino", "rutiner"],
            ["jeg kler på meg", "me visto", "rutiner"],
            ["jeg legger meg", "me acuesto", "rutiner"],
            ["jeg spiser frokost", "desayuno", "rutiner"],
            ["jeg går ut av huset", "salgo de la casa", "rutiner"],
            ["jeg drar på skolen", "voy a la escuela", "rutiner"],
            ["jeg spiser lunsj", "almuerzo", "rutiner"],
            ["jeg drar hjem", "voy a casa", "rutiner"],
            ["jeg drar på trening", "voy al entrenamiento", "rutiner"],
            ["jeg spiser middag", "ceno", "rutiner"],
            ["jeg sover", "duermo", "rutiner"],
            ["jeg står opp tidlig", "me despierto temprano", "rutiner"],
            ["jeg tar på meg en t-skjorte", "me pongo una camiseta", "rutiner"],
            ["jeg går til skolen", "voy a pie a la escuela", "rutiner"],
            
            // VERBBØYING
            ["bøying av verbet SER, som betyr å være", "soy, eres, es, somos, sois, son", "verbbøying"],
            ["bøying av verbet tener, som betyr å ha", "tengo, tienes, tiene, tenemos, tenéis, tienen", "verbbøying"],
            ["bøying av verbet ir", "voy, vas, va, vamos, váis, van", "verbbøying"],
            ["bøying av verbet estar, som betyr å være/å befinne seg", "estoy, estás, está, estamos, estáis, están", "verbbøying"],
            ["bøying av verbet hablar, som betyr å snakke", "hablo, hablas, habla, hablamos, habláis, hablan", "verbbøying"],
            ["bøying av verbet comer, som betyr å spise", "como, comes, come, comemos, coméis, comen", "verbbøying"],
            ["bøying av verbet vivir, som betyr å spise", "vivo, vives, vive, vivimos, vivís, viven", "verbbøying"],
            ["bøying av verbet poder, som betyr å kunne", "puedo, puedes, puede, podemos, podéis, pueden", "verbbøying"],
            ["bøying av verbet decir, som betyr å si", "digo, dices, dice, decimos, decís, dicen", "verbbøying"],
            ["bøying av verbet hacer, som betyr å gjøre", "hago, haces, hace, hacemos, hacéis, hacen", "verbbøying"],
            ["bøying av verbet querer, som betyr å ville", "quiero, quieres, quiere, queremos, queréis, quieren", "verbbøying"],
            ["bøying av verbet saber, som betyr å vite", "sé, sabes, sabe, sabemos, sabéis, saben", "verbbøying"],
            ["bøying av verbet salir, som betyr å gå ut", "salgo, sales, sale, salimos, salís, salen", "verbbøying"],
            ["bøying av verbet venir, som betyr å komme", "vengo, vienes, viene, venimos, venís, vienen", "verbbøying"],
            
            // FREMTID
            ["jeg skal gjøre noe", "voy a hacer algo", "fremtid"],
            ["hva skal du gjøre i dag?", "¿Qué vas a hacer hoy?", "fremtid"],
            ["hva skal du gjøre i morgen?", "¿Qué vas a hacer mañana?", "fremtid"],
            ["I dag skal jeg være med venner", "Hoy voy a estar con mis amigos", "fremtid"],
            ["I morgen skal jeg besøke bestemora mi", "Mañana voy a visitar mi abuela", "fremtid"],
            ["Hva skal du gjøre til neste år?", "¿Qué vas a hacer el año que viene?", "fremtid"],
            ["Neste år skal jeg begynne på videregående", "El año que viene voy a empezar el bachillerato", "fremtid"],
            
            // VERB
            ["å snakke", "hablar", "verb"],
            ["å jobbe", "trabajar", "verb"],
            ["å trene", "entrenar", "verb"],
            ["å danse", "bailar", "verb"],
            ["å kjøpe", "comprar", "verb"],
            ["å spise", "comer", "verb"],
            ["å drikke", "beber", "verb"],
            ["å lese", "leer", "verb"],
            ["å studere", "estudiar", "verb"],
            ["å bo/ å leve", "vivir", "verb"],
            ["å skrive", "escribir", "verb"],
            ["å høre", "escuchar", "verb"],
            ["å se", "ver", "verb"],
            ["å lære", "aprender", "verb"],
            ["å vinne", "ganar", "verb"],
            ["å glemme", "olvidar", "verb"],
            ["å hjelpe", "ayudar", "verb"],
            ["å synge", "cantar", "verb"],
            ["å vente", "esperar", "verb"],
            ["å spørre", "preguntar", "verb"],
            ["å betale", "pagar", "verb"],
            ["å reise", "viajar", "verb"],
            
            // BINDEORD
            ["og", "y", "bindeord"],
            ["eller", "o", "bindeord"],
            ["men", "pero", "bindeord"],
            ["også", "también", "bindeord"],
            ["alltid", "siempre", "bindeord"],
            ["aldri", "nunca", "bindeord"],
            ["noen ganger", "a veces", "bindeord"],
            ["vanligvis", "normalmente", "bindeord"],
            ["fordi", "porque", "bindeord"],
            ["derfor", "por eso", "bindeord"],
            ["kanskje", "quizás", "bindeord"],
            ["dermed / deretter / så", "entonces", "bindeord"],
            ["i tillegg / dessuten", "además", "bindeord"],
            ["selv om", "aunque", "bindeord"],
            ["allikevel", "sin embargo", "bindeord"],
            ["på den ene siden", "por un lado", "bindeord"],
            ["på den andre siden", "por otro lado", "bindeord"],
            ["først og fremst", "sobretodo", "bindeord"],
            ["samtidig", "al mismo tiempo", "bindeord"],
            ["selvfølgelig", "claro", "bindeord"],
            ["jeg skal snakke om", "voy a hablar sobre", "bindeord"],
            ["takk for oppmerksomheten", "gracias por su atención", "bindeord"]
        ];

        // ============================================
        // VERB CONJUGATION DATABASE
        // ============================================

        const verbDatabase = {
            // REGULAR -AR VERBS
            hablar: {
                infinitive: "hablar",
                translation: "å snakke",
                type: "regular -ar",
                presente: ["hablo", "hablas", "habla", "hablamos", "habláis", "hablan"],
                participio: "hablado"
            },
            trabajar: {
                infinitive: "trabajar",
                translation: "å jobbe",
                type: "regular -ar",
                presente: ["trabajo", "trabajas", "trabaja", "trabajamos", "trabajáis", "trabajan"],
                participio: "trabajado"
            },
            estudiar: {
                infinitive: "estudiar",
                translation: "å studere",
                type: "regular -ar",
                presente: ["estudio", "estudias", "estudia", "estudiamos", "estudiáis", "estudian"],
                participio: "estudiado"
            },
            bailar: {
                infinitive: "bailar",
                translation: "å danse",
                type: "regular -ar",
                presente: ["bailo", "bailas", "baila", "bailamos", "bailáis", "bailan"],
                participio: "bailado"
            },
            comprar: {
                infinitive: "comprar",
                translation: "å kjøpe",
                type: "regular -ar",
                presente: ["compro", "compras", "compra", "compramos", "compráis", "compran"],
                participio: "comprado"
            },
            escuchar: {
                infinitive: "escuchar",
                translation: "å høre",
                type: "regular -ar",
                presente: ["escucho", "escuchas", "escucha", "escuchamos", "escucháis", "escuchan"],
                participio: "escuchado"
            },
            cantar: {
                infinitive: "cantar",
                translation: "å synge",
                type: "regular -ar",
                presente: ["canto", "cantas", "canta", "cantamos", "cantáis", "cantan"],
                participio: "cantado"
            },
            
            // REGULAR -ER VERBS
            comer: {
                infinitive: "comer",
                translation: "å spise",
                type: "regular -er",
                presente: ["como", "comes", "come", "comemos", "coméis", "comen"],
                participio: "comido"
            },
            beber: {
                infinitive: "beber",
                translation: "å drikke",
                type: "regular -er",
                presente: ["bebo", "bebes", "bebe", "bebemos", "bebéis", "beben"],
                participio: "bebido"
            },
            leer: {
                infinitive: "leer",
                translation: "å lese",
                type: "regular -er",
                presente: ["leo", "lees", "lee", "leemos", "leéis", "leen"],
                participio: "leído"
            },
            aprender: {
                infinitive: "aprender",
                translation: "å lære",
                type: "regular -er",
                presente: ["aprendo", "aprendes", "aprende", "aprendemos", "aprendéis", "aprenden"],
                participio: "aprendido"
            },
            
            // REGULAR -IR VERBS
            vivir: {
                infinitive: "vivir",
                translation: "å bo",
                type: "regular -ir",
                presente: ["vivo", "vives", "vive", "vivimos", "vivís", "viven"],
                participio: "vivido"
            },
            escribir: {
                infinitive: "escribir",
                translation: "å skrive",
                type: "regular -ir",
                presente: ["escribo", "escribes", "escribe", "escribimos", "escribís", "escriben"],
                participio: "escrito"
            },
            
            // IRREGULAR VERBS
            ser: {
                infinitive: "ser",
                translation: "å være (permanent)",
                type: "uregelmessig",
                presente: ["soy", "eres", "es", "somos", "sois", "son"],
                participio: "sido"
            },
            estar: {
                infinitive: "estar",
                translation: "å være/befinne seg",
                type: "uregelmessig",
                presente: ["estoy", "estás", "está", "estamos", "estáis", "están"],
                participio: "estado"
            },
            tener: {
                infinitive: "tener",
                translation: "å ha",
                type: "uregelmessig",
                presente: ["tengo", "tienes", "tiene", "tenemos", "tenéis", "tienen"],
                participio: "tenido"
            },
            ir: {
                infinitive: "ir",
                translation: "å gå/dra",
                type: "uregelmessig",
                presente: ["voy", "vas", "va", "vamos", "vais", "van"],
                participio: "ido"
            },
            hacer: {
                infinitive: "hacer",
                translation: "å gjøre",
                type: "uregelmessig",
                presente: ["hago", "haces", "hace", "hacemos", "hacéis", "hacen"],
                participio: "hecho"
            },
            poder: {
                infinitive: "poder",
                translation: "å kunne",
                type: "uregelmessig",
                presente: ["puedo", "puedes", "puede", "podemos", "podéis", "pueden"],
                participio: "podido"
            },
            querer: {
                infinitive: "querer",
                translation: "å ville",
                type: "uregelmessig",
                presente: ["quiero", "quieres", "quiere", "queremos", "queréis", "quieren"],
                participio: "querido"
            },
            decir: {
                infinitive: "decir",
                translation: "å si",
                type: "uregelmessig",
                presente: ["digo", "dices", "dice", "decimos", "decís", "dicen"],
                participio: "dicho"
            },
            saber: {
                infinitive: "saber",
                translation: "å vite",
                type: "uregelmessig",
                presente: ["sé", "sabes", "sabe", "sabemos", "sabéis", "saben"],
                participio: "sabido"
            },
            venir: {
                infinitive: "venir",
                translation: "å komme",
                type: "uregelmessig",
                presente: ["vengo", "vienes", "viene", "venimos", "venís", "vienen"],
                participio: "venido"
            },
            salir: {
                infinitive: "salir",
                translation: "å gå ut",
                type: "uregelmessig",
                presente: ["salgo", "sales", "sale", "salimos", "salís", "salen"],
                participio: "salido"
            },
            ver: {
                infinitive: "ver",
                translation: "å se",
                type: "uregelmessig",
                presente: ["veo", "ves", "ve", "vemos", "veis", "ven"],
                participio: "visto"
            },
            preferir: {
                infinitive: "preferir",
                translation: "å foretrekke",
                type: "uregelmessig",
                presente: ["prefiero", "prefieres", "prefiere", "preferimos", "preferís", "prefieren"],
                participio: "preferido"
            }
        };

        const pronouns = ["yo", "tú", "él/ella", "nosotros", "vosotros", "ellos"];
        const pronounsNorwegian = ["jeg", "du", "han/hun", "vi", "dere", "de"];

        // Haber for perfect tense
        const haberPresente = ["he", "has", "ha", "hemos", "habéis", "han"];

        // ============================================
        // SM-2 ALGORITHM
        // ============================================

        const SM2 = {
            defaultEaseFactor: 2.5,
            minEaseFactor: 1.3,
            
            calculateNextReview(card, quality) {
                let { easeFactor = this.defaultEaseFactor, interval = 0, repetitions = 0 } = card;
                
                if (quality === 0) {
                    repetitions = 0;
                    interval = 0;
                    easeFactor = Math.max(this.minEaseFactor, easeFactor - 0.2);
                } else if (quality === 1) {
                    interval = repetitions === 0 ? 1 : Math.max(1, Math.round(interval * 1.2));
                    easeFactor = Math.max(this.minEaseFactor, easeFactor - 0.15);
                    repetitions++;
                } else if (quality === 2) {
                    if (repetitions === 0) interval = 1;
                    else if (repetitions === 1) interval = 3;
                    else interval = Math.round(interval * easeFactor);
                    repetitions++;
                } else if (quality === 3) {
                    if (repetitions === 0) interval = 4;
                    else if (repetitions === 1) interval = 7;
                    else interval = Math.round(interval * easeFactor * 1.3);
                    easeFactor = Math.min(3.0, easeFactor + 0.15);
                    repetitions++;
                }
                
                interval = Math.min(180, interval);
                const nextReview = new Date();
                nextReview.setDate(nextReview.getDate() + interval);
                
                return { easeFactor, interval, repetitions, nextReview: nextReview.toISOString() };
            },
            
            getIntervalText(quality, card) {
                const result = this.calculateNextReview(card, quality);
                if (result.interval === 0) return 'Nå';
                if (result.interval === 1) return '1 dag';
                if (result.interval < 7) return `${result.interval} dager`;
                if (result.interval < 30) return `${Math.round(result.interval / 7)} uker`;
                return `${Math.round(result.interval / 30)} mnd`;
            }
        };

        // ============================================
        // APP STATE
        // ============================================

        let cards = [];
        let selectedCategories = new Set();
        let sessionCards = [];
        let currentIndex = 0;
        let currentCard = null;
        let showingAnswer = false;
        let sessionStartTime = null;
        let sessionStats = { reviewed: 0, correct: 0, newLearned: 0 };

        // ============================================
        // VOCABULARY FUNCTIONS
        // ============================================

        function init() {
            loadData();
            checkForOldAppData(); // Check if user has data from old app
            populateCategories();
            updateStats();
            setupKeyboardShortcuts();
            renderVerbSelector();
            loadGrammarProgress();
            updateCategoryDropdown();
        }

        function loadData() {
            const saved = localStorage.getItem('spansk123Data_v4');
            if (saved) {
                cards = JSON.parse(saved);
                mergeNewVocabulary();
            } else {
                cards = glossary.map((item, index) => ({
                    id: index,
                    no: item[0],
                    es: item[1],
                    category: item[2],
                    noEs: { easeFactor: SM2.defaultEaseFactor, interval: 0, repetitions: 0, nextReview: null },
                    esNo: { easeFactor: SM2.defaultEaseFactor, interval: 0, repetitions: 0, nextReview: null },
                    lastReview: null,
                    reviews: 0,
                    correct: 0
                }));
                saveData();
            }
        }

        function mergeNewVocabulary() {
            const existingIds = new Set(cards.map(c => c.id));
            glossary.forEach((item, index) => {
                if (!existingIds.has(index)) {
                    cards.push({
                        id: index, no: item[0], es: item[1], category: item[2],
                        noEs: { easeFactor: SM2.defaultEaseFactor, interval: 0, repetitions: 0, nextReview: null },
                        esNo: { easeFactor: SM2.defaultEaseFactor, interval: 0, repetitions: 0, nextReview: null },
                        lastReview: null, reviews: 0, correct: 0
                    });
                }
            });
            saveData();
        }

        function saveData() {
            localStorage.setItem('spansk123Data_v4', JSON.stringify(cards));
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Vocab shortcuts
                if (!document.getElementById('vocabStudy').classList.contains('hidden')) {
                    if (!showingAnswer) {
                        if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); flipCard(); }
                    } else {
                        if (e.key === '1') { e.preventDefault(); rateCard(0); }
                        else if (e.key === '2') { e.preventDefault(); rateCard(2); }
                    }
                }
                
                // Verb shortcuts
                if (!document.getElementById('verbExercise').classList.contains('hidden')) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        checkVerbAnswer();
                    }
                }
            });
        }

        function getCategories() {
            const categories = {};
            cards.forEach(card => {
                if (!categories[card.category]) {
                    categories[card.category] = { count: 0, mastered: 0 };
                }
                categories[card.category].count++;
                if (card.noEs.repetitions >= 3 || card.esNo.repetitions >= 3) {
                    categories[card.category].mastered++;
                }
            });
            return categories;
        }

        function populateCategories() {
            const categories = getCategories();
            const grid = document.getElementById('categoryGrid');
            const sortedCategories = Object.entries(categories).sort((a, b) => a[0].localeCompare(b[0]));
            
            grid.innerHTML = sortedCategories.map(([name, data]) => `
                <div class="category-chip ${selectedCategories.has(name) ? 'selected' : ''}" 
                     onclick="toggleCategory('${name}')">
                    ${getCategoryEmoji(name)} ${capitalizeFirst(name)}
                    <span class="count">(${data.count})</span>
                </div>
            `).join('');
        }

        function getCategoryEmoji(category) {
            const emojis = {
                'tall': '🔢', 'farger': '🎨', 'bursdag': '🎂', 'land': '🌍',
                'vær': '☀️', 'høytider': '🎄', 'utseende': '👀', 'personlighet': '💭',
                'familie': '👨‍👩‍👧‍👦', 'familie-setninger': '💬', 'klær': '👕',
                'yrker': '👷', 'hobbyer': '⚽', 'klokka': '🕐', 'tidsuttrykk': '📅',
                'skole': '📚', 'fag': '📖', 'hjem': '🏠', 'møbler': '🛋️',
                'gustar': '❤️', 'rutiner': '⏰', 'verbbøying': '📝',
                'fremtid': '🔮', 'verb': '🏃', 'bindeord': '🔗'
            };
            return emojis[category] || '📌';
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function toggleCategory(name) {
            if (selectedCategories.has(name)) selectedCategories.delete(name);
            else selectedCategories.add(name);
            populateCategories();
        }

        function selectAllCategories() {
            Object.keys(getCategories()).forEach(cat => selectedCategories.add(cat));
            populateCategories();
        }

        function deselectAllCategories() {
            selectedCategories.clear();
            populateCategories();
        }

        function updateStats() {
            const filtered = getFilteredCards();
            const total = filtered.length;
            const newCards = filtered.filter(c => c.noEs.repetitions === 0 && c.esNo.repetitions === 0).length;
            const mastered = filtered.filter(c => c.noEs.repetitions >= 3 && c.esNo.repetitions >= 3).length;
            const due = getDueCards(filtered).length;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statNew').textContent = newCards;
            document.getElementById('statDue').textContent = due;
            document.getElementById('statMastered').textContent = mastered;

            const masteredPercent = total > 0 ? (mastered / total) * 100 : 0;
            const learning = total - newCards - mastered;
            const learningPercent = total > 0 ? (learning / total) * 100 : 0;
            
            document.getElementById('progressMastered').style.width = masteredPercent + '%';
            document.getElementById('progressLearning').style.width = learningPercent + '%';
            document.getElementById('progressNew').style.width = (100 - masteredPercent - learningPercent) + '%';
            document.getElementById('progressPercent').textContent = Math.round(masteredPercent) + '%';
        }

        function getFilteredCards() {
            if (selectedCategories.size === 0) return cards;
            return cards.filter(c => selectedCategories.has(c.category));
        }

        function getDueCards(cardList) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dueItems = [];
            
            cardList.forEach(card => {
                if (card.noEs.repetitions > 0 && card.noEs.nextReview && new Date(card.noEs.nextReview) <= today) {
                    dueItems.push({ card, direction: 'no-es' });
                }
                if (card.esNo.repetitions > 0 && card.esNo.nextReview && new Date(card.esNo.nextReview) <= today) {
                    dueItems.push({ card, direction: 'es-no' });
                }
            });
            return dueItems;
        }

        function getNewCards(cardList) {
            const newItems = [];
            cardList.forEach(card => {
                if (card.noEs.repetitions === 0) newItems.push({ card, direction: 'no-es' });
                if (card.esNo.repetitions === 0) newItems.push({ card, direction: 'es-no' });
            });
            return newItems;
        }

        function startVocabSession() {
            const newLimit = parseInt(document.getElementById('newCardsLimit').value);
            const reviewLimit = parseInt(document.getElementById('reviewCardsLimit').value);
            const filtered = getFilteredCards();
            
            const dueCards = getDueCards(filtered).slice(0, reviewLimit);
            const newCards = getNewCards(filtered).slice(0, newLimit * 2);
            
            sessionCards = shuffleArray([...dueCards, ...newCards]);
            
            if (sessionCards.length === 0) {
                alert('Ingen kort tilgjengelig! Prøv å velge kategorier eller vent til flere kort forfaller.');
                return;
            }
            
            currentIndex = 0;
            sessionStartTime = new Date();
            sessionStats = { reviewed: 0, correct: 0, newLearned: 0 };
            
            document.getElementById('vocabSettings').classList.add('hidden');
            document.getElementById('vocabStudy').classList.remove('hidden');
            
            showVocabCard();
        }

        function showVocabCard() {
            if (currentIndex >= sessionCards.length) {
                endVocabSession();
                return;
            }
            
            const item = sessionCards[currentIndex];
            currentCard = item;
            showingAnswer = false;
            
            const card = item.card;
            const direction = item.direction;
            const srData = direction === 'no-es' ? card.noEs : card.esNo;
            const isNew = srData.repetitions === 0;
            const front = direction === 'no-es' ? card.no : card.es;
            
            updateVocabProgress();
            
            document.getElementById('flashcardArea').innerHTML = `
                <div class="flashcard" onclick="flipCard()">
                    <span class="card-type-badge ${isNew ? 'badge-new' : 'badge-review'}">
                        ${isNew ? 'Nytt kort' : 'Repetisjon'}
                    </span>
                    <span class="direction-badge">
                        ${direction === 'no-es' ? '🇳🇴 → 🇪🇸' : '🇪🇸 → 🇳🇴'}
                    </span>
                    <div class="card-word">${front}</div>
                    <div class="card-hint">Trykk for å se svar (mellomrom)</div>
                    <span class="card-category">${getCategoryEmoji(card.category)} ${capitalizeFirst(card.category)}</span>
                </div>
            `;
            
            document.getElementById('buttonArea').innerHTML = '';
        }

        function flipCard() {
            if (showingAnswer) return;
            showingAnswer = true;
            
            const item = currentCard;
            const card = item.card;
            const direction = item.direction;
            const srData = direction === 'no-es' ? card.noEs : card.esNo;
            const isNew = srData.repetitions === 0;
            const front = direction === 'no-es' ? card.no : card.es;
            const back = direction === 'no-es' ? card.es : card.no;
            const intervals = [0, 1, 2, 3].map(q => SM2.getIntervalText(q, srData));
            
            document.getElementById('flashcardArea').innerHTML = `
                <div class="flashcard">
                    <span class="card-type-badge ${isNew ? 'badge-new' : 'badge-review'}">
                        ${isNew ? 'Nytt kort' : 'Repetisjon'}
                    </span>
                    <span class="direction-badge">
                        ${direction === 'no-es' ? '🇳🇴 → 🇪🇸' : '🇪🇸 → 🇳🇴'}
                    </span>
                    <div class="card-word" style="font-size: 18px; color: var(--gray-500); margin-bottom: 8px;">${front}</div>
                    <div class="card-answer">${back}</div>
                    <span class="card-category">${getCategoryEmoji(card.category)} ${capitalizeFirst(card.category)}</span>
                </div>
            `;
            
            document.getElementById('buttonArea').innerHTML = `
                <div class="rating-buttons">
                    <button class="rating-btn rating-again" onclick="rateCard(0)">😓 Igjen<span class="interval">${intervals[0]}</span><span class="key">(1)</span></button>
                    <button class="rating-btn rating-good" onclick="rateCard(2)">😊 Bra<span class="interval">${intervals[2]}</span><span class="key">(2)</span></button>
                </div>
            `;
        }

        function rateCard(quality) {
            const item = currentCard;
            const card = cards.find(c => c.id === item.card.id);
            const direction = item.direction;
            const srData = direction === 'no-es' ? card.noEs : card.esNo;
            const wasNew = srData.repetitions === 0;
            
            const result = SM2.calculateNextReview(srData, quality);
            
            if (direction === 'no-es') card.noEs = { ...card.noEs, ...result };
            else card.esNo = { ...card.esNo, ...result };
            
            card.lastReview = new Date().toISOString();
            card.reviews++;
            if (quality >= 2) card.correct++;
            
            sessionStats.reviewed++;
            if (quality >= 2) sessionStats.correct++;
            if (wasNew && quality >= 2) sessionStats.newLearned++;
            
            if (quality === 0) sessionCards.push(item);
            
            saveData();
            currentIndex++;
            showVocabCard();
        }

        function updateVocabProgress() {
            const progress = (currentIndex / sessionCards.length) * 100;
            document.getElementById('sessionProgressFill').style.width = progress + '%';
            document.getElementById('sessionStats').textContent = `${sessionStats.reviewed} repetert • ${sessionStats.correct} riktig`;
            document.getElementById('cardCounter').textContent = `${currentIndex + 1} / ${sessionCards.length}`;
        }

        function endVocabSessionEarly() {
            if (confirm('Er du sikker på at du vil avslutte økten?')) endVocabSession();
        }

        function endVocabSession() {
            const duration = Math.round((new Date() - sessionStartTime) / 60000);
            const accuracy = sessionStats.reviewed > 0 ? Math.round((sessionStats.correct / sessionStats.reviewed) * 100) : 0;
            
            // Record practice for homework tracking
            if (sessionStats.reviewed > 0) {
                recordPracticeSession(sessionStats.reviewed, sessionStats.correct);
            }
            
            document.getElementById('flashcardArea').innerHTML = `
                <div class="session-complete">
                    <div class="emoji">🎉</div>
                    <h2>Økt fullført!</h2>
                    <div class="session-stats-grid">
                        <div class="session-stat"><div class="session-stat-value">${sessionStats.reviewed}</div><div class="session-stat-label">Kort repetert</div></div>
                        <div class="session-stat"><div class="session-stat-value">${accuracy}%</div><div class="session-stat-label">Nøyaktighet</div></div>
                        <div class="session-stat"><div class="session-stat-value">${duration}</div><div class="session-stat-label">Minutter</div></div>
                    </div>
                    ${sessionStats.newLearned > 0 ? `<p style="color: var(--success); font-weight: 600;">✨ Du lærte ${sessionStats.newLearned} nye kort!</p>` : ''}
                </div>
            `;
            
            document.getElementById('buttonArea').innerHTML = `
                <div class="button-group">
                    <button class="btn btn-primary" onclick="startVocabSession()">▶️ Start ny økt</button>
                    <button class="btn btn-secondary" onclick="showPage('vocab')">← Tilbake</button>
                </div>
            `;
            
            updateStats();
        }

        // ============================================
        // BRAINMAP FUNCTIONS
        // ============================================

        function renderBrainmap() {
            const categories = getCategories();
            const themes = {
                'Grunnleggende': ['tall', 'farger', 'bursdag', 'klokka', 'tidsuttrykk'],
                'Mennesker': ['familie', 'familie-setninger', 'utseende', 'personlighet', 'yrker'],
                'Hverdagsliv': ['klær', 'hjem', 'møbler', 'rutiner', 'hobbyer'],
                'Verden': ['land', 'vær', 'høytider', 'skole', 'fag'],
                'Språk': ['verb', 'verbbøying', 'gustar', 'fremtid', 'bindeord']
            };
            
            document.getElementById('brainmapContent').innerHTML = Object.entries(themes).map(([theme, cats]) => `
                <div class="brainmap-level">
                    <div class="brainmap-level-header">
                        <span class="brainmap-level-title">${theme}</span>
                    </div>
                    <div class="brainmap-categories">
                        ${cats.filter(name => categories[name]).map(name => {
                            const data = categories[name];
                            const progress = (data.mastered / data.count) * 100;
                            return `
                                <div class="brainmap-category" onclick="selectCategoryAndStudy('${name}')">
                                    <div class="brainmap-category-name">${getCategoryEmoji(name)} ${capitalizeFirst(name)}</div>
                                    <div class="brainmap-category-progress">
                                        <div class="brainmap-category-progress-fill" style="width: ${progress}%"></div>
                                    </div>
                                    <div class="brainmap-category-stats">${data.mastered}/${data.count} mestret</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        }

        function selectCategoryAndStudy(category) {
            selectedCategories.clear();
            selectedCategories.add(category);
            showPage('vocab');
            populateCategories();
            startVocabSession();
        }

        // ============================================
        // VERB CONJUGATION FUNCTIONS
        // ============================================

        function renderVerbSelector() {
            const selector = document.getElementById('verbSelector');
            selector.innerHTML = Object.entries(verbDatabase).map(([key, verb]) => `
                <div class="verb-card ${selectedVerbs.has(key) ? 'selected' : ''}" onclick="toggleVerb('${key}')">
                    <div class="verb-infinitive">${verb.infinitive}</div>
                    <div class="verb-translation">${verb.translation}</div>
                    <span class="verb-type-badge">${verb.type}</span>
                </div>
            `).join('');
        }

        function toggleVerb(key) {
            if (selectedVerbs.has(key)) selectedVerbs.delete(key);
            else selectedVerbs.add(key);
            renderVerbSelector();
        }

        function selectAllVerbs() {
            Object.keys(verbDatabase).forEach(k => selectedVerbs.add(k));
            renderVerbSelector();
        }

        function deselectAllVerbs() {
            selectedVerbs.clear();
            renderVerbSelector();
        }

        function selectTense(tense) {
            selectedTense = tense;
            document.querySelectorAll('.tense-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tense' + capitalizeFirst(tense)).classList.add('active');
        }

        function startVerbSession() {
            if (selectedVerbs.size === 0) {
                alert('Velg minst ett verb!');
                return;
            }
            
            verbSessionExercises = [];
            verbAnswerPending = false;
            
            selectedVerbs.forEach(verbKey => {
                const verb = verbDatabase[verbKey];
                // Add exercises for each pronoun (skip vosotros for simplicity, index 4)
                [0, 1, 2, 3, 5].forEach(pronounIndex => {
                    verbSessionExercises.push({
                        verb: verb,
                        pronounIndex: pronounIndex,
                        tense: selectedTense
                    });
                });
            });
            
            // Shuffle and limit
            verbSessionExercises = shuffleArray(verbSessionExercises).slice(0, 20);
            verbCurrentIndex = 0;
            verbStats = { correct: 0, total: verbSessionExercises.length };
            
            document.getElementById('verbSettings').classList.add('hidden');
            document.getElementById('verbExercise').classList.remove('hidden');
            
            showVerbExercise();
        }

        function showVerbExercise() {
            if (verbCurrentIndex >= verbStats.total) {
                endVerbSession();
                return;
            }
            
            const exercise = verbSessionExercises[verbCurrentIndex];
            const verb = exercise.verb;
            const pronounIndex = exercise.pronounIndex;
            
            updateVerbProgress();
            
            let tenseDisplay, expectedAnswer;
            
            if (exercise.tense === 'presente') {
                tenseDisplay = 'Presens';
                expectedAnswer = verb.presente[pronounIndex];
            } else if (exercise.tense === 'futuro') {
                tenseDisplay = 'Fremtid (ir a + infinitiv)';
                const irForms = verbDatabase.ir.presente;
                expectedAnswer = irForms[pronounIndex] + ' a ' + verb.infinitive;
            } else if (exercise.tense === 'perfecto') {
                tenseDisplay = 'Presens perfektum';
                expectedAnswer = haberPresente[pronounIndex] + ' ' + verb.participio;
            }
            
            document.getElementById('verbExerciseArea').innerHTML = `
                <div class="conjugation-exercise">
                    <div class="conjugation-verb">${verb.infinitive}</div>
                    <div class="conjugation-translation">${verb.translation}</div>
                    <div class="conjugation-tense">${tenseDisplay}</div>
                    
                    <div class="conjugation-prompt">
                        <span class="pronoun">${pronouns[pronounIndex]}</span> + ${verb.infinitive}
                    </div>
                    
                    <div class="conjugation-input-container">
                        <input type="text" class="conjugation-input" id="verbInput" 
                               placeholder="Skriv svaret..." autocomplete="off" autofocus>
                    </div>
                    <div class="accent-hint">💡 Hold inne a/e/i/o/u/n for aksent, eller ?/! for ¿/¡</div>
                    
                    <div class="conjugation-feedback" id="verbFeedback"></div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="checkVerbAnswer()">✓ Sjekk svar</button>
                        <button class="btn btn-outline" onclick="showVerbHint()">💡 Hint</button>
                    </div>
                </div>
            `;
            
            const verbInput = document.getElementById('verbInput');
            verbInput.focus();
            verbInput.dataset.expected = expectedAnswer;
            setupAccentInput(verbInput);
        }

        function checkVerbAnswer() {
            if (verbAnswerPending) return; // Prevent multiple clicks
            
            const input = document.getElementById('verbInput');
            const expected = input.dataset.expected;
            const userAnswer = input.value.trim().toLowerCase();
            const expectedLower = expected.toLowerCase();
            
            const feedback = document.getElementById('verbFeedback');
            
            verbAnswerPending = true;
            
            if (userAnswer === expectedLower) {
                feedback.textContent = '✓ Riktig!';
                feedback.className = 'conjugation-feedback correct';
                input.classList.add('correct');
                input.classList.remove('incorrect');
                verbStats.correct++;
                
                setTimeout(() => {
                    verbCurrentIndex++;
                    verbAnswerPending = false;
                    showVerbExercise();
                }, 1000);
            } else {
                feedback.innerHTML = `✗ Riktig svar: <strong>${expected}</strong>`;
                feedback.className = 'conjugation-feedback incorrect';
                input.classList.add('incorrect');
                input.classList.remove('correct');
                
                // Show full conjugation table
                showConjugationTable();
                
                setTimeout(() => {
                    verbCurrentIndex++;
                    verbAnswerPending = false;
                    showVerbExercise();
                }, 3000);
            }
        }

        function showVerbHint() {
            const input = document.getElementById('verbInput');
            const expected = input.dataset.expected;
            const hint = expected.substring(0, Math.ceil(expected.length / 2)) + '...';
            document.getElementById('verbFeedback').textContent = `Hint: ${hint}`;
            document.getElementById('verbFeedback').className = 'conjugation-feedback';
        }

        function showConjugationTable() {
            const exercise = verbSessionExercises[verbCurrentIndex];
            const verb = exercise.verb;
            
            let forms;
            if (exercise.tense === 'presente') {
                forms = verb.presente;
            } else if (exercise.tense === 'futuro') {
                const irForms = verbDatabase.ir.presente;
                forms = irForms.map(f => f + ' a ' + verb.infinitive);
            } else {
                forms = haberPresente.map(f => f + ' ' + verb.participio);
            }
            
            const tableHTML = `
                <div class="conjugation-table">
                    <h4>Fullstendig bøying:</h4>
                    <div class="conjugation-table-grid">
                        ${pronouns.map((p, i) => `
                            <div class="conjugation-table-row ${i === exercise.pronounIndex ? 'highlight' : ''}">
                                <span class="pronoun">${p}</span>
                                <span class="form">${forms[i]}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('verbExerciseArea').innerHTML += tableHTML;
        }

        function updateVerbProgress() {
            const total = verbStats.total;
            const progress = (verbCurrentIndex / total) * 100;
            document.getElementById('verbProgressFill').style.width = progress + '%';
            document.getElementById('verbSessionStats').textContent = `${verbStats.correct} / ${verbCurrentIndex} riktig`;
            document.getElementById('verbCounter').textContent = `${verbCurrentIndex + 1} / ${total}`;
        }

        function endVerbSessionEarly() {
            if (confirm('Er du sikker på at du vil avslutte økten?')) endVerbSession();
        }

        function endVerbSession() {
            const accuracy = verbStats.total > 0 ? Math.round((verbStats.correct / verbStats.total) * 100) : 0;
            
            document.getElementById('verbExerciseArea').innerHTML = `
                <div class="session-complete">
                    <div class="emoji">${accuracy >= 80 ? '🎉' : accuracy >= 50 ? '👍' : '💪'}</div>
                    <h2>Øving fullført!</h2>
                    <div class="session-stats-grid">
                        <div class="session-stat"><div class="session-stat-value">${verbStats.correct}</div><div class="session-stat-label">Riktige svar</div></div>
                        <div class="session-stat"><div class="session-stat-value">${verbStats.total}</div><div class="session-stat-label">Totalt</div></div>
                        <div class="session-stat"><div class="session-stat-value">${accuracy}%</div><div class="session-stat-label">Nøyaktighet</div></div>
                    </div>
                    <p style="color: var(--gray-500); margin-top: 20px;">
                        ${accuracy >= 80 ? 'Fantastisk! Du mestrer verbbøyingene!' : 
                          accuracy >= 50 ? 'Bra jobbet! Fortsett å øve!' : 
                          'Ikke gi opp! Øvelse gjør mester!'}
                    </p>
                </div>
            `;
            
            document.getElementById('verbExerciseArea').innerHTML += `
                <div class="button-group">
                    <button class="btn btn-primary" onclick="startVerbSession()">▶️ Øv mer</button>
                    <button class="btn btn-secondary" onclick="showPage('verbs')">← Tilbake</button>
                </div>
            `;
        }

        // ============================================
        // IMPORT/EXPORT
        // ============================================

        function showStatistics() {
            const total = cards.length;
            const newCards = cards.filter(c => c.noEs.repetitions === 0 && c.esNo.repetitions === 0).length;
            const mastered = cards.filter(c => c.noEs.repetitions >= 3 && c.esNo.repetitions >= 3).length;
            const totalReviews = cards.reduce((sum, c) => sum + c.reviews, 0);
            const totalCorrect = cards.reduce((sum, c) => sum + c.correct, 0);
            const accuracy = totalReviews > 0 ? Math.round((totalCorrect / totalReviews) * 100) : 0;
            
            alert(`📊 STATISTIKK\n\nTotalt antall ord: ${total}\nNye ord: ${newCards}\nMestret: ${mastered}\n\nTotalt repetisjoner: ${totalReviews}\nNøyaktighet: ${accuracy}%`);
        }

        // ============================================
        // CUSTOM WORDS & TEACHER IMPORT
        // ============================================

        function updateCategoryDropdown() {
            const dropdown = document.getElementById('addWordCategory');
            if (!dropdown) return;
            
            const categories = [...new Set(cards.map(c => c.category))].sort();
            
            dropdown.innerHTML = '<option value="">Velg kategori...</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            // Update custom words count
            const customCount = cards.filter(c => c.isCustom).length;
            const countEl = document.getElementById('customWordsCount');
            if (countEl) {
                countEl.textContent = customCount > 0 ? `Du har lagt til ${customCount} egne gloser` : '';
            }
        }

        function addCustomWord() {
            const norskInput = document.getElementById('addWordNorsk');
            const spanskInput = document.getElementById('addWordSpansk');
            const categorySelect = document.getElementById('addWordCategory');
            const newCategoryInput = document.getElementById('addWordNewCategory');
            
            const norsk = norskInput.value.trim();
            const spansk = spanskInput.value.trim();
            let category = newCategoryInput.value.trim() || categorySelect.value;
            
            // Validation
            if (!norsk || !spansk) {
                showToast('Skriv inn både norsk og spansk ord', 'error');
                return;
            }
            
            if (!category) {
                showToast('Velg eller skriv inn en kategori', 'error');
                return;
            }
            
            // Normalize category name
            category = category.toLowerCase().replace(/\s+/g, '-');
            
            // Check for duplicates
            const exists = cards.some(c => 
                c.norsk.toLowerCase() === norsk.toLowerCase() && 
                c.spansk.toLowerCase() === spansk.toLowerCase()
            );
            
            if (exists) {
                showToast('Denne glosen finnes allerede', 'error');
                return;
            }
            
            // Create new card
            const newCard = {
                norsk: norsk,
                spansk: spansk,
                category: category,
                isCustom: true,
                noEs: { repetitions: 0, easeFactor: 2.5, interval: 0, nextReview: 0 },
                esNo: { repetitions: 0, easeFactor: 2.5, interval: 0, nextReview: 0 },
                reviews: 0,
                correct: 0
            };
            
            cards.push(newCard);
            saveData();
            
            // Clear form
            norskInput.value = '';
            spanskInput.value = '';
            newCategoryInput.value = '';
            
            // Update UI
            updateCategoryDropdown();
            populateCategories();
            updateStats();
            
            showToast(`"${norsk}" lagt til i "${category}"`, 'success');
        }

        function importTeacherWords() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        let imported = 0;
                        let skipped = 0;
                        
                        // Support different formats
                        let wordsToImport = [];
                        
                        // Format 1: Array of [norsk, spansk, kategori]
                        if (Array.isArray(data) && Array.isArray(data[0])) {
                            wordsToImport = data.map(item => ({
                                norsk: item[0],
                                spansk: item[1],
                                category: item[2] || 'importert'
                            }));
                        }
                        // Format 2: { category: "...", words: [[norsk, spansk], ...] }
                        else if (data.category && Array.isArray(data.words)) {
                            wordsToImport = data.words.map(item => ({
                                norsk: item[0],
                                spansk: item[1],
                                category: data.category
                            }));
                        }
                        // Format 3: { words: [{ norsk, spansk, category }, ...] }
                        else if (data.words && Array.isArray(data.words)) {
                            wordsToImport = data.words;
                        }
                        // Format 4: Array of { norsk, spansk, category }
                        else if (Array.isArray(data) && data[0].norsk) {
                            wordsToImport = data;
                        }
                        else {
                            throw new Error('Ukjent filformat');
                        }
                        
                        // Import words
                        for (const word of wordsToImport) {
                            if (!word.norsk || !word.spansk) {
                                skipped++;
                                continue;
                            }
                            
                            // Check for duplicates
                            const exists = cards.some(c => 
                                c.norsk.toLowerCase() === word.norsk.toLowerCase() && 
                                c.spansk.toLowerCase() === word.spansk.toLowerCase()
                            );
                            
                            if (exists) {
                                skipped++;
                                continue;
                            }
                            
                            const category = (word.category || 'importert').toLowerCase().replace(/\s+/g, '-');
                            
                            cards.push({
                                norsk: word.norsk,
                                spansk: word.spansk,
                                category: category,
                                isCustom: true,
                                noEs: { repetitions: 0, easeFactor: 2.5, interval: 0, nextReview: 0 },
                                esNo: { repetitions: 0, easeFactor: 2.5, interval: 0, nextReview: 0 },
                                reviews: 0,
                                correct: 0
                            });
                            imported++;
                        }
                        
                        saveData();
                        updateCategoryDropdown();
                        populateCategories();
                        updateStats();
                        
                        if (imported > 0) {
                            showToast(`Importerte ${imported} gloser` + (skipped > 0 ? ` (${skipped} hoppet over)` : ''), 'success');
                        } else {
                            showToast(`Ingen nye gloser å importere (${skipped} duplikater)`, 'error');
                        }
                        
                    } catch (error) {
                        console.error('Import error:', error);
                        showToast('Kunne ikke lese filen: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function showToast(message, type = 'info') {
            // Remove existing toast
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        function exportProgress() {
            const data = { cards, exportDate: new Date().toISOString(), version: 'spansk123_v4' };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `spansk_fremgang_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importProgress() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (!data.cards) { alert('Ugyldig fil!'); return; }
                        if (confirm(`Importere data? Dette vil overskrive nåværende fremgang.`)) {
                            cards = data.cards;
                            mergeNewVocabulary();
                            saveData();
                            updateStats();
                            populateCategories();
                            alert('Import fullført!');
                        }
                    } catch (err) { alert('Feil ved import: ' + err.message); }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ============================================
        // ACCENT INPUT HELPER (Long Press)
        // ============================================

        const accentMap = {
            'a': 'á', 'e': 'é', 'i': 'í', 'o': 'ó', 'u': 'ú', 'n': 'ñ',
            'A': 'Á', 'E': 'É', 'I': 'Í', 'O': 'Ó', 'U': 'Ú', 'N': 'Ñ',
            '?': '¿', '!': '¡'
        };

        let longPressTimer = null;

        function setupAccentInput(inputElement) {
            inputElement.addEventListener('keydown', (e) => {
                const key = e.key;
                
                if (!accentMap[key]) return;
                
                // Ignore key repeat
                if (e.repeat) {
                    e.preventDefault();
                    return;
                }
                
                // Clear any existing timer
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                
                // Let the character be typed normally (don't preventDefault)
                // But start a timer to replace it with accented version
                longPressTimer = setTimeout(() => {
                    // Replace the last character with accented version
                    const pos = inputElement.selectionStart;
                    if (pos > 0) {
                        const value = inputElement.value;
                        const lastChar = value.charAt(pos - 1);
                        // Only replace if it matches the key we pressed
                        if (lastChar.toLowerCase() === key.toLowerCase()) {
                            inputElement.value = value.substring(0, pos - 1) + accentMap[key] + value.substring(pos);
                            inputElement.selectionStart = inputElement.selectionEnd = pos;
                        }
                    }
                    longPressTimer = null;
                }, 400);
            });

            inputElement.addEventListener('keyup', (e) => {
                const key = e.key;
                
                if (!accentMap[key]) return;
                
                // Cancel the accent replacement if key released quickly
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            });
        }

        function insertCharacter(input, char) {
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const value = input.value;
            
            input.value = value.substring(0, start) + char + value.substring(end);
            input.selectionStart = input.selectionEnd = start + 1;
        }

        // ============================================
        // GRAMMAR MODE
        // ============================================

        const grammarTopics = {
            articles: {
                id: 'articles',
                name: 'Artikler',
                icon: '📰',
                description: 'el, la, un, una, los, las',
                theory: {
                    title: 'Bestemt og ubestemt artikkel',
                    content: `
                        <p><strong>Ubestemt artikkel</strong> (en/ei/et):</p>
                        <ul>
                            <li><strong>un</strong> - maskulin entall (un libro = en bok)</li>
                            <li><strong>una</strong> - feminin entall (una casa = et hus)</li>
                        </ul>
                        
                        <p><strong>Bestemt artikkel</strong> (den/det/de):</p>
                        <ul>
                            <li><strong>el</strong> - maskulin entall (el libro = boken)</li>
                            <li><strong>la</strong> - feminin entall (la casa = huset)</li>
                            <li><strong>los</strong> - maskulin flertall (los libros = bøkene)</li>
                            <li><strong>las</strong> - feminin flertall (las casas = husene)</li>
                        </ul>
                        
                        <div class="rule">
                            <strong>Hovedregel:</strong> Ord som slutter på <strong>-o</strong> er vanligvis maskuline. 
                            Ord som slutter på <strong>-a</strong> er vanligvis feminine.
                        </div>
                        
                        <div class="example">
                            el libr<span class="correct">o</span> (maskulin) → la mes<span class="correct">a</span> (feminin)
                        </div>
                        
                        <div class="exception">
                            <strong>Unntak å huske:</strong> el día (dagen), el problema (problemet), 
                            el tema (temaet), la mano (hånden), la foto (bildet)
                        </div>
                    `
                },
                exercises: [
                    { sentence: "___ casa es grande", answer: "La", options: ["El", "La", "Un", "Una"], hint: "casa (hus) er feminin", word: "casa" },
                    { sentence: "___ libro es interesante", answer: "El", options: ["El", "La", "Los", "Las"], hint: "libro (bok) slutter på -o", word: "libro" },
                    { sentence: "Tengo ___ hermano", answer: "un", options: ["un", "una", "el", "la"], hint: "hermano (bror) er maskulin", word: "hermano" },
                    { sentence: "___ mesa está en la cocina", answer: "La", options: ["El", "La", "Un", "Una"], hint: "mesa (bord) slutter på -a", word: "mesa" },
                    { sentence: "Veo ___ perro en el parque", answer: "un", options: ["un", "una", "el", "la"], hint: "perro (hund) er maskulin", word: "perro" },
                    { sentence: "___ profesora es simpática", answer: "La", options: ["El", "La", "Un", "Una"], hint: "profesora (lærer) er feminin", word: "profesora" },
                    { sentence: "___ chicos juegan fútbol", answer: "Los", options: ["El", "La", "Los", "Las"], hint: "chicos (gutter) er maskulin flertall", word: "chicos" },
                    { sentence: "___ sillas son rojas", answer: "Las", options: ["El", "La", "Los", "Las"], hint: "sillas (stoler) er feminin flertall", word: "sillas" },
                    { sentence: "Necesito ___ bolígrafo", answer: "un", options: ["un", "una", "el", "la"], hint: "bolígrafo (penn) er maskulin", word: "bolígrafo" },
                    { sentence: "___ día es bonito", answer: "El", options: ["El", "La", "Un", "Una"], hint: "día (dag) er UNNTAK - maskulin!", word: "día" },
                    { sentence: "___ problema es difícil", answer: "El", options: ["El", "La", "Un", "Una"], hint: "problema er UNNTAK - maskulin!", word: "problema" },
                    { sentence: "___ mano está fría", answer: "La", options: ["El", "La", "Un", "Una"], hint: "mano (hånd) er UNNTAK - feminin!", word: "mano" },
                    { sentence: "___ ventana está abierta", answer: "La", options: ["El", "La", "Los", "Las"], hint: "ventana (vindu) slutter på -a", word: "ventana" },
                    { sentence: "___ padres están en casa", answer: "Los", options: ["El", "La", "Los", "Las"], hint: "padres (foreldre) er maskulin flertall", word: "padres" },
                    { sentence: "Tengo ___ gata negra", answer: "una", options: ["un", "una", "el", "la"], hint: "gata (katt, hunn) er feminin", word: "gata" },
                ]
            },
            
            adjectives: {
                id: 'adjectives',
                name: 'Adjektivsamsvar',
                icon: '🎨',
                description: 'Bøy adjektiv etter kjønn og tall',
                theory: {
                    title: 'Adjektivsamsvar - kjønn og tall',
                    content: `
                        <p>Adjektiv må samsvare med substantivet i <strong>kjønn</strong> og <strong>tall</strong>.</p>
                        
                        <div class="rule">
                            <strong>Adjektiv som slutter på -o:</strong><br>
                            alto → alta → altos → altas
                        </div>
                        
                        <div class="example">
                            El chico es alt<span class="correct">o</span> (gutten er høy)<br>
                            La chica es alt<span class="correct">a</span> (jenta er høy)<br>
                            Los chicos son alt<span class="correct">os</span> (guttene er høye)<br>
                            Las chicas son alt<span class="correct">as</span> (jentene er høye)
                        </div>
                        
                        <div class="rule">
                            <strong>Adjektiv som slutter på -e eller konsonant:</strong><br>
                            Samme form for maskulin og feminin!
                        </div>
                        
                        <div class="example">
                            El chico es inteligent<span class="correct">e</span><br>
                            La chica es inteligent<span class="correct">e</span><br>
                            Los chicos son inteligent<span class="correct">es</span><br>
                            Las chicas son inteligent<span class="correct">es</span>
                        </div>
                    `
                },
                exercises: [
                    { sentence: "La casa es muy ___", answer: "bonita", options: ["bonito", "bonita", "bonitos", "bonitas"], hint: "casa er feminin entall", base: "bonito" },
                    { sentence: "Los chicos son ___", answer: "altos", options: ["alto", "alta", "altos", "altas"], hint: "chicos er maskulin flertall", base: "alto" },
                    { sentence: "Mi hermana es muy ___", answer: "simpática", options: ["simpático", "simpática", "simpáticos", "simpáticas"], hint: "hermana er feminin entall", base: "simpático" },
                    { sentence: "Las flores son ___", answer: "rojas", options: ["rojo", "roja", "rojos", "rojas"], hint: "flores er feminin flertall", base: "rojo" },
                    { sentence: "El profesor es ___", answer: "inteligente", options: ["inteligente", "inteligenta", "inteligentes", "inteligento"], hint: "-e adjektiv er like for begge kjønn", base: "inteligente" },
                    { sentence: "Las chicas son muy ___", answer: "inteligentes", options: ["inteligente", "inteligenta", "inteligentes", "inteligento"], hint: "flertall av -e adjektiv får -es", base: "inteligente" },
                    { sentence: "Mi padre es ___", answer: "moreno", options: ["moreno", "morena", "morenos", "morenas"], hint: "padre er maskulin entall", base: "moreno" },
                    { sentence: "Las casas son ___", answer: "grandes", options: ["grande", "granda", "grandes", "grandas"], hint: "grande er likt for begge kjønn", base: "grande" },
                    { sentence: "El perro es ___", answer: "pequeño", options: ["pequeño", "pequeña", "pequeños", "pequeñas"], hint: "perro er maskulin entall", base: "pequeño" },
                    { sentence: "Mis abuelas son ___", answer: "viejas", options: ["viejo", "vieja", "viejos", "viejas"], hint: "abuelas er feminin flertall", base: "viejo" },
                    { sentence: "La comida está ___", answer: "rica", options: ["rico", "rica", "ricos", "ricas"], hint: "comida er feminin entall", base: "rico" },
                    { sentence: "Los libros son ___", answer: "interesantes", options: ["interesante", "interesanta", "interesantes", "interesantos"], hint: "-e adjektiv i flertall", base: "interesante" },
                ]
            },
            
            serEstar: {
                id: 'serEstar',
                name: 'Ser vs Estar',
                icon: '⚖️',
                description: 'Når bruker vi ser og estar?',
                theory: {
                    title: 'Ser vs Estar - to måter å si "å være"',
                    content: `
                        <p>Spansk har to verb for "å være": <strong>ser</strong> og <strong>estar</strong>.</p>
                        
                        <div class="rule">
                            <strong>SER brukes til:</strong>
                            <ul>
                                <li>Identitet: Soy María (Jeg er María)</li>
                                <li>Yrke: Soy profesor (Jeg er lærer)</li>
                                <li>Nasjonalitet: Soy noruego (Jeg er norsk)</li>
                                <li>Permanente egenskaper: Soy alto (Jeg er høy)</li>
                                <li>Tid: Son las tres (Klokken er tre)</li>
                            </ul>
                        </div>
                        
                        <div class="rule">
                            <strong>ESTAR brukes til:</strong>
                            <ul>
                                <li>Lokasjon: Estoy en casa (Jeg er hjemme)</li>
                                <li>Midlertidige tilstander: Estoy cansado (Jeg er sliten)</li>
                                <li>Følelser: Estoy feliz (Jeg er glad)</li>
                                <li>Tilstand av ting: La puerta está abierta (Døren er åpen)</li>
                            </ul>
                        </div>
                        
                        <div class="example">
                            María <span class="correct">es</span> alta (permanent egenskap)<br>
                            María <span class="correct">está</span> cansada (midlertidig tilstand)
                        </div>
                    `
                },
                exercises: [
                    { sentence: "Yo ___ de Noruega", answer: "soy", options: ["soy", "estoy", "es", "está"], hint: "Nasjonalitet/opprinnelse = SER" },
                    { sentence: "Mi madre ___ en la cocina", answer: "está", options: ["es", "está", "son", "están"], hint: "Lokasjon = ESTAR" },
                    { sentence: "Nosotros ___ estudiantes", answer: "somos", options: ["somos", "estamos", "son", "están"], hint: "Identitet = SER" },
                    { sentence: "Hoy yo ___ muy cansado", answer: "estoy", options: ["soy", "estoy", "es", "está"], hint: "Midlertidig tilstand = ESTAR" },
                    { sentence: "Mi padre ___ profesor", answer: "es", options: ["es", "está", "soy", "estoy"], hint: "Yrke = SER" },
                    { sentence: "¿Dónde ___ el baño?", answer: "está", options: ["es", "está", "son", "están"], hint: "Lokasjon = ESTAR" },
                    { sentence: "Ellos ___ muy simpáticos", answer: "son", options: ["son", "están", "es", "está"], hint: "Permanent egenskap = SER" },
                    { sentence: "La ventana ___ abierta", answer: "está", options: ["es", "está", "son", "están"], hint: "Tilstand = ESTAR" },
                    { sentence: "Hoy ___ lunes", answer: "es", options: ["es", "está", "soy", "estoy"], hint: "Dag/tid = SER" },
                    { sentence: "¿Cómo ___ tú?", answer: "estás", options: ["eres", "estás", "es", "está"], hint: "Hvordan har du det (tilstand) = ESTAR" },
                    { sentence: "Mi hermano ___ alto y moreno", answer: "es", options: ["es", "está", "soy", "estoy"], hint: "Fysisk beskrivelse = SER" },
                    { sentence: "Los niños ___ en el parque", answer: "están", options: ["son", "están", "es", "está"], hint: "Lokasjon = ESTAR" },
                    { sentence: "La fiesta ___ el sábado", answer: "es", options: ["es", "está", "son", "están"], hint: "Når noe skjer = SER" },
                    { sentence: "Yo ___ muy feliz hoy", answer: "estoy", options: ["soy", "estoy", "es", "está"], hint: "Følelse (midlertidig) = ESTAR" },
                ]
            },
            
            gustar: {
                id: 'gustar',
                name: 'Gustar',
                icon: '❤️',
                description: 'Å like noe på spansk',
                theory: {
                    title: 'Gustar - å uttrykke hva du liker',
                    content: `
                        <p>På spansk sier vi ikke "jeg liker", men "det behager meg".</p>
                        
                        <div class="rule">
                            <strong>Struktur:</strong><br>
                            [pronomen] + gusta + entall substantiv/verb<br>
                            [pronomen] + gustan + flertall substantiv
                        </div>
                        
                        <div class="example">
                            <strong>Me</strong> gusta el fútbol (Jeg liker fotball)<br>
                            <strong>Me</strong> gustan los libros (Jeg liker bøker)<br>
                            <strong>Me</strong> gusta bailar (Jeg liker å danse)
                        </div>
                        
                        <div class="rule">
                            <strong>Pronomenene:</strong>
                            <ul>
                                <li><strong>me</strong> - jeg liker</li>
                                <li><strong>te</strong> - du liker</li>
                                <li><strong>le</strong> - han/hun liker</li>
                                <li><strong>nos</strong> - vi liker</li>
                                <li><strong>les</strong> - de liker</li>
                            </ul>
                        </div>
                        
                        <div class="example">
                            ¿<span class="correct">Te</span> gusta la música? (Liker du musikk?)<br>
                            A mi madre <span class="correct">le</span> gustan las flores (Mamma liker blomster)
                        </div>
                    `
                },
                exercises: [
                    { sentence: "___ gusta el chocolate", answer: "Me", options: ["Me", "Te", "Le", "Nos"], hint: "Jeg liker..." },
                    { sentence: "Me ___ los videojuegos", answer: "gustan", options: ["gusta", "gustan", "gustas", "gusto"], hint: "videojuegos er flertall" },
                    { sentence: "¿___ gusta bailar?", answer: "Te", options: ["Me", "Te", "Le", "Se"], hint: "Liker du...?" },
                    { sentence: "A mi hermano ___ gusta el fútbol", answer: "le", options: ["me", "te", "le", "nos"], hint: "Han liker..." },
                    { sentence: "Me ___ escuchar música", answer: "gusta", options: ["gusta", "gustan", "gustas", "gusto"], hint: "Infinitiv = gusta (entall)" },
                    { sentence: "___ gustan las películas de terror", answer: "Nos", options: ["Me", "Te", "Le", "Nos"], hint: "Vi liker..." },
                    { sentence: "A María ___ gustan los gatos", answer: "le", options: ["me", "te", "le", "les"], hint: "Hun liker..." },
                    { sentence: "¿Te ___ la pizza?", answer: "gusta", options: ["gusta", "gustan", "gustas", "gusto"], hint: "pizza er entall" },
                    { sentence: "A mis padres ___ gusta viajar", answer: "les", options: ["le", "les", "nos", "me"], hint: "De liker... (flertall)" },
                    { sentence: "No me ___ las verduras", answer: "gustan", options: ["gusta", "gustan", "gustas", "gusto"], hint: "verduras er flertall" },
                    { sentence: "___ gusta mucho esta canción", answer: "Me", options: ["Me", "Mi", "Yo", "Mí"], hint: "Jeg liker..." },
                    { sentence: "A ella ___ gustan los perros", answer: "le", options: ["le", "la", "les", "lo"], hint: "Hun liker..." },
                ]
            },
            
            reflexive: {
                id: 'reflexive',
                name: 'Refleksive pronomen',
                icon: '🪞',
                description: 'me, te, se, nos - daglige rutiner',
                theory: {
                    title: 'Refleksive verb og pronomen',
                    content: `
                        <p>Refleksive verb beskriver handlinger du gjør med deg selv, som å vaske seg, kle på seg, osv.</p>
                        
                        <div class="rule">
                            <strong>Refleksive pronomen:</strong>
                            <ul>
                                <li><strong>me</strong> - meg (yo)</li>
                                <li><strong>te</strong> - deg (tú)</li>
                                <li><strong>se</strong> - seg (él/ella/usted)</li>
                                <li><strong>nos</strong> - oss (nosotros)</li>
                                <li><strong>se</strong> - seg (ellos/ellas/ustedes)</li>
                            </ul>
                        </div>
                        
                        <div class="example">
                            <strong>Me</strong> levanto a las siete (Jeg står opp kl. 7)<br>
                            <strong>Te</strong> duchas por la mañana (Du dusjer om morgenen)<br>
                            <strong>Se</strong> llama María (Hun heter María)
                        </div>
                        
                        <div class="rule">
                            <strong>Vanlige refleksive verb:</strong><br>
                            levantarse (stå opp), ducharse (dusje), vestirse (kle på seg), 
                            acostarse (legge seg), llamarse (hete), peinarse (gre seg)
                        </div>
                    `
                },
                exercises: [
                    { sentence: "___ levanto a las siete", answer: "Me", options: ["Me", "Te", "Se", "Nos"], hint: "Jeg står opp..." },
                    { sentence: "Mi hermana ___ ducha por la mañana", answer: "se", options: ["me", "te", "se", "nos"], hint: "Hun dusjer..." },
                    { sentence: "¿Cómo ___ llamas?", answer: "te", options: ["me", "te", "se", "nos"], hint: "Hva heter du?" },
                    { sentence: "Nosotros ___ acostamos a las diez", answer: "nos", options: ["me", "te", "se", "nos"], hint: "Vi legger oss..." },
                    { sentence: "___ visto rápidamente", answer: "Me", options: ["Me", "Te", "Se", "Nos"], hint: "Jeg kler på meg..." },
                    { sentence: "Ella ___ maquilla todos los días", answer: "se", options: ["me", "te", "se", "nos"], hint: "Hun sminker seg..." },
                    { sentence: "¿A qué hora ___ despiertas?", answer: "te", options: ["me", "te", "se", "nos"], hint: "Når våkner du?" },
                    { sentence: "Los niños ___ lavan las manos", answer: "se", options: ["me", "te", "se", "nos"], hint: "De vasker seg..." },
                    { sentence: "___ peino antes de salir", answer: "Me", options: ["Me", "Te", "Se", "Nos"], hint: "Jeg grer meg..." },
                    { sentence: "Mi padre ___ afeita cada mañana", answer: "se", options: ["me", "te", "se", "nos"], hint: "Han barberer seg..." },
                    { sentence: "¿___ cepillas los dientes?", answer: "Te", options: ["Me", "Te", "Se", "Nos"], hint: "Pusser du tennene?" },
                    { sentence: "Ellos ___ despiertan temprano", answer: "se", options: ["me", "te", "se", "nos"], hint: "De våkner..." },
                ]
            },
            
            demonstratives: {
                id: 'demonstratives',
                name: 'Pekende adjektiv',
                icon: '👆',
                description: 'este/ese - denne/den der',
                theory: {
                    title: 'Demonstrative adjektiver - dette/det der',
                    content: `
                        <p>Pekende adjektiv viser til noe nært eller fjernt.</p>
                        
                        <div class="rule">
                            <strong>ESTE/ESTA (denne, dette) - nær deg:</strong>
                            <ul>
                                <li><strong>este</strong> - maskulin entall (este libro = denne boken)</li>
                                <li><strong>esta</strong> - feminin entall (esta casa = dette huset)</li>
                                <li><strong>estos</strong> - maskulin flertall (estos libros)</li>
                                <li><strong>estas</strong> - feminin flertall (estas casas)</li>
                            </ul>
                        </div>
                        
                        <div class="rule">
                            <strong>ESE/ESA (den, den der) - lenger unna:</strong>
                            <ul>
                                <li><strong>ese</strong> - maskulin entall (ese libro = den boken)</li>
                                <li><strong>esa</strong> - feminin entall (esa casa = det huset)</li>
                                <li><strong>esos</strong> - maskulin flertall (esos libros)</li>
                                <li><strong>esas</strong> - feminin flertall (esas casas)</li>
                            </ul>
                        </div>
                        
                        <div class="example">
                            <span class="correct">Este</span> libro es interesante (denne boken - jeg holder den)<br>
                            <span class="correct">Ese</span> libro es interesante (den boken - på bordet der borte)
                        </div>
                    `
                },
                exercises: [
                    { sentence: "___ libro es muy interesante", answer: "Este", options: ["Este", "Esta", "Estos", "Estas"], hint: "libro er maskulin entall, nær" },
                    { sentence: "___ casa es grande", answer: "Esta", options: ["Este", "Esta", "Ese", "Esa"], hint: "casa er feminin entall, nær" },
                    { sentence: "___ chicos son mis amigos", answer: "Estos", options: ["Este", "Estos", "Ese", "Esos"], hint: "chicos er maskulin flertall, nær" },
                    { sentence: "___ flores son bonitas", answer: "Estas", options: ["Esta", "Estas", "Esa", "Esas"], hint: "flores er feminin flertall, nær" },
                    { sentence: "¿Qué es ___ (der borte)?", answer: "eso", options: ["esto", "eso", "este", "ese"], hint: "nøytralt, lenger unna" },
                    { sentence: "___ coche (der borte) es de mi padre", answer: "Ese", options: ["Este", "Esta", "Ese", "Esa"], hint: "coche er maskulin, lenger unna" },
                    { sentence: "___ mesa (der borte) está ocupada", answer: "Esa", options: ["Esta", "Esa", "Este", "Ese"], hint: "mesa er feminin, lenger unna" },
                    { sentence: "___ zapatos son nuevos", answer: "Estos", options: ["Este", "Estos", "Estas", "Esos"], hint: "zapatos er maskulin flertall, nær" },
                    { sentence: "___ películas (der borte) son aburridas", answer: "Esas", options: ["Estas", "Esas", "Estos", "Esos"], hint: "películas er feminin flertall, lenger unna" },
                    { sentence: "Me gusta ___ canción", answer: "esta", options: ["este", "esta", "ese", "esa"], hint: "canción er feminin, nær" },
                    { sentence: "___ perros (der borte) son grandes", answer: "Esos", options: ["Estos", "Estas", "Esos", "Esas"], hint: "perros er maskulin flertall, lenger unna" },
                    { sentence: "¿Quién es ___ chica?", answer: "esta", options: ["este", "esta", "ese", "esa"], hint: "chica er feminin, nær" },
                ]
            },
            
            possessives: {
                id: 'possessives',
                name: 'Eiendomsord',
                icon: '🏠',
                description: 'mi/tu/su - min/din/hans',
                theory: {
                    title: 'Possessive adjektiver - eiendomsord',
                    content: `
                        <p>Eiendomsord viser hvem noe tilhører.</p>
                        
                        <div class="rule">
                            <strong>Entall (én ting):</strong>
                            <ul>
                                <li><strong>mi</strong> - min/mitt (mi libro, mi casa)</li>
                                <li><strong>tu</strong> - din/ditt (tu libro, tu casa)</li>
                                <li><strong>su</strong> - hans/hennes/deres (su libro)</li>
                                <li><strong>nuestro/nuestra</strong> - vår/vårt</li>
                            </ul>
                        </div>
                        
                        <div class="rule">
                            <strong>Flertall (flere ting):</strong>
                            <ul>
                                <li><strong>mis</strong> - mine (mis libros, mis casas)</li>
                                <li><strong>tus</strong> - dine (tus libros)</li>
                                <li><strong>sus</strong> - hans/hennes/deres (sus libros)</li>
                                <li><strong>nuestros/nuestras</strong> - våre</li>
                            </ul>
                        </div>
                        
                        <div class="example">
                            <span class="correct">Mi</span> hermano (min bror) → <span class="correct">Mis</span> hermanos (mine brødre)<br>
                            <span class="correct">Tu</span> casa (ditt hus) → <span class="correct">Tus</span> casas (dine hus)
                        </div>
                        
                        <div class="exception">
                            <strong>OBS!</strong> nuestro/nuestra bøyes etter kjønn:<br>
                            nuestro padre (vår far) / nuestra madre (vår mor)
                        </div>
                    `
                },
                exercises: [
                    { sentence: "___ hermano se llama Pedro", answer: "Mi", options: ["Mi", "Mis", "Tu", "Tus"], hint: "hermano er entall - min" },
                    { sentence: "___ padres están en casa", answer: "Mis", options: ["Mi", "Mis", "Tu", "Tus"], hint: "padres er flertall - mine" },
                    { sentence: "¿Dónde está ___ libro?", answer: "tu", options: ["mi", "tu", "su", "tus"], hint: "libro er entall - din" },
                    { sentence: "Ella vive con ___ familia", answer: "su", options: ["mi", "tu", "su", "sus"], hint: "familia er entall - hennes" },
                    { sentence: "___ abuelos son muy simpáticos", answer: "Mis", options: ["Mi", "Mis", "Su", "Sus"], hint: "abuelos er flertall - mine" },
                    { sentence: "¿Cómo se llaman ___ hermanas?", answer: "tus", options: ["tu", "tus", "su", "sus"], hint: "hermanas er flertall - dine" },
                    { sentence: "___ madre es profesora", answer: "Nuestra", options: ["Nuestro", "Nuestra", "Nuestros", "Nuestras"], hint: "madre er feminin - vår" },
                    { sentence: "___ padre trabaja en un banco", answer: "Nuestro", options: ["Nuestro", "Nuestra", "Nuestros", "Nuestras"], hint: "padre er maskulin - vår" },
                    { sentence: "Ellos quieren ___ dinero", answer: "su", options: ["mi", "tu", "su", "sus"], hint: "dinero er entall - deres" },
                    { sentence: "___ amigos vienen mañana", answer: "Sus", options: ["Su", "Sus", "Mi", "Mis"], hint: "amigos er flertall - hennes/hans" },
                    { sentence: "Me gusta ___ casa", answer: "tu", options: ["mi", "tu", "su", "tus"], hint: "casa er entall - din" },
                    { sentence: "___ hijos son muy inteligentes", answer: "Nuestros", options: ["Nuestro", "Nuestra", "Nuestros", "Nuestras"], hint: "hijos er maskulin flertall - våre" },
                    { sentence: "¿Dónde están ___ llaves?", answer: "mis", options: ["mi", "mis", "tu", "tus"], hint: "llaves er flertall - mine" },
                    { sentence: "___ profesora es muy buena", answer: "Nuestra", options: ["Nuestro", "Nuestra", "Nuestros", "Nuestras"], hint: "profesora er feminin - vår" },
                ]
            }
        };

        // Grammar state
        let grammarProgress = {};
        let currentGrammarTopic = null;
        let grammarExercises = [];
        let grammarCurrentIndex = 0;
        let grammarStats = { correct: 0, total: 0, errors: 0 };
        let hasSeenTheory = {};
        let showingTheory = false;

        function loadGrammarProgress() {
            const saved = localStorage.getItem('spansk123Grammar_v1');
            if (saved) {
                const data = JSON.parse(saved);
                grammarProgress = data.progress || {};
                hasSeenTheory = data.hasSeenTheory || {};
            }
        }

        function saveGrammarProgress() {
            localStorage.setItem('spansk123Grammar_v1', JSON.stringify({
                progress: grammarProgress,
                hasSeenTheory: hasSeenTheory
            }));
        }

        function renderGrammarTopics() {
            loadGrammarProgress();
            const grid = document.getElementById('grammarTopicGrid');
            
            grid.innerHTML = Object.values(grammarTopics).map(topic => {
                const progress = grammarProgress[topic.id] || { correct: 0, total: 0 };
                const percentage = progress.total > 0 ? Math.round((progress.correct / progress.total) * 100) : 0;
                const mastered = percentage >= 80 && progress.total >= 10;
                
                return `
                    <div class="grammar-topic-card" onclick="startGrammarTopic('${topic.id}')">
                        ${mastered ? '<span class="grammar-mastery-badge">⭐</span>' : ''}
                        <div class="grammar-topic-icon">${topic.icon}</div>
                        <div class="grammar-topic-name">${topic.name}</div>
                        <div class="grammar-topic-desc">${topic.description}</div>
                        <div class="grammar-topic-progress">
                            <div class="grammar-topic-progress-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="grammar-topic-stats">
                            ${progress.total > 0 ? `${percentage}% riktig (${progress.total} øvelser)` : 'Ikke startet'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function startGrammarTopic(topicId) {
            loadGrammarProgress();
            currentGrammarTopic = grammarTopics[topicId];
            
            // Check if should show theory
            const progress = grammarProgress[topicId] || { correct: 0, total: 0, recentErrors: 0 };
            const shouldShowTheory = !hasSeenTheory[topicId] || progress.recentErrors >= 3;
            
            if (shouldShowTheory) {
                showGrammarTheory();
            } else {
                startGrammarExercises();
            }
        }

        function showGrammarTheory() {
            showingTheory = true;
            document.getElementById('grammarSettings').classList.add('hidden');
            document.getElementById('grammarExercise').classList.remove('hidden');
            
            const topic = currentGrammarTopic;
            
            document.getElementById('grammarTheoryArea').innerHTML = `
                <div class="theory-card">
                    <h3>📚 ${topic.theory.title}</h3>
                    ${topic.theory.content}
                </div>
            `;
            
            document.getElementById('grammarExerciseArea').innerHTML = `
                <div class="button-group">
                    <button class="btn btn-primary" onclick="startGrammarExercises()">▶️ Start øvelser</button>
                </div>
            `;
            
            // Update progress bar
            document.getElementById('grammarProgressFill').style.width = '0%';
            document.getElementById('grammarSessionStats').textContent = 'Teori';
            document.getElementById('grammarCounter').textContent = '';
            
            hasSeenTheory[currentGrammarTopic.id] = true;
            saveGrammarProgress();
        }

        function startGrammarExercises() {
            showingTheory = false;
            document.getElementById('grammarSettings').classList.add('hidden');
            document.getElementById('grammarExercise').classList.remove('hidden');
            document.getElementById('grammarTheoryArea').innerHTML = '';
            
            // Shuffle and pick exercises
            grammarExercises = shuffleArray([...currentGrammarTopic.exercises]).slice(0, 10);
            grammarCurrentIndex = 0;
            grammarStats = { correct: 0, total: grammarExercises.length, errors: 0 };
            
            // Reset recent errors for this topic
            if (!grammarProgress[currentGrammarTopic.id]) {
                grammarProgress[currentGrammarTopic.id] = { correct: 0, total: 0, recentErrors: 0 };
            }
            grammarProgress[currentGrammarTopic.id].recentErrors = 0;
            saveGrammarProgress();
            
            showGrammarExercise();
        }

        function showGrammarExercise() {
            if (grammarCurrentIndex >= grammarExercises.length) {
                endGrammarSession();
                return;
            }
            
            const exercise = grammarExercises[grammarCurrentIndex];
            updateGrammarProgress();
            
            // Create sentence with blank
            const sentenceHTML = exercise.sentence.replace('___', '<span class="blank">______</span>');
            
            // Shuffle options
            const shuffledOptions = shuffleArray([...exercise.options]);
            
            document.getElementById('grammarExerciseArea').innerHTML = `
                <div class="grammar-exercise">
                    <div class="grammar-sentence">${sentenceHTML}</div>
                    
                    <div class="grammar-options">
                        ${shuffledOptions.map(opt => `
                            <button class="grammar-option" onclick="selectGrammarAnswer('${opt}', this)">
                                ${opt}
                            </button>
                        `).join('')}
                    </div>
                    
                    <button class="grammar-hint-btn" onclick="showGrammarHint()">💡 Vis hint</button>
                    
                    <div class="grammar-feedback" id="grammarFeedback"></div>
                </div>
            `;
        }

        function selectGrammarAnswer(answer, buttonElement) {
            const exercise = grammarExercises[grammarCurrentIndex];
            const isCorrect = answer.toLowerCase() === exercise.answer.toLowerCase();
            
            // Disable all buttons
            document.querySelectorAll('.grammar-option').forEach(btn => {
                btn.classList.add('disabled');
                if (btn.textContent.trim().toLowerCase() === exercise.answer.toLowerCase()) {
                    btn.classList.add('correct');
                }
            });
            
            if (isCorrect) {
                buttonElement.classList.add('correct');
                grammarStats.correct++;
                
                document.getElementById('grammarFeedback').innerHTML = `
                    <div class="grammar-feedback correct">
                        ✓ Riktig!
                    </div>
                `;
            } else {
                buttonElement.classList.add('incorrect');
                grammarStats.errors++;
                grammarProgress[currentGrammarTopic.id].recentErrors++;
                
                document.getElementById('grammarFeedback').innerHTML = `
                    <div class="grammar-feedback incorrect">
                        ✗ Feil! Riktig svar er: <strong>${exercise.answer}</strong>
                        <div class="explanation">${exercise.hint}</div>
                    </div>
                `;
            }
            
            // Update overall progress
            grammarProgress[currentGrammarTopic.id].total++;
            if (isCorrect) grammarProgress[currentGrammarTopic.id].correct++;
            saveGrammarProgress();
            
            // Move to next after delay
            setTimeout(() => {
                grammarCurrentIndex++;
                showGrammarExercise();
            }, isCorrect ? 1000 : 2500);
        }

        function showGrammarHint() {
            const exercise = grammarExercises[grammarCurrentIndex];
            document.getElementById('grammarFeedback').innerHTML = `
                <div class="grammar-feedback" style="background: #fef3c7; color: #92400e;">
                    💡 ${exercise.hint}
                </div>
            `;
        }

        function updateGrammarProgress() {
            const progress = (grammarCurrentIndex / grammarExercises.length) * 100;
            document.getElementById('grammarProgressFill').style.width = progress + '%';
            document.getElementById('grammarSessionStats').textContent = `${grammarStats.correct} / ${grammarCurrentIndex} riktig`;
            document.getElementById('grammarCounter').textContent = `${grammarCurrentIndex + 1} / ${grammarExercises.length}`;
        }

        function endGrammarSessionEarly() {
            if (confirm('Er du sikker på at du vil avslutte økten?')) endGrammarSession();
        }

        function endGrammarSession() {
            const accuracy = grammarStats.total > 0 ? Math.round((grammarStats.correct / grammarStats.total) * 100) : 0;
            const needsMorePractice = accuracy < 70 || grammarStats.errors >= 3;
            
            document.getElementById('grammarExerciseArea').innerHTML = `
                <div class="session-complete">
                    <div class="emoji">${accuracy >= 80 ? '🎉' : accuracy >= 60 ? '👍' : '💪'}</div>
                    <h2>${currentGrammarTopic.name} fullført!</h2>
                    <div class="session-stats-grid">
                        <div class="session-stat">
                            <div class="session-stat-value">${grammarStats.correct}</div>
                            <div class="session-stat-label">Riktige</div>
                        </div>
                        <div class="session-stat">
                            <div class="session-stat-value">${grammarStats.total}</div>
                            <div class="session-stat-label">Totalt</div>
                        </div>
                        <div class="session-stat">
                            <div class="session-stat-value">${accuracy}%</div>
                            <div class="session-stat-label">Nøyaktighet</div>
                        </div>
                    </div>
                    ${needsMorePractice ? `
                        <p style="color: var(--warning); margin-bottom: 20px;">
                            💡 Tips: Se gjennom teorien og prøv igjen!
                        </p>
                    ` : `
                        <p style="color: var(--success); margin-bottom: 20px;">
                            ⭐ Flott jobbet! Du mestrer dette temaet!
                        </p>
                    `}
                </div>
                <div class="button-group">
                    ${needsMorePractice ? `
                        <button class="btn btn-warning" onclick="showGrammarTheory()">📚 Se teori igjen</button>
                    ` : ''}
                    <button class="btn btn-primary" onclick="startGrammarExercises()">🔄 Øv mer</button>
                    <button class="btn btn-secondary" onclick="showPage('grammar')">← Velg tema</button>
                </div>
            `;
        }

        function returnToGrammarTopics() {
            document.getElementById('grammarSettings').classList.remove('hidden');
            document.getElementById('grammarExercise').classList.add('hidden');
            renderGrammarTopics();
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // ============================================
        // VERBO INVADERS GAME
        // ============================================

        // Game state
        let viScore = 0;
        let viLives = 3;
        let viLevel = 1;
        let viCombo = 0;
        let viMaxCombo = 0;
        let viTotalCorrect = 0;
        let viTotalAnswered = 0;
        let viCurrentQuestion = null;
        let viCorrectIndex = -1;
        let viGameActive = false;
        let viAnswering = false;
        let viSelectedVerbs = new Set();
        let viSelectedTenses = new Set(['presente']);
        let viQuestionPool = [];

        // Falling animation state
        let viFallAnimId = null;
        let viFallStartTime = 0;
        let viFallDuration = 8000;
        let viStartY = -150;
        let viEndY = 0;

        const viPronouns = {
            yo: "Jeg",
            tú: "Du",
            "él/ella": "Han/hun",
            nosotros: "Vi",
            vosotros: "Dere",
            ellos: "De"
        };

        const viPronounKeys = ["yo", "tú", "él/ella", "nosotros", "vosotros", "ellos"];

        function showGamesMenu() {
            document.getElementById('gamesMenu').classList.remove('hidden');
            document.getElementById('verboInvadersSetup').classList.add('hidden');
            document.getElementById('verboInvadersGame').classList.add('hidden');
            document.getElementById('verboInvadersGameOver').classList.add('hidden');
        }

        function showGameSetup(game) {
            if (game === 'verbo-invaders') {
                document.getElementById('gamesMenu').classList.add('hidden');
                document.getElementById('verboInvadersSetup').classList.remove('hidden');
                document.getElementById('verboInvadersGame').classList.add('hidden');
                document.getElementById('verboInvadersGameOver').classList.add('hidden');
                renderGameVerbSelector();
            }
        }

        function renderGameVerbSelector() {
            const grid = document.getElementById('gameVerbGrid');
            grid.innerHTML = '';
            
            // Select all verbs by default if none selected
            if (viSelectedVerbs.size === 0) {
                Object.keys(verbDatabase).forEach(v => viSelectedVerbs.add(v));
            }
            
            Object.entries(verbDatabase).forEach(([key, verb]) => {
                const isSelected = viSelectedVerbs.has(key);
                const chip = document.createElement('label');
                chip.className = `game-verb-chip ${isSelected ? 'selected' : ''}`;
                chip.innerHTML = `
                    <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleGameVerb('${key}', this)">
                    <span>${verb.infinitive}</span>
                `;
                grid.appendChild(chip);
            });
        }

        function toggleGameVerb(verb, checkbox) {
            if (checkbox.checked) {
                viSelectedVerbs.add(verb);
            } else {
                viSelectedVerbs.delete(verb);
            }
            checkbox.closest('.game-verb-chip').classList.toggle('selected', checkbox.checked);
        }

        function selectAllGameVerbs() {
            Object.keys(verbDatabase).forEach(v => viSelectedVerbs.add(v));
            renderGameVerbSelector();
        }

        function deselectAllGameVerbs() {
            viSelectedVerbs.clear();
            document.querySelectorAll('.game-verb-chip').forEach(chip => {
                chip.classList.remove('selected');
                chip.querySelector('input').checked = false;
            });
        }

        function generateViQuestionPool() {
            viQuestionPool = [];
            
            // Get selected tenses
            viSelectedTenses.clear();
            if (document.getElementById('tensePresente').checked) viSelectedTenses.add('presente');
            if (document.getElementById('tenseFuturo').checked) viSelectedTenses.add('futuro');
            if (document.getElementById('tensePerfecto').checked) viSelectedTenses.add('perfecto');
            
            if (viSelectedTenses.size === 0) viSelectedTenses.add('presente');
            if (viSelectedVerbs.size === 0) {
                Object.keys(verbDatabase).forEach(v => viSelectedVerbs.add(v));
            }
            
            viSelectedVerbs.forEach(verbKey => {
                const verb = verbDatabase[verbKey];
                if (!verb) return;
                
                viSelectedTenses.forEach(tense => {
                    viPronounKeys.forEach((pronoun, idx) => {
                        let correct, norwegian, verbDisplay;
                        
                        if (tense === 'presente') {
                            correct = verb.presente[idx];
                            norwegian = `${viPronouns[pronoun]} ${getVerbMeaning(verb.translation, pronoun)}`;
                            verbDisplay = `${verb.infinitive} (${verb.translation}) - presens`;
                        } else if (tense === 'futuro') {
                            const irForms = ["voy a", "vas a", "va a", "vamos a", "vais a", "van a"];
                            correct = `${irForms[idx]} ${verb.infinitive}`;
                            const futuroVerb = getNorwegianInfinitive(verb.translation);
                            norwegian = `${viPronouns[pronoun]} skal ${futuroVerb}`;
                            verbDisplay = `${verb.infinitive} (${verb.translation}) - futuro`;
                        } else if (tense === 'perfecto') {
                            const haberForms = ["he", "has", "ha", "hemos", "habéis", "han"];
                            correct = `${haberForms[idx]} ${verb.participio}`;
                            const perfectoVerb = getNorwegianPerfectum(verb.translation);
                            norwegian = `${viPronouns[pronoun]} har ${perfectoVerb}`;
                            verbDisplay = `${verb.infinitive} (${verb.translation}) - perfecto`;
                        }
                        
                        // Generate wrong answers from other forms
                        const wrongs = generateWrongAnswers(verb, tense, idx);
                        
                        viQuestionPool.push({
                            verb: verb.infinitive,
                            verbDisplay: verbDisplay,
                            norwegian: norwegian,
                            correct: correct,
                            wrongs: wrongs
                        });
                    });
                });
            });
            
            // Shuffle the pool
            viQuestionPool = shuffleArray(viQuestionPool);
        }

        function getVerbMeaning(translation, pronoun) {
            // Convert Norwegian infinitive to present tense
            const base = translation.replace('å ', '');
            
            // Irregular Norwegian verbs mapping
            const irregularNorwegian = {
                'si': 'sier',
                'være': 'er',
                'være (permanent)': 'er',
                'være/befinne seg': 'er',
                'ha': 'har',
                'kunne': 'kan',
                'ville': 'vil',
                'vite': 'vet',
                'gjøre': 'gjør',
                'gå': 'går',
                'gå/dra': 'går',
                'gå ut': 'går ut',
                'se': 'ser',
                'komme': 'kommer',
                'foretrekke': 'foretrekker',
                'snakke': 'snakker',
                'jobbe': 'jobber',
                'studere': 'studerer',
                'danse': 'danser',
                'kjøpe': 'kjøper',
                'høre': 'hører',
                'synge': 'synger',
                'spise': 'spiser',
                'drikke': 'drikker',
                'lese': 'leser',
                'lære': 'lærer',
                'bo': 'bor',
                'skrive': 'skriver'
            };
            
            // Check if it's an irregular verb
            if (irregularNorwegian[base]) {
                return irregularNorwegian[base];
            }
            
            // Regular verbs: add 'r' or 'er' depending on ending
            if (base.endsWith('e')) {
                return base + 'r';
            } else {
                return base + 'er';
            }
        }

        function getNorwegianInfinitive(translation) {
            // Clean up translation for futuro (skal + infinitiv)
            let base = translation.replace('å ', '');
            
            // Handle compound translations
            const cleanups = {
                'være (permanent)': 'være',
                'være/befinne seg': 'være',
                'gå/dra': 'dra',
                'gå ut': 'gå ut'
            };
            
            return cleanups[base] || base;
        }

        function getNorwegianPerfectum(translation) {
            // Convert Norwegian infinitive to past participle (har + partisipp)
            const base = translation.replace('å ', '');
            
            // Irregular Norwegian past participles
            const irregularPerfectum = {
                'si': 'sagt',
                'være': 'vært',
                'være (permanent)': 'vært',
                'være/befinne seg': 'vært',
                'ha': 'hatt',
                'kunne': 'kunnet',
                'ville': 'villet',
                'vite': 'visst',
                'gjøre': 'gjort',
                'gå': 'gått',
                'gå/dra': 'dratt',
                'gå ut': 'gått ut',
                'se': 'sett',
                'komme': 'kommet',
                'foretrekke': 'foretrukket',
                'skrive': 'skrevet',
                'drikke': 'drukket',
                'synge': 'sunget',
                'lese': 'lest'
            };
            
            if (irregularPerfectum[base]) {
                return irregularPerfectum[base];
            }
            
            // Regular verbs ending in -e: replace -e with -et
            if (base.endsWith('e')) {
                return base.slice(0, -1) + 'et';
            }
            
            // Other regular verbs: add -d or -t
            if (base.endsWith('r')) {
                return base + 'd';
            }
            
            return base + 't';
        }

        function generateWrongAnswers(verb, tense, correctIdx) {
            const wrongs = [];
            
            if (tense === 'presente') {
                // Use other conjugations of same verb
                verb.presente.forEach((form, idx) => {
                    if (idx !== correctIdx) wrongs.push(form);
                });
            } else if (tense === 'futuro') {
                const irForms = ["voy a", "vas a", "va a", "vamos a", "vais a", "van a"];
                irForms.forEach((form, idx) => {
                    if (idx !== correctIdx) wrongs.push(`${form} ${verb.infinitive}`);
                });
            } else if (tense === 'perfecto') {
                const haberForms = ["he", "has", "ha", "hemos", "habéis", "han"];
                haberForms.forEach((form, idx) => {
                    if (idx !== correctIdx) wrongs.push(`${form} ${verb.participio}`);
                });
            }
            
            return shuffleArray(wrongs).slice(0, 4);
        }

        function startVerboInvaders() {
            generateViQuestionPool();
            
            if (viQuestionPool.length === 0) {
                alert('Velg minst ett verb og én verbtid!');
                return;
            }
            
            viScore = 0;
            viLives = 3;
            viLevel = 1;
            viCombo = 0;
            viMaxCombo = 0;
            viTotalCorrect = 0;
            viTotalAnswered = 0;
            viGameActive = true;
            viAnswering = false;
            
            document.getElementById('verboInvadersSetup').classList.add('hidden');
            document.getElementById('verboInvadersGame').classList.remove('hidden');
            document.getElementById('verboInvadersGameOver').classList.add('hidden');
            
            viUpdateHUD();
            viUpdateCombo();
            
            const invaderZone = document.getElementById('viInvaderZone');
            invaderZone.style.transition = 'none';
            invaderZone.style.opacity = '1';
            invaderZone.style.top = '-150px';
            
            document.getElementById('viPlayerShip').style.left = 'calc(50% - 18px)';
            
            viPickQuestion();
            setTimeout(() => viStartFalling(), 500);
        }

        function viPickQuestion() {
            if (viQuestionPool.length === 0) {
                generateViQuestionPool();
            }
            
            const q = viQuestionPool[Math.floor(Math.random() * viQuestionPool.length)];
            viCurrentQuestion = q;
            
            const wrongOptions = shuffleArray(q.wrongs).slice(0, 2);
            const options = shuffleArray([q.correct, ...wrongOptions]);
            viCorrectIndex = options.indexOf(q.correct);
            
            document.getElementById('viPromptText').textContent = q.norwegian;
            document.getElementById('viPromptVerb').textContent = q.verbDisplay;
            
            for (let i = 0; i < 3; i++) {
                document.getElementById(`viAns${i}`).textContent = options[i];
                document.getElementById(`viCard${i}`).className = 'vi-answer-card';
            }
        }

        function viGetFallDuration(level) {
            return Math.max(2500, 8000 - (level - 1) * 500);
        }

        function viGetEndY() {
            return window.innerHeight - 148 - 130;
        }

        function viStartFalling() {
            viFallDuration = viGetFallDuration(viLevel);
            viEndY = viGetEndY();
            viStartY = -150;
            
            const invaderZone = document.getElementById('viInvaderZone');
            invaderZone.style.top = viStartY + 'px';
            document.getElementById('viWarningGlow').style.opacity = '0';
            
            viFallStartTime = performance.now();
            if (viFallAnimId) cancelAnimationFrame(viFallAnimId);
            viFallAnimId = requestAnimationFrame(viFallStep);
        }

        function viFallStep(timestamp) {
            if (!viGameActive || viAnswering) return;
            
            const elapsed = timestamp - viFallStartTime;
            const progress = Math.min(1, elapsed / viFallDuration);
            const eased = progress * progress;
            const currentY = viStartY + (viEndY - viStartY) * eased;
            
            const invaderZone = document.getElementById('viInvaderZone');
            invaderZone.style.top = currentY + 'px';
            
            // Warning glow
            if (progress > 0.5) {
                const glowIntensity = (progress - 0.5) * 2;
                document.getElementById('viWarningGlow').style.opacity = glowIntensity * 0.6;
                
                if (progress > 0.8) {
                    const pulse = Math.sin(elapsed * 0.01) * 0.5 + 0.5;
                    const promptBox = invaderZone.querySelector('.vi-prompt-box');
                    promptBox.style.borderColor = `rgba(255, 46, 99, ${0.3 + pulse * 0.7})`;
                    promptBox.style.boxShadow = `0 0 ${20 + pulse * 20}px rgba(255, 46, 99, ${0.2 + pulse * 0.3})`;
                }
            }
            
            if (progress >= 1) {
                viHandleTimeout();
                return;
            }
            
            viFallAnimId = requestAnimationFrame(viFallStep);
        }

        function viStopFalling() {
            if (viFallAnimId) {
                cancelAnimationFrame(viFallAnimId);
                viFallAnimId = null;
            }
        }

        function viHandleTimeout() {
            if (!viGameActive || viAnswering) return;
            viAnswering = true;
            viStopFalling();
            viCombo = 0;
            viUpdateCombo();
            viLives--;
            viUpdateHUD();
            
            document.getElementById(`viCard${viCorrectIndex}`).classList.add('correct');
            document.getElementById('viInvaderZone').querySelector('.vi-invader-sprite').style.filter = 
                'drop-shadow(0 0 30px #ff2e63)';
            document.getElementById('viWarningGlow').style.opacity = '0';
            
            if (viLives <= 0) {
                setTimeout(viGameOver, 800);
            } else {
                setTimeout(viNextRound, 1000);
            }
        }

        function viSelectAnswer(idx) {
            if (!viGameActive || viAnswering) return;
            viAnswering = true;
            viStopFalling();
            
            const card = document.getElementById(`viCard${idx}`);
            viTotalAnswered++;
            
            const cardRect = card.getBoundingClientRect();
            const ship = document.getElementById('viPlayerShip');
            ship.style.left = (cardRect.left + cardRect.width / 2 - 18) + 'px';
            
            document.getElementById('viWarningGlow').style.opacity = '0';
            
            if (idx === viCorrectIndex) {
                card.classList.add('correct');
                viCombo++;
                viTotalCorrect++;
                if (viCombo > viMaxCombo) viMaxCombo = viCombo;
                const points = 100 * viLevel + (viCombo > 1 ? viCombo * 20 : 0);
                viScore += points;
                viUpdateCombo();
                
                const invaderZone = document.getElementById('viInvaderZone');
                const invRect = invaderZone.getBoundingClientRect();
                viCreateExplosion(invRect.left + invRect.width / 2, invRect.top + 30, '#39ff14');
                
                invaderZone.style.transition = 'top 0.3s ease-out, opacity 0.3s';
                invaderZone.style.top = (parseInt(invaderZone.style.top) - 80) + 'px';
                invaderZone.style.opacity = '0';
                
                if (viTotalCorrect % 5 === 0) {
                    viLevel++;
                    viShowLevelUp();
                }
            } else {
                card.classList.add('wrong');
                document.getElementById(`viCard${viCorrectIndex}`).classList.add('correct');
                viCombo = 0;
                viUpdateCombo();
                viLives--;
                viCreateExplosion(cardRect.left + cardRect.width / 2, cardRect.top, '#ff2e63');
            }
            
            viUpdateHUD();
            
            if (viLives <= 0) {
                setTimeout(viGameOver, 800);
            } else {
                setTimeout(viNextRound, 1000);
            }
        }

        function viNextRound() {
            viAnswering = false;
            
            const invaderZone = document.getElementById('viInvaderZone');
            invaderZone.style.transition = 'none';
            invaderZone.style.opacity = '1';
            invaderZone.style.top = viStartY + 'px';
            invaderZone.querySelector('.vi-invader-sprite').style.filter = 'drop-shadow(0 0 20px #39ff14)';
            invaderZone.querySelector('.vi-prompt-box').style.borderColor = 'rgba(57, 255, 20, 0.3)';
            invaderZone.querySelector('.vi-prompt-box').style.boxShadow = '0 0 30px rgba(57, 255, 20, 0.1)';
            
            viPickQuestion();
            setTimeout(() => {
                if (viGameActive && !viAnswering) viStartFalling();
            }, 300);
        }

        function viUpdateHUD() {
            document.getElementById('viScore').textContent = viScore;
            document.getElementById('viLevel').textContent = viLevel;
            const hearts = '❤️'.repeat(Math.max(0, viLives)) + '🖤'.repeat(Math.max(0, 3 - viLives));
            document.getElementById('viLives').textContent = hearts;
        }

        function viUpdateCombo() {
            const el = document.getElementById('viCombo');
            const num = document.getElementById('viComboNum');
            if (viCombo >= 2) {
                el.classList.add('visible');
                num.textContent = viCombo + 'x';
            } else {
                el.classList.remove('visible');
            }
        }

        function viCreateExplosion(x, y, color) {
            const container = document.createElement('div');
            container.className = 'vi-explosion';
            container.style.left = x + 'px';
            container.style.top = y + 'px';
            
            for (let i = 0; i < 12; i++) {
                const p = document.createElement('div');
                p.className = 'vi-explosion-particle';
                const angle = (Math.PI * 2 * i) / 12;
                const dist = 30 + Math.random() * 40;
                p.style.setProperty('--dx', Math.cos(angle) * dist + 'px');
                p.style.setProperty('--dy', Math.sin(angle) * dist + 'px');
                p.style.background = color;
                p.style.boxShadow = `0 0 6px ${color}`;
                container.appendChild(p);
            }
            
            document.body.appendChild(container);
            setTimeout(() => container.remove(), 700);
        }

        function viShowLevelUp() {
            const flash = document.createElement('div');
            flash.className = 'vi-level-up-flash';
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 900);
            
            const text = document.createElement('div');
            text.className = 'vi-level-up-text';
            text.textContent = `NIVÅ ${viLevel}!`;
            document.body.appendChild(text);
            setTimeout(() => text.remove(), 1300);
        }

        function viGameOver() {
            viGameActive = false;
            viStopFalling();
            document.getElementById('viWarningGlow').style.opacity = '0';
            
            const pct = viTotalAnswered > 0 ? Math.round((viTotalCorrect / viTotalAnswered) * 100) : 0;
            
            document.getElementById('verboInvadersGame').classList.add('hidden');
            document.getElementById('verboInvadersGameOver').classList.remove('hidden');
            
            document.getElementById('viFinalScore').textContent = `${viScore} POENG`;
            document.getElementById('viFinalStats').innerHTML = 
                `${viTotalCorrect} av ${viTotalAnswered} riktige (${pct}%)<br>Maks combo: ${viMaxCombo}x · Nivå: ${viLevel}`;
        }

        function quitVerboInvaders() {
            if (confirm('Er du sikker på at du vil avslutte spillet?')) {
                viGameActive = false;
                viStopFalling();
                showGamesMenu();
            }
        }

        // Keyboard controls for Verbo Invaders
        document.addEventListener('keydown', (e) => {
            if (!viGameActive) return;
            
            if (e.key === '1') viSelectAnswer(0);
            else if (e.key === '2') viSelectAnswer(1);
            else if (e.key === '3') viSelectAnswer(2);
        });

        // Handle window resize for game
        window.addEventListener('resize', () => {
            if (viGameActive) {
                viEndY = viGetEndY();
            }
        });

        // Initialize app
        (function() {
            const savedName = localStorage.getItem('spansk123_studentName');
            
            if (savedName) {
                // User has been here before - auto-login
                studentName = savedName;
                document.getElementById('studentNameInput').value = savedName;
                showMainApp();
            }
        })();
    </script>
</body>
</html>
